
<!DOCTYPE HTML>
<html lang="zh-hans" >
    <head>
        <meta charset="UTF-8">
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <title>2 Spring Ioc容器加载过程—Bean的生命周期源码深度剖析 · 架构师学习笔记</title>
        <meta http-equiv="X-UA-Compatible" content="IE=edge" />
        <meta name="description" content="">
        <meta name="generator" content="GitBook 3.2.3">
        <meta name="author" content="Tyrival">
        
        
    
    <link rel="stylesheet" href="../gitbook/style.css">

    
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-splitter/splitter.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchors/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-anchor-navigation-ex/style/plugin.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-highlight/website.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-search/search.css">
                
            
                
                <link rel="stylesheet" href="../gitbook/gitbook-plugin-fontsettings/website.css">
                
            
        

    

    
        
        <link rel="stylesheet" href="../styles/website.css">
        
    

        
    
    
    
    <meta name="HandheldFriendly" content="true"/>
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <link rel="apple-touch-icon-precomposed" sizes="152x152" href="../gitbook/images/apple-touch-icon-precomposed-152.png">
    <link rel="shortcut icon" href="../gitbook/images/favicon.ico" type="image/x-icon">

    
    <link rel="next" href="03-Spring-Resolve-Circular-Dependencies.html" />
    
    
    <link rel="prev" href="01-Spring-Code-Compile.html" />
    

    <style>
    @media only screen and (max-width: 640px) {
        .book-header .hidden-mobile {
            display: none;
        }
    }
    </style>
    <script>
        window["gitbook-plugin-github-buttons"] = {"buttons":[{"user":"Tyrival","repo":"gitbook","type":"star","size":"small","count":false}]};
    </script>

    </head>
    <body>
        
<div class="book">
    <div class="book-summary">
        
            
<div id="book-search-input" role="search">
    <input type="text" placeholder="输入并搜索" />
</div>

            
                <nav role="navigation">
                


<ul class="summary">
    
    

    

    
        
        
    
        <li class="chapter " data-level="1.1" data-path="../">
            
                <a href="../">
            
                    
                    架构师学习笔记
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1" data-path="../01-JVM/">
            
                <a href="../01-JVM/">
            
                    
                    第1章 JVM
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.1.1" data-path="../01-JVM/01-ClassLoader.html">
            
                <a href="../01-JVM/01-ClassLoader.html">
            
                    
                    1 类加载机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.2" data-path="../01-JVM/02-JVM-Structure-Resolve.html">
            
                <a href="../01-JVM/02-JVM-Structure-Resolve.html">
            
                    
                    2 JVM整体结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.3" data-path="../01-JVM/03-Memory-Allocation-Mechanism.html">
            
                <a href="../01-JVM/03-Memory-Allocation-Mechanism.html">
            
                    
                    3 JVM内存分配机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.4" data-path="../01-JVM/04-JVM-Bytecode-File-Structure.html">
            
                <a href="../01-JVM/04-JVM-Bytecode-File-Structure.html">
            
                    
                    4 JVM字节码文件结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.5" data-path="../01-JVM/05-GC-ParNew-CMS.html">
            
                <a href="../01-JVM/05-GC-ParNew-CMS.html">
            
                    
                    5 垃圾收集器ParNew和CMS
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.6" data-path="../01-JVM/06-GC-G1-ZGC.html">
            
                <a href="../01-JVM/06-GC-G1-ZGC.html">
            
                    
                    6 垃圾收集器G1和ZGC
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.7" data-path="../01-JVM/07-GC-Optimize-01.html">
            
                <a href="../01-JVM/07-GC-Optimize-01.html">
            
                    
                    7 GC调优（一）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.8" data-path="../01-JVM/08-GC-Optimize-02.html">
            
                <a href="../01-JVM/08-GC-Optimize-02.html">
            
                    
                    8 GC调优（二）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.1.9" data-path="../01-JVM/JVM-Command.html">
            
                <a href="../01-JVM/JVM-Command.html">
            
                    
                    附1 JVM指令手册
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.2" data-path="../02-Tomcat/">
            
                <a href="../02-Tomcat/">
            
                    
                    第2章 Tomcat
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.2.1" data-path="../02-Tomcat/01-Tomcat-Summary.html">
            
                <a href="../02-Tomcat/01-Tomcat-Summary.html">
            
                    
                    1 Tomcat生产环境应用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2.2" data-path="../02-Tomcat/02-Tomcat-Component-Src.html">
            
                <a href="../02-Tomcat/02-Tomcat-Component-Src.html">
            
                    
                    2 Tomcat核心组件源码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2.3" data-path="../02-Tomcat/03-Tomcat-Http-Process.html">
            
                <a href="../02-Tomcat/03-Tomcat-Http-Process.html">
            
                    
                    3 Tomcat线程模型HTTP请求处理与管道线模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.2.4" data-path="../02-Tomcat/04-Tomcat-Hot-Deployment-Load.html">
            
                <a href="../02-Tomcat/04-Tomcat-Hot-Deployment-Load.html">
            
                    
                    4 Tomcat热部署和热加载
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.3" data-path="../03-MySQL/">
            
                <a href="../03-MySQL/">
            
                    
                    第3章 MySQL
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.3.1" data-path="../03-MySQL/01-Mysql-index-data-structure.html">
            
                <a href="../03-MySQL/01-Mysql-index-data-structure.html">
            
                    
                    1 Mysql索引数据结构
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3.2" data-path="../03-MySQL/02-Explain-Index-Actual.html">
            
                <a href="../03-MySQL/02-Explain-Index-Actual.html">
            
                    
                    2 Explain详解与索引最佳实践
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3.3" data-path="../03-MySQL/03-Sql-Execution-Fundamental.html">
            
                <a href="../03-MySQL/03-Sql-Execution-Fundamental.html">
            
                    
                    3 SQL底层执行原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3.4" data-path="../03-MySQL/04-Sql-Optimize-01.html">
            
                <a href="../03-MySQL/04-Sql-Optimize-01.html">
            
                    
                    4 SQL优化实战（一）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3.5" data-path="../03-MySQL/05-Sql-Optimize-02.html">
            
                <a href="../03-MySQL/05-Sql-Optimize-02.html">
            
                    
                    5 SQL优化实战（二）
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3.6" data-path="../03-MySQL/06-Mysql-Lock-Transaction-Isolation.html">
            
                <a href="../03-MySQL/06-Mysql-Lock-Transaction-Isolation.html">
            
                    
                    6 Mysql锁与事务隔离级别
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3.7" data-path="../03-MySQL/Slow-Sql-Query.html">
            
                <a href="../03-MySQL/Slow-Sql-Query.html">
            
                    
                    附1 慢SQL查询
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.3.8" data-path="../03-MySQL/Ali-Java-Explain.html">
            
                <a href="../03-MySQL/Ali-Java-Explain.html">
            
                    
                    附2 阿里巴巴手册（泰山版）解读-MySQL数据库
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.4" data-path="../04-Concurrent/">
            
                <a href="../04-Concurrent/">
            
                    
                    第4章 并发编程
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.4.1" data-path="../04-Concurrent/01-JMM-JSR133.html">
            
                <a href="../04-Concurrent/01-JMM-JSR133.html">
            
                    
                    1 并发编程之JMM & JSR133规范解读
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.2" data-path="../04-Concurrent/02-JMM-Features.html">
            
                <a href="../04-Concurrent/02-JMM-Features.html">
            
                    
                    2 并发编程之JMM三大特性详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.3" data-path="../04-Concurrent/03-MESI-Cache-Coherency-Protocol.html">
            
                <a href="../04-Concurrent/03-MESI-Cache-Coherency-Protocol.html">
            
                    
                    3 MESI缓存一致协议详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.4" data-path="../04-Concurrent/04-Synchronized.html">
            
                <a href="../04-Concurrent/04-Synchronized.html">
            
                    
                    4 并发编程之synchronized详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.5" data-path="../04-Concurrent/05-AQS-Lock.html">
            
                <a href="../04-Concurrent/05-AQS-Lock.html">
            
                    
                    5 抽象队列同步器AQS应用Lock详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.6" data-path="../04-Concurrent/06-AQS-Blocking-Queue.html">
            
                <a href="../04-Concurrent/06-AQS-Blocking-Queue.html">
            
                    
                    6 抽象队列同步器AQS应用之BlockingQueue详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.7" data-path="../04-Concurrent/07-Tools-CountDownLatch-Semaphore.html">
            
                <a href="../04-Concurrent/07-Tools-CountDownLatch-Semaphore.html">
            
                    
                    7 并发编程之Tools&CountDownLatch&Semaphore原理与应用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.8" data-path="../04-Concurrent/08-Atomic-Unsafe-Magic-Class.html">
            
                <a href="../04-Concurrent/08-Atomic-Unsafe-Magic-Class.html">
            
                    
                    8 并发编程之Atomic&Unsafe魔法类详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.9" data-path="../04-Concurrent/09-Collections-Map-List-Set.html">
            
                <a href="../04-Concurrent/09-Collections-Map-List-Set.html">
            
                    
                    9 Collections之Map&List&Set详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.10" data-path="../04-Concurrent/10-Executor-Thread-Pool.html">
            
                <a href="../04-Concurrent/10-Executor-Thread-Pool.html">
            
                    
                    10 Executor线程池原理与源码
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.11" data-path="../04-Concurrent/11-Schedule-Task-Thread-Pool.html">
            
                <a href="../04-Concurrent/11-Schedule-Task-Thread-Pool.html">
            
                    
                    11 并发编程之定时任务&定时线程池
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.12" data-path="../04-Concurrent/12-Future-ForkJoin.html">
            
                <a href="../04-Concurrent/12-Future-ForkJoin.html">
            
                    
                    12 并发编程之Future&ForkJoin框架原理分析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.4.13" data-path="../04-Concurrent/13-Disruptor.html">
            
                <a href="../04-Concurrent/13-Disruptor.html">
            
                    
                    13 无锁并发框架Disruptor
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.5" data-path="./">
            
                <a href="./">
            
                    
                    第5章 源码框架
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.5.1" data-path="01-Spring-Code-Compile.html">
            
                <a href="01-Spring-Code-Compile.html">
            
                    
                    1 Spring源码介绍和编译
            
                </a>
            

            
        </li>
    
        <li class="chapter active" data-level="1.1.5.2" data-path="02-Spring-IoC.html">
            
                <a href="02-Spring-IoC.html">
            
                    
                    2 Spring Ioc容器加载过程—Bean的生命周期源码深度剖析
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.3" data-path="03-Spring-Resolve-Circular-Dependencies.html">
            
                <a href="03-Spring-Resolve-Circular-Dependencies.html">
            
                    
                    3 Spring如何解决循环依赖
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.4" data-path="04-Spring-Event.html">
            
                <a href="04-Spring-Event.html">
            
                    
                    4 Spring事件监听机制
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.5.5" data-path="05-Spring-AOP.html">
            
                <a href="05-Spring-AOP.html">
            
                    
                    5 Spring AOP源码
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.6" data-path="../06-Distributed/">
            
                <a href="../06-Distributed/">
            
                    
                    第6章 分布式
            
                </a>
            

            
            <ul class="articles">
                
    
        <li class="chapter " data-level="1.1.6.1" data-path="../06-Distributed/Old/01-Zookeeper-Node.html">
            
                <a href="../06-Distributed/Old/01-Zookeeper-Node.html">
            
                    
                    1 Zookeeper特性与节点说明
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.2" data-path="../06-Distributed/Old/05-Redis-Data-Structure.html">
            
                <a href="../06-Distributed/Old/05-Redis-Data-Structure.html">
            
                    
                    5 Redis核心数据结构与核心原理
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.3" data-path="../06-Distributed/Old/06-Redis-Persistent-Distributed-Mode.html">
            
                <a href="../06-Distributed/Old/06-Redis-Persistent-Distributed-Mode.html">
            
                    
                    6 Redis持久化、主从与哨兵架构详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.4" data-path="../06-Distributed/Old/07-Redis-Cluster-Mode.html">
            
                <a href="../06-Distributed/Old/07-Redis-Cluster-Mode.html">
            
                    
                    7 Redis高可用集群
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.5" data-path="../06-Distributed/Old/08-Redis-Distributed-Lock-Training.html">
            
                <a href="../06-Distributed/Old/08-Redis-Distributed-Lock-Training.html">
            
                    
                    8 Redis高并发分布式锁实战
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.6" data-path="../06-Distributed/Old/09-Redis-Design-Optimize.html">
            
                <a href="../06-Distributed/Old/09-Redis-Design-Optimize.html">
            
                    
                    9 Redis缓存设计与性能优化
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.7" data-path="../06-Distributed/Old/10-Nginx-Core-Config.html">
            
                <a href="../06-Distributed/Old/10-Nginx-Core-Config.html">
            
                    
                    10 Nginx核心模块与配置实践
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.8" data-path="../06-Distributed/Old/11-Nginx-Optimize-Training.html">
            
                <a href="../06-Distributed/Old/11-Nginx-Optimize-Training.html">
            
                    
                    11 Nginx性能优化实践
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.9" data-path="../06-Distributed/Old/12-MongoDB-Quick-Start.html">
            
                <a href="../06-Distributed/Old/12-MongoDB-Quick-Start.html">
            
                    
                    12 MongoDB的逻辑组成
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.10" data-path="../06-Distributed/Old/13-MongoDB-Cluster-Advanced-Feature.html">
            
                <a href="../06-Distributed/Old/13-MongoDB-Cluster-Advanced-Feature.html">
            
                    
                    13 MongoDB集群架构与高级特性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.11" data-path="../06-Distributed/Old/14-MongoDB-Training.html">
            
                <a href="../06-Distributed/Old/14-MongoDB-Training.html">
            
                    
                    14 MongoDB企业应用实战
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.12" data-path="../06-Distributed/Old/15-Java-BIO-NIO-AIO.html">
            
                <a href="../06-Distributed/Old/15-Java-BIO-NIO-AIO.html">
            
                    
                    15 Java BIO & NIO & AIO
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.13" data-path="../06-Distributed/Old/16-Netty-Core-Thread-Model.html">
            
                <a href="../06-Distributed/Old/16-Netty-Core-Thread-Model.html">
            
                    
                    16 Netty核心功能与线程模型
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.14" data-path="../06-Distributed/Old/17-Netty-Codec-Pack-Unpack-Zero-Copy.html">
            
                <a href="../06-Distributed/Old/17-Netty-Codec-Pack-Unpack-Zero-Copy.html">
            
                    
                    17 Netty编解码，粘包拆包及零拷贝
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.15" data-path="../06-Distributed/Old/18-Netty-Thread-Model-Source.html">
            
                <a href="../06-Distributed/Old/18-Netty-Thread-Model-Source.html">
            
                    
                    18 Netty线程模型源码详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.16" data-path="../06-Distributed/Old/19-Netty-Barrage-Dubbo.html">
            
                <a href="../06-Distributed/Old/19-Netty-Barrage-Dubbo.html">
            
                    
                    19 Netty在弹幕系统与Dubbo框架中的应用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.17" data-path="../06-Distributed/Old/20-RabbitMQ-Start.html">
            
                <a href="../06-Distributed/Old/20-RabbitMQ-Start.html">
            
                    
                    20 RabbitMQ基本概念讲解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.18" data-path="../06-Distributed/Old/21-RabbitMQ-Cluster.html">
            
                <a href="../06-Distributed/Old/21-RabbitMQ-Cluster.html">
            
                    
                    21 RabbitMQ集群及高级特性
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.19" data-path="../06-Distributed/Old/22-RabbitMQ-Reliability-Message.html">
            
                <a href="../06-Distributed/Old/22-RabbitMQ-Reliability-Message.html">
            
                    
                    22 RabbitMQ如何作可靠性消息投递
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.20" data-path="../06-Distributed/Old/23-RocketMQ-Start.html">
            
                <a href="../06-Distributed/Old/23-RocketMQ-Start.html">
            
                    
                    23 RocketMQ整体部署与快速实战
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.21" data-path="../06-Distributed/Old/24-RocketMQ-Feature.html">
            
                <a href="../06-Distributed/Old/24-RocketMQ-Feature.html">
            
                    
                    24 RocketMQ特性详解&场景介绍
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.22" data-path="../06-Distributed/Old/25-Kafka-Cluster.html">
            
                <a href="../06-Distributed/Old/25-Kafka-Cluster.html">
            
                    
                    25 Kafka集群搭建与使用
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.23" data-path="../06-Distributed/Old/26-Kafka-Architecture.html">
            
                <a href="../06-Distributed/Old/26-Kafka-Architecture.html">
            
                    
                    26 Kafka设计原理详解
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.6.24" data-path="../06-Distributed/Old/27-Kafka-Optimizer-Training.html">
            
                <a href="../06-Distributed/Old/27-Kafka-Optimizer-Training.html">
            
                    
                    27 Kafka性能优化实战
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    
        <li class="chapter " data-level="1.1.7" data-path="../07-Microservice/">
            
                <a href="../07-Microservice/">
            
                    
                    第7章 微服务
            
                </a>
            

            
        </li>
    
        <li class="chapter " data-level="1.1.8" data-path="../08-Training/">
            
                <a href="../08-Training/">
            
                    
                    第8章 实战案例
            
                </a>
            

            
        </li>
    

            </ul>
            
        </li>
    

    

    <li class="divider"></li>

    <li>
        <a href="https://www.gitbook.com" target="blank" class="gitbook-link">
            本书使用 GitBook 发布
        </a>
    </li>
</ul>


                </nav>
            
        
    </div>

    <div class="book-body">
        
            <div class="body-inner">
                
                    

<div class="book-header" role="navigation">
    

    <!-- Title -->
    <h1>
        <i class="fa fa-circle-o-notch fa-spin"></i>
        <a href=".." >2 Spring Ioc容器加载过程—Bean的生命周期源码深度剖析</a>
    </h1>
</div>




                    <div class="page-wrapper" tabindex="-1" role="main">
                        <div class="page-inner">
                            
<div id="book-search-results">
    <div class="search-noresults">
    
                                <section class="normal markdown-section">
                                
                                <div id="anchor-navigation-ex-navbar"><i class="fa fa-navicon"></i><ul><li><span class="title-icon "></span><a href="#spring-ioc&#x5BB9;&#x5668;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x2014;bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x6E90;&#x7801;&#x6DF1;&#x5EA6;&#x5256;&#x6790;"><b></b>Spring Ioc&#x5BB9;&#x5668;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x2014;Bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x6E90;&#x7801;&#x6DF1;&#x5EA6;&#x5256;&#x6790;</a></li><ul><li><span class="title-icon "></span><a href="#1-spring-ioc&#x5BB9;&#x5668;&#x7684;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;"><b></b>1. Spring IoC&#x5BB9;&#x5668;&#x7684;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;</a></li><ul><li><span class="title-icon "></span><a href="#11-&#x5B9E;&#x4F8B;&#x5316;&#x5316;&#x5BB9;annotationconfigapplicationcontext"><b></b>1.1 &#x5B9E;&#x4F8B;&#x5316;&#x5316;&#x5BB9;AnnotationConfigApplicationContext</a></li><li><span class="title-icon "></span><a href="#12-&#x5B9E;&#x4F8B;&#x5316;&#x5DE5;&#x5382;-defaultlistablebeanfactory"><b></b>1.2 &#x5B9E;&#x4F8B;&#x5316;&#x5DE5;&#x5382; DefaultListableBeanFactory</a></li><li><span class="title-icon "></span><a href="#13-&#x5B9E;&#x4F8B;&#x5316;beandefinition&#x8BFB;&#x53D6;&#x5668;&#x2014;annotatedbeandefinitionreader"><b></b>1.3 &#x5B9E;&#x4F8B;&#x5316;BeanDefinition&#x8BFB;&#x53D6;&#x5668;&#x2014;AnnotatedBeanDefinitionReader</a></li><li><span class="title-icon "></span><a href="#14-&#x521B;&#x5EFA;beandefinition&#x626B;&#x63CF;&#x5668;&#x2014;classpathbeandefinitionscanner"><b></b>1.4 &#x521B;&#x5EFA;BeanDefinition&#x626B;&#x63CF;&#x5668;&#x2014;ClassPathBeanDefinitionScanner</a></li><li><span class="title-icon "></span><a href="#15-&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#x4E3A;beandefinition&#x2014;registerannotatedclasses"><b></b>1.5 &#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#x4E3A;BeanDefinition&#x2014;register(annotatedClasses)</a></li><li><span class="title-icon "></span><a href="#16-refresh"><b></b>1.6 refresh()</a></li></ul><li><span class="title-icon "></span><a href="#2-spring-bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;"><b></b>2. Spring Bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;</a></li></ul></ul></div><a href="#spring-ioc&#x5BB9;&#x5668;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x2014;bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x6E90;&#x7801;&#x6DF1;&#x5EA6;&#x5256;&#x6790;" id="anchorNavigationExGoTop"><i class="fa fa-arrow-up"></i></a><h1 id="spring-ioc&#x5BB9;&#x5668;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x2014;bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x6E90;&#x7801;&#x6DF1;&#x5EA6;&#x5256;&#x6790;"><a name="spring-ioc&#x5BB9;&#x5668;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x2014;bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x6E90;&#x7801;&#x6DF1;&#x5EA6;&#x5256;&#x6790;" class="anchor-navigation-ex-anchor" href="#spring-ioc&#x5BB9;&#x5668;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x2014;bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x6E90;&#x7801;&#x6DF1;&#x5EA6;&#x5256;&#x6790;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="spring-ioc&#x5BB9;&#x5668;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x2014;bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x6E90;&#x7801;&#x6DF1;&#x5EA6;&#x5256;&#x6790;" class="plugin-anchor" href="#spring-ioc&#x5BB9;&#x5668;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x2014;bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x6E90;&#x7801;&#x6DF1;&#x5EA6;&#x5256;&#x6790;"><i class="fa fa-link" aria-hidden="true"></i></a>Spring Ioc&#x5BB9;&#x5668;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x2014;Bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x6E90;&#x7801;&#x6DF1;&#x5EA6;&#x5256;&#x6790;</h1>
<p>Spring &#x6700;&#x91CD;&#x8981;&#x7684;&#x6982;&#x5FF5;&#x662F; IOC &#x548C; AOP&#xFF0C;&#x5176;&#x4E2D; IOC &#x53C8;&#x662F; Spring &#x4E2D;&#x7684;&#x6839;&#x57FA;&#xFF1A;</p>
<p><img src="../source/images/ch-05/ioc-01.png" alt="ioc-01"></p>
<p>&#x672C;&#x6587;&#x8981;&#x8BF4;&#x7684; IOC &#x603B;&#x4F53;&#x6765;&#x8BF4;&#x6709;&#x4E24;&#x5904;&#x5730;&#x65B9;&#x6700;&#x91CD;&#x8981;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;&#x521B;&#x5EFA; Bean &#x5BB9;&#x5668;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;&#x521D;&#x59CB;&#x5316; Bean&#x3002;&#x4E3A;&#x4E86;&#x4FDD;&#x6301;&#x6587;&#x7AE0;&#x7684;&#x4E25;&#x8C28;&#x6027;&#xFF0C;&#x5982;&#x679C;&#x540C;&#x5B66;&#x4EEC;&#x53D1;&#x73B0;&#x6587;&#x7AE0;&#x6709;&#x8BEF;&#x8BF7;&#x4E00;&#x5B9A;&#x4E0D;&#x541D;&#x6307;&#x51FA;&#x3002;</p>
<h4 id="demo"><a name="demo" class="anchor-navigation-ex-anchor" href="#demo"><i class="fa fa-link" aria-hidden="true"></i></a><a name="demo" class="plugin-anchor" href="#demo"><i class="fa fa-link" aria-hidden="true"></i></a>Demo</h4>
<h5 id="&#x914D;&#x7F6E;&#x7C7B;-mainconfigjava"><a name="&#x914D;&#x7F6E;&#x7C7B;-mainconfigjava" class="anchor-navigation-ex-anchor" href="#&#x914D;&#x7F6E;&#x7C7B;-mainconfigjava"><i class="fa fa-link" aria-hidden="true"></i></a><a name="&#x914D;&#x7F6E;&#x7C7B;-mainconfigjava" class="plugin-anchor" href="#&#x914D;&#x7F6E;&#x7C7B;-mainconfigjava"><i class="fa fa-link" aria-hidden="true"></i></a>&#x914D;&#x7F6E;&#x7C7B; MainConfig.java</h5>
<pre><code class="lang-java"><span class="hljs-comment">/**
 * Created by xsls on 2019/8/15.
 */</span>
<span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@ComponentScan</span>(basePackages = {<span class="hljs-string">&quot;com.tuling.iocbeanlifecicle&quot;</span>}) 
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MainConfig</span> </span>{

}
</code></pre>
<h5 id="bean-mainstartjava"><a name="bean-mainstartjava" class="anchor-navigation-ex-anchor" href="#bean-mainstartjava"><i class="fa fa-link" aria-hidden="true"></i></a><a name="bean-mainstartjava" class="plugin-anchor" href="#bean-mainstartjava"><i class="fa fa-link" aria-hidden="true"></i></a>Bean MainStart.java</h5>
<pre><code class="lang-java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">Car</span> </span>{

   <span class="hljs-keyword">private</span> String name;
   <span class="hljs-meta">@Autowired</span>
   <span class="hljs-keyword">private</span> Tank tank;

   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setTank</span><span class="hljs-params">(Tank tank)</span> </span>{
      <span class="hljs-keyword">this</span>.tank = tank;
   }

   <span class="hljs-function"><span class="hljs-keyword">public</span> Tank <span class="hljs-title">getTank</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> tank;
   }

   <span class="hljs-function"><span class="hljs-keyword">public</span> String <span class="hljs-title">getName</span><span class="hljs-params">()</span> </span>{
      <span class="hljs-keyword">return</span> name;
   }

   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setName</span><span class="hljs-params">(String name)</span> </span>{
      <span class="hljs-keyword">this</span>.name = name;
   }

   <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">Car</span><span class="hljs-params">()</span> </span>{
      System.out.println(<span class="hljs-string">&quot;car&#x52A0;&#x8F7D;....&quot;</span>);
   }
}
</code></pre>
<h2 id="1-spring-ioc&#x5BB9;&#x5668;&#x7684;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;"><a name="1-spring-ioc&#x5BB9;&#x5668;&#x7684;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;" class="anchor-navigation-ex-anchor" href="#1-spring-ioc&#x5BB9;&#x5668;&#x7684;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="1-spring-ioc&#x5BB9;&#x5668;&#x7684;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;" class="plugin-anchor" href="#1-spring-ioc&#x5BB9;&#x5668;&#x7684;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;"><i class="fa fa-link" aria-hidden="true"></i></a>1. Spring IoC&#x5BB9;&#x5668;&#x7684;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;</h2>
<h3 id="11-&#x5B9E;&#x4F8B;&#x5316;&#x5316;&#x5BB9;annotationconfigapplicationcontext"><a name="11-&#x5B9E;&#x4F8B;&#x5316;&#x5316;&#x5BB9;annotationconfigapplicationcontext" class="anchor-navigation-ex-anchor" href="#11-&#x5B9E;&#x4F8B;&#x5316;&#x5316;&#x5BB9;annotationconfigapplicationcontext"><i class="fa fa-link" aria-hidden="true"></i></a><a name="11-&#x5B9E;&#x4F8B;&#x5316;&#x5316;&#x5BB9;annotationconfigapplicationcontext" class="plugin-anchor" href="#11-&#x5B9E;&#x4F8B;&#x5316;&#x5316;&#x5BB9;annotationconfigapplicationcontext"><i class="fa fa-link" aria-hidden="true"></i></a>1.1 &#x5B9E;&#x4F8B;&#x5316;&#x5316;&#x5BB9;AnnotationConfigApplicationContext</h3>
<p>&#x4ECE;&#x8FD9;&#x91CC;&#x51FA;&#x53D1;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-comment">// &#x52A0;&#x8F7D;spring&#x4E0A;&#x4E0B;&#x6587;</span>
AnnotationConfigApplicationContext context = 
                <span class="hljs-keyword">new</span> AnnotationConfigApplicationContext(MainConfig.class);
</code></pre>
<h6 id="annotationconfigapplicationcontext&#x7684;&#x7ED3;&#x6784;&#x5173;&#x7CFB;&#xFF1A;"><a name="annotationconfigapplicationcontext&#x7684;&#x7ED3;&#x6784;&#x5173;&#x7CFB;&#xFF1A;" class="anchor-navigation-ex-anchor" href="#annotationconfigapplicationcontext&#x7684;&#x7ED3;&#x6784;&#x5173;&#x7CFB;&#xFF1A;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="annotationconfigapplicationcontext&#x7684;&#x7ED3;&#x6784;&#x5173;&#x7CFB;&#xFF1A;" class="plugin-anchor" href="#annotationconfigapplicationcontext&#x7684;&#x7ED3;&#x6784;&#x5173;&#x7CFB;&#xFF1A;"><i class="fa fa-link" aria-hidden="true"></i></a>AnnotationConfigApplicationContext&#x7684;&#x7ED3;&#x6784;&#x5173;&#x7CFB;&#xFF1A;</h6>
<p><img src="../source/images/ch-05/ioc-02.png" alt="ioc-02"></p>
<h6 id="&#x521B;&#x5EFA;annotationconfigapplicationcontext&#x5BF9;&#x8C61;"><a name="&#x521B;&#x5EFA;annotationconfigapplicationcontext&#x5BF9;&#x8C61;" class="anchor-navigation-ex-anchor" href="#&#x521B;&#x5EFA;annotationconfigapplicationcontext&#x5BF9;&#x8C61;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="&#x521B;&#x5EFA;annotationconfigapplicationcontext&#x5BF9;&#x8C61;" class="plugin-anchor" href="#&#x521B;&#x5EFA;annotationconfigapplicationcontext&#x5BF9;&#x8C61;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x521B;&#x5EFA;AnnotationConfigApplicationContext&#x5BF9;&#x8C61;</h6>
<pre><code class="lang-java"><span class="hljs-comment">// &#x6839;&#x636E;&#x53C2;&#x6570;&#x7C7B;&#x578B;&#x53EF;&#x4EE5;&#x77E5;&#x9053;&#xFF0C;&#x5176;&#x5B9E;&#x53EF;&#x4EE5;&#x4F20;&#x5165;&#x591A;&#x4E2A;annotatedClasses&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x79CD;&#x60C5;&#x51B5;&#x51FA;&#x73B0;&#x7684;&#x6BD4;&#x8F83;&#x5C11;</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AnnotationConfigApplicationContext</span><span class="hljs-params">(Class&lt;?&gt;... annotatedClasses)</span> </span>{
  <span class="hljs-comment">// &#x8C03;&#x7528;&#x65E0;&#x53C2;&#x6784;&#x9020;&#x51FD;&#x6570;&#xFF0C;&#x4F1A;&#x5148;&#x8C03;&#x7528;&#x7236;&#x7C7B;GenericApplicationContext&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;</span>
  <span class="hljs-comment">// &#x7236;&#x7C7B;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x91CC;&#x9762;&#x5C31;&#x662F;&#x521D;&#x59CB;&#x5316;DefaultListableBeanFactory&#xFF0C;&#x5E76;&#x4E14;&#x8D4B;&#x503C;&#x7ED9;beanFactory</span>
  <span class="hljs-comment">// &#x672C;&#x7C7B;&#x7684;&#x6784;&#x9020;&#x51FD;&#x6570;&#x91CC;&#x9762;&#xFF0C;&#x521D;&#x59CB;&#x5316;&#x4E86;&#x4E00;&#x4E2A;&#x8BFB;&#x53D6;&#x5668;&#xFF1A;AnnotatedBeanDefinitionReader read&#xFF0C;&#x4E00;&#x4E2A;&#x626B;&#x63CF;&#x5668;ClassPathBeanDefinitionScanner scanner</span>
  <span class="hljs-comment">// scanner&#x7684;&#x7528;&#x5904;&#x4E0D;&#x662F;&#x5F88;&#x5927;&#xFF0C;&#x5B83;&#x4EC5;&#x4EC5;&#x662F;&#x5728;&#x6211;&#x4EEC;&#x5916;&#x90E8;&#x624B;&#x52A8;&#x8C03;&#x7528; .scan &#x7B49;&#x65B9;&#x6CD5;&#x624D;&#x6709;&#x7528;&#xFF0C;&#x5E38;&#x89C4;&#x65B9;&#x5F0F;&#x4E0D;&#x4F1A;&#x7528;&#x5230;scanner&#x5BF9;&#x8C61;</span>
  <span class="hljs-keyword">this</span>();
  <span class="hljs-comment">// &#x628A;&#x4F20;&#x5165;&#x7684;&#x7C7B;&#x8FDB;&#x884C;&#x6CE8;&#x518C;&#xFF0C;&#x8FD9;&#x91CC;&#x6709;&#x4E24;&#x4E2A;&#x60C5;&#x51B5;&#xFF0C;</span>
  <span class="hljs-comment">// &#x4F20;&#x5165;&#x4F20;&#x7EDF;&#x7684;&#x914D;&#x7F6E;&#x7C7B;</span>
  <span class="hljs-comment">// &#x4F20;&#x5165;bean&#xFF08;&#x867D;&#x7136;&#x4E00;&#x822C;&#x6CA1;&#x6709;&#x4EBA;&#x4F1A;&#x8FD9;&#x4E48;&#x505A;</span>
  <span class="hljs-comment">// &#x770B;&#x5230;&#x540E;&#x9762;&#x4F1A;&#x77E5;&#x9053;spring&#x628A;&#x4F20;&#x7EDF;&#x7684;&#x5E26;&#x4E0A;@Configuration&#x7684;&#x914D;&#x7F6E;&#x7C7B;&#x79F0;&#x4E4B;&#x4E3A;FULL&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4E0D;&#x5E26;@Configuration&#x7684;&#x79F0;&#x4E4B;&#x4E3A;Lite&#x914D;&#x7F6E;&#x7C7B;</span>
  <span class="hljs-comment">// &#x4F46;&#x662F;&#x6211;&#x4EEC;&#x8FD9;&#x91CC;&#x5148;&#x628A;&#x5E26;&#x4E0A;@Configuration&#x7684;&#x914D;&#x7F6E;&#x7C7B;&#x79F0;&#x4E4B;&#x4E3A;&#x4F20;&#x7EDF;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4E0D;&#x5E26;&#x7684;&#x79F0;&#x4E4B;&#x4E3A;&#x666E;&#x901A;bean</span>
  register(annotatedClasses);
  <span class="hljs-comment">// &#x5237;&#x65B0;</span>
  refresh();
}
</code></pre>
<blockquote>
<p><strong>&#x6CE8;&#x610F;</strong></p>
<ol>
<li>&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x6709;&#x53C2;&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF0C;&#x53EF;&#x4EE5;&#x63A5;&#x6536;&#x591A;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4E0D;&#x8FC7;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x53EA;&#x4F1A;&#x4F20;&#x5165;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#x3002;</li>
<li>&#x8FD9;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#x6709;&#x4E24;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;&#x4E00;&#x79CD;&#x662F;&#x4F20;&#x7EDF;&#x610F;&#x4E49;&#x4E0A;&#x7684;&#x5E26;&#x4E0A; @Configuration<code>&#x6CE8;&#x89E3;&#x7684;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x79CD;&#x662F;&#x6CA1;&#x6709;&#x5E26;&#x4E0A; @Configuration&#xFF0C;&#x4F46;&#x662F;&#x5E26;&#x6709;</code>@Component<code>&#xFF0C;</code>@Import<code>&#xFF0C;</code>@ImportResouce<code>&#xFF0C;</code>@Service<code>&#xFF0C;</code>@ComponentScan` &#x7B49;&#x6CE8;&#x89E3;&#x7684;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x5728; Spring &#x5185;&#x90E8;&#x628A;&#x524D;&#x8005;&#x79F0;&#x4E3A;Full&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x628A;&#x540E;&#x8005;&#x79F0;&#x4E4B;&#x4E3A; Lite &#x914D;&#x7F6E;&#x7C7B;&#x3002;&#x5728;&#x672C;&#x6E90;&#x7801;&#x5206;&#x6790;&#x4E2D;&#xFF0C;&#x6709;&#x4E9B;&#x5730;&#x65B9;&#x4E5F;&#x628A; Lite &#x914D;&#x7F6E;&#x7C7B;&#x79F0;&#x4E3A;<strong>&#x666E;&#x901A; Bean</strong>&#x3002;</li>
</ol>
</blockquote>
<p>&#x4F7F;&#x7528;&#x65AD;&#x70B9;&#x8C03;&#x8BD5;&#xFF0C;&#x901A;&#x8FC7; <code>this()</code> &#x8C03;&#x7528;&#x6B64;&#x7C7B;&#x65E0;&#x53C2;&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF0C;&#x4EE3;&#x7801;&#x5230;&#x4E0B;&#x9762;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AnnotationConfigApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">GenericApplicationContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">AnnotationConfigRegistry</span> </span>{

    <span class="hljs-comment">// &#x6CE8;&#x89E3;bean&#x5B9A;&#x4E49;&#x8BFB;&#x53D6;&#x5668;&#xFF0C;&#x4E3B;&#x8981;&#x4F5C;&#x7528;&#x662F;&#x7528;&#x6765;&#x8BFB;&#x53D6;&#x88AB;&#x6CE8;&#x89E3;&#x7684;&#x4E86;bean</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AnnotatedBeanDefinitionReader reader;

    <span class="hljs-comment">// &#x626B;&#x63CF;&#x5668;&#xFF0C;&#x5B83;&#x4EC5;&#x4EC5;&#x662F;&#x5728;&#x6211;&#x4EEC;&#x5916;&#x90E8;&#x624B;&#x52A8;&#x8C03;&#x7528; .scan &#x7B49;&#x65B9;&#x6CD5;&#x624D;&#x6709;&#x7528;&#xFF0C;&#x5E38;&#x89C4;&#x65B9;&#x5F0F;&#x662F;&#x4E0D;&#x4F1A;&#x7528;&#x5230;scanner&#x5BF9;&#x8C61;&#x7684;</span>
    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> ClassPathBeanDefinitionScanner scanner;

    <span class="hljs-comment">/**
     * Create a new AnnotationConfigApplicationContext that needs to be populated
     * through {<span class="hljs-doctag">@link</span> #register} calls and then manually {<span class="hljs-doctag">@linkplain</span> #refresh refreshed}.
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AnnotationConfigApplicationContext</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-comment">// &#x4F1A;&#x9690;&#x5F0F;&#x8C03;&#x7528;&#x7236;&#x7C7B;&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF0C;&#x521D;&#x59CB;&#x5316;DefaultListableBeanFactory</span>
        <span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;Bean&#x8BFB;&#x53D6;&#x5668;</span>
        <span class="hljs-keyword">this</span>.reader = <span class="hljs-keyword">new</span> AnnotatedBeanDefinitionReader(<span class="hljs-keyword">this</span>);

        <span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x4E00;&#x4E2A;&#x626B;&#x63CF;&#x5668;&#xFF0C;&#x5B83;&#x4EC5;&#x4EC5;&#x662F;&#x5728;&#x6211;&#x4EEC;&#x5916;&#x90E8;&#x624B;&#x52A8;&#x8C03;&#x7528; .scan &#x7B49;&#x65B9;&#x6CD5;&#x624D;&#x6709;&#x7528;&#xFF0C;&#x5E38;&#x89C4;&#x65B9;&#x5F0F;&#x4E0D;&#x4F1A;&#x7528;&#x5230;scanner&#x5BF9;&#x8C61;</span>
        <span class="hljs-keyword">this</span>.scanner = <span class="hljs-keyword">new</span> ClassPathBeanDefinitionScanner(<span class="hljs-keyword">this</span>);
    }
}
</code></pre>
<p>&#x9996;&#x5148;&#x65E0;&#x53C2;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x4E2D;&#x5C31;&#x662F;&#x5BF9;&#x8BFB;&#x53D6;&#x5668; reader &#x548C;&#x626B;&#x63CF;&#x5668; scanner &#x8FDB;&#x884C;&#x4E86;&#x5B9E;&#x4F8B;&#x5316;&#xFF0C;reader &#x7684;&#x7C7B;&#x578B;&#x662F; AnnotatedBeanDefinitionReader&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x5B83;&#x662F;&#x4E00;&#x4E2A; &#x201C;&#x6253;&#x4E86;&#x6CE8;&#x89E3;&#x7684; Bean &#x5B9A;&#x4E49;&#x8BFB;&#x53D6;&#x5668;&#x201D;&#xFF0C;scanner &#x7684;&#x7C7B;&#x578B; &#x662F;ClassPathBeanDefinitionScanner&#xFF0C;&#x5B83;&#x4EC5;&#x4EC5;&#x662F;&#x5728;&#x5916;&#x9762;&#x624B;&#x52A8;&#x8C03;&#x7528; <code>.scan</code> &#x65B9;&#x6CD5;&#xFF0C;&#x6216;&#x8005;&#x8C03;&#x7528;&#x53C2;&#x6570;&#x4E3A;String&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF0C;&#x4F20;&#x5165;&#x9700;&#x8981;&#x626B;&#x63CF;&#x7684;&#x5305;&#x540D;&#x624D;&#x4F1A;&#x7528;&#x5230;&#xFF0C;&#x50CF;&#x8FD9;&#x6837;&#x65B9;&#x5F0F;&#x4F20;&#x5165;&#x7684;&#x914D;&#x7F6E;&#x7C7B;&#x662F;&#x4E0D;&#x4F1A;&#x7528;&#x5230;&#x8FD9;&#x4E2A; scanner &#x5BF9;&#x8C61;&#x7684;&#x3002;AnnotationConfigApplicationContext &#x7C7B;&#x662F;&#x6709;&#x7EE7;&#x627F;&#x5173;&#x7CFB;&#x7684;&#xFF0C;&#x4F1A;&#x9690;&#x5F0F;&#x8C03;&#x7528;&#x7236;&#x7C7B;&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF1A;</p>
<h3 id="12-&#x5B9E;&#x4F8B;&#x5316;&#x5DE5;&#x5382;-defaultlistablebeanfactory"><a name="12-&#x5B9E;&#x4F8B;&#x5316;&#x5DE5;&#x5382;-defaultlistablebeanfactory" class="anchor-navigation-ex-anchor" href="#12-&#x5B9E;&#x4F8B;&#x5316;&#x5DE5;&#x5382;-defaultlistablebeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a><a name="12-&#x5B9E;&#x4F8B;&#x5316;&#x5DE5;&#x5382;-defaultlistablebeanfactory" class="plugin-anchor" href="#12-&#x5B9E;&#x4F8B;&#x5316;&#x5DE5;&#x5382;-defaultlistablebeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a>1.2 &#x5B9E;&#x4F8B;&#x5316;&#x5DE5;&#x5382; DefaultListableBeanFactory</h3>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">GenericApplicationContext</span> <span class="hljs-keyword">extends</span> <span class="hljs-title">AbstractApplicationContext</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BeanDefinitionRegistry</span> </span>{

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> DefaultListableBeanFactory beanFactory;

    <span class="hljs-meta">@Nullable</span>
    <span class="hljs-keyword">private</span> ResourceLoader resourceLoader;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">boolean</span> customClassLoader = <span class="hljs-keyword">false</span>;

    <span class="hljs-keyword">private</span> <span class="hljs-keyword">final</span> AtomicBoolean refreshed = <span class="hljs-keyword">new</span> AtomicBoolean();


    <span class="hljs-comment">/**
     * Create a new GenericApplicationContext.
     * <span class="hljs-doctag">@see</span> #registerBeanDefinition
     * <span class="hljs-doctag">@see</span> #refresh
     */</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">GenericApplicationContext</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">this</span>.beanFactory = <span class="hljs-keyword">new</span> DefaultListableBeanFactory();
    }
}
</code></pre>
<p>DefaultListableBeanFactory &#x7684;&#x5173;&#x7CFB;&#x56FE;</p>
<p><img src="../source/images/ch-05/ioc-03.png" alt="ioc-03"></p>
<p>DefaultListableBeanFactory &#x662F;&#x76F8;&#x5F53;&#x91CD;&#x8981;&#x7684;&#xFF0C;&#x4ECE;&#x5B57;&#x9762;&#x610F;&#x601D;&#x5C31;&#x53EF;&#x4EE5;&#x770B;&#x51FA;&#x5B83;&#x662F;&#x4E00;&#x4E2A; Bean &#x7684;&#x5DE5;&#x5382;&#x2014;&#x2014;&#x7528;&#x6765;&#x751F;&#x4EA7;&#x548C;&#x83B7;&#x5F97; Bean &#x3002;</p>
<h3 id="13-&#x5B9E;&#x4F8B;&#x5316;beandefinition&#x8BFB;&#x53D6;&#x5668;&#x2014;annotatedbeandefinitionreader"><a name="13-&#x5B9E;&#x4F8B;&#x5316;beandefinition&#x8BFB;&#x53D6;&#x5668;&#x2014;annotatedbeandefinitionreader" class="anchor-navigation-ex-anchor" href="#13-&#x5B9E;&#x4F8B;&#x5316;beandefinition&#x8BFB;&#x53D6;&#x5668;&#x2014;annotatedbeandefinitionreader"><i class="fa fa-link" aria-hidden="true"></i></a><a name="13-&#x5B9E;&#x4F8B;&#x5316;beandefinition&#x8BFB;&#x53D6;&#x5668;&#x2014;annotatedbeandefinitionreader" class="plugin-anchor" href="#13-&#x5B9E;&#x4F8B;&#x5316;beandefinition&#x8BFB;&#x53D6;&#x5668;&#x2014;annotatedbeandefinitionreader"><i class="fa fa-link" aria-hidden="true"></i></a>1.3 &#x5B9E;&#x4F8B;&#x5316;BeanDefinition&#x8BFB;&#x53D6;&#x5668;&#x2014;AnnotatedBeanDefinitionReader</h3>
<p>&#x4E3B;&#x8981;&#x505A;&#x4E86;2&#x4EF6;&#x4E8B;&#x60C5;</p>
<ul>
<li>&#x6CE8;&#x518C;&#x5185;&#x7F6E; BeanPostProcessor</li>
<li>&#x6CE8;&#x518C;&#x76F8;&#x5173;&#x7684; BeanDefinition</li>
</ul>
<p><img src="../source/images/ch-05/ioc-04.png" alt="ioc-04"></p>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x628A;&#x76EE;&#x5149;&#x56DE;&#x5230; AnnotationConfigApplicationContext &#x7684;&#x65E0;&#x53C2;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x770B;&#x770B; Spring &#x5728;&#x521D;&#x59CB;&#x5316; AnnotatedBeanDefinitionReader &#x7684;&#x65F6;&#x5019;&#x505A;&#x4E86;&#x4EC0;&#x4E48;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AnnotatedBeanDefinitionReader</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> </span>{
    <span class="hljs-keyword">this</span>(registry, getOrCreateEnvironment(registry));
}
</code></pre>
<p>&#x8FD9;&#x91CC;&#x7684; BeanDefinitionRegistry &#x5F53;&#x7136;&#x5C31;&#x662F; AnnotationConfigApplicationContext &#x7684;&#x5B9E;&#x4F8B;&#x4E86;&#xFF0C;&#x8FD9;&#x91CC;&#x53C8;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x4E86;&#x6B64;&#x7C7B;&#x5176;&#x4ED6;&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">AnnotatedBeanDefinitionReader</span><span class="hljs-params">(BeanDefinitionRegistry registry, Environment environment)</span> </span>{
  Assert.notNull(registry, <span class="hljs-string">&quot;BeanDefinitionRegistry must not be null&quot;</span>);
  Assert.notNull(environment, <span class="hljs-string">&quot;Environment must not be null&quot;</span>);
  <span class="hljs-keyword">this</span>.registry = registry;
  <span class="hljs-keyword">this</span>.conditionEvaluator = <span class="hljs-keyword">new</span> ConditionEvaluator(registry, environment, <span class="hljs-keyword">null</span>);
  AnnotationConfigUtils.registerAnnotationConfigProcessors(<span class="hljs-keyword">this</span>.registry);
}
</code></pre>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x628A;&#x76EE;&#x5149;&#x79FB;&#x52A8;&#x5230;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x6700;&#x540E;&#x4E00;&#x884C;&#xFF0C;&#x8FDB;&#x5165; registerAnnotationConfigProcessors &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerAnnotationConfigProcessors</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> </span>{
    registerAnnotationConfigProcessors(registry, <span class="hljs-keyword">null</span>);
}
</code></pre>
<p>&#x8FD9;&#x53C8;&#x662F;&#x4E00;&#x4E2A;&#x95E8;&#x9762;&#x65B9;&#x6CD5;&#xFF0C;&#x518D;&#x70B9;&#x8FDB;&#x53BB;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x8FD4;&#x56DE;&#x503C;Set&#xFF0C;&#x4F46;&#x662F;&#x4E0A;&#x6E38;&#x65B9;&#x6CD5;&#x5E76;&#x6CA1;&#x6709;&#x53BB;&#x63A5;&#x6536;&#x8FD9;&#x4E2A;&#x8FD4;&#x56DE;&#x503C;&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x8FD4;&#x56DE;&#x503C;&#x4E5F;&#x4E0D;&#x662F;&#x5F88;&#x91CD;&#x8981;&#x4E86;&#xFF0C;&#x5F53;&#x7136;&#x65B9;&#x6CD5;&#x5185;&#x90E8;&#x7ED9;&#x8FD9;&#x4E2A;&#x8FD4;&#x56DE;&#x503C;&#x8D4B;&#x503C;&#x4E5F;&#x4E0D;&#x91CD;&#x8981;&#x4E86;&#x3002;&#x7531;&#x4E8E;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5185;&#x5BB9;&#x6BD4;&#x8F83;&#x591A;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x628A;&#x6700;&#x6838;&#x5FC3;&#x7684;&#x8D34;&#x51FA;&#x6765;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x6838;&#x5FC3;&#x5C31;&#x662F;&#x6CE8;&#x518C; Spring &#x5185;&#x7F6E;&#x7684;&#x591A;&#x4E2A; Bean&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">if</span> (!registry.containsBeanDefinition(CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME)) {
  RootBeanDefinition def = <span class="hljs-keyword">new</span> RootBeanDefinition(ConfigurationClassPostProcessor.class);
  def.setSource(source);
  beanDefs.add(
            registerPostProcessor(registry, def, CONFIGURATION_ANNOTATION_PROCESSOR_BEAN_NAME));
}
</code></pre>
<ul>
<li>&#x5224;&#x65AD;&#x5BB9;&#x5668;&#x4E2D;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x5B58;&#x5728;&#x4E86; ConfigurationClassPostProcessor Bean</li>
<li>&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#xFF08;&#x5F53;&#x7136;&#x8FD9;&#x91CC;&#x80AF;&#x5B9A;&#x662F;&#x4E0D;&#x5B58;&#x5728;&#x7684;&#xFF09;&#xFF0C;&#x5C31;&#x901A;&#x8FC7; RootBeanDefinition &#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x83B7;&#x5F97;ConfigurationClassPostProcessor&#x7684;BeanDefinition&#xFF0C;RootBeanDefinition &#x662F; BeanDefinition &#x7684;&#x5B50;&#x7C7B;</li>
<li>&#x6267;&#x884C; registerPostProcessor &#x65B9;&#x6CD5;&#xFF0C;registerPostProcessor &#x65B9;&#x6CD5;&#x5185;&#x90E8;&#x5C31;&#x662F;&#x6CE8;&#x518C; Bean&#xFF0C;&#x5F53;&#x7136;&#x8FD9;&#x91CC;&#x6CE8;&#x518C;&#x5176;&#x4ED6; Bean &#x4E5F;&#x662F;&#x4E00;&#x6837;&#x7684;&#x6D41;&#x7A0B;&#x3002;</li>
</ul>
<h4 id="beandefinition"><a name="beandefinition" class="anchor-navigation-ex-anchor" href="#beandefinition"><i class="fa fa-link" aria-hidden="true"></i></a><a name="beandefinition" class="plugin-anchor" href="#beandefinition"><i class="fa fa-link" aria-hidden="true"></i></a>BeanDefinition</h4>
<h5 id="&#x8054;&#x7CFB;&#x56FE;"><a name="&#x8054;&#x7CFB;&#x56FE;" class="anchor-navigation-ex-anchor" href="#&#x8054;&#x7CFB;&#x56FE;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="&#x8054;&#x7CFB;&#x56FE;" class="plugin-anchor" href="#&#x8054;&#x7CFB;&#x56FE;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x8054;&#x7CFB;&#x56FE;</h5>
<h6 id="&#x5411;&#x4E0A;"><a name="&#x5411;&#x4E0A;" class="anchor-navigation-ex-anchor" href="#&#x5411;&#x4E0A;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="&#x5411;&#x4E0A;" class="plugin-anchor" href="#&#x5411;&#x4E0A;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5411;&#x4E0A;</h6>
<p><img src="../source/images/ch-05/ioc-05.png" alt="ioc-05"></p>
<ul>
<li><strong>BeanMetadataElement &#x63A5;&#x53E3;</strong>&#xFF1A;BeanDefinition &#x5143;&#x6570;&#x636E;&#xFF0C;&#x8FD4;&#x56DE;&#x8BE5; Bean &#x7684;&#x6765;&#x6E90;</li>
<li><strong>AttributeAccessor &#x63A5;&#x53E3;</strong>&#xFF1A;&#x63D0;&#x4F9B;&#x5BF9; BeanDefinition &#x5C5E;&#x6027;&#x64CD;&#x4F5C;&#x80FD;&#x529B;&#xFF0C;</li>
</ul>
<h6 id="&#x5411;&#x4E0B;"><a name="&#x5411;&#x4E0B;" class="anchor-navigation-ex-anchor" href="#&#x5411;&#x4E0B;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="&#x5411;&#x4E0B;" class="plugin-anchor" href="#&#x5411;&#x4E0B;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x5411;&#x4E0B;</h6>
<p><img src="../source/images/ch-05/ioc-06.png" alt="ioc-06"></p>
<p>&#x5B83;&#x662F;&#x7528;&#x6765;&#x63CF;&#x8FF0; Bean &#x7684;&#xFF0C;&#x91CC;&#x9762;&#x5B58;&#x653E;&#x7740;&#x5173;&#x4E8E; Bean &#x7684;&#x4E00;&#x7CFB;&#x5217;&#x4FE1;&#x606F;&#xFF0C;&#x6BD4;&#x5982;Bean&#x7684;&#x4F5C;&#x7528;&#x57DF;&#xFF0C;Bean &#x6240;&#x5BF9;&#x5E94;&#x7684; Class&#xFF0C;&#x662F;&#x5426;&#x61D2;&#x52A0;&#x8F7D;&#xFF0C;&#x662F;&#x5426; Primary &#x7B49;&#x7B49;&#xFF0C;&#x8FD9;&#x4E2A; BeanDefinition &#x4E5F;&#x76F8;&#x5F53;&#x91CD;&#x8981;&#xFF0C;&#x6211;&#x4EEC;&#x4EE5;&#x540E;&#x4F1A;&#x5E38;&#x5E38;&#x548C;&#x5B83;&#x6253;&#x4EA4;&#x9053;&#x3002;</p>
<p>registerPostProcessor &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> BeanDefinitionHolder <span class="hljs-title">registerPostProcessor</span><span class="hljs-params">(
            BeanDefinitionRegistry registry, RootBeanDefinition definition, String beanName)</span> </span>{

    definition.setRole(BeanDefinition.ROLE_INFRASTRUCTURE);
    registry.registerBeanDefinition(beanName, definition);
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> BeanDefinitionHolder(definition, beanName);
}
</code></pre>
<p>&#x8FD9;&#x65B9;&#x6CD5;&#x4E3A; BeanDefinition &#x8BBE;&#x7F6E;&#x4E86;&#x4E00;&#x4E2A; Role&#xFF0C;ROLE_INFRASTRUCTURE &#x4EE3;&#x8868;&#x8FD9;&#x662F; spring &#x5185;&#x90E8;&#x7684;&#xFF0C;&#x5E76;&#x975E;&#x7528;&#x6237;&#x5B9A;&#x4E49;&#x7684;&#xFF0C;&#x7136;&#x540E;&#x53C8;&#x8C03;&#x7528;&#x4E86; registerBeanDefinition &#x65B9;&#x6CD5;&#xFF0C;&#x518D;&#x70B9;&#x8FDB;&#x53BB;&#xFF0C;Oh No&#xFF0C;&#x4F60;&#x4F1A;&#x53D1;&#x73B0;&#x5B83;&#x662F;&#x4E00;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x6CA1;&#x529E;&#x6CD5;&#x76F4;&#x63A5;&#x70B9;&#x8FDB;&#x53BB;&#x4E86;&#xFF0C;&#x9996;&#x5148;&#x8981;&#x77E5;&#x9053; registry &#x5B9E;&#x73B0;&#x7C7B;&#x662F;&#x4EC0;&#x4E48;&#xFF0C;&#x90A3;&#x4E48;&#x5B83;&#x7684;&#x5B9E;&#x73B0;&#x662F;&#x4EC0;&#x4E48;&#x5462;&#xFF1F;&#x7B54;&#x6848;&#x662F; DefaultListableBeanFactory&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerBeanDefinition</span><span class="hljs-params">(String beanName, BeanDefinition beanDefinition)</span>
            <span class="hljs-keyword">throws</span> BeanDefinitionStoreException </span>{
    <span class="hljs-keyword">this</span>.beanFactory.registerBeanDefinition(beanName, beanDefinition);
}
</code></pre>
<p>&#x8FD9;&#x53C8;&#x662F;&#x4E00;&#x4E2A;&#x95E8;&#x9762;&#x65B9;&#x6CD5;&#xFF0C;&#x518D;&#x70B9;&#x8FDB;&#x53BB;&#xFF0C;&#x6838;&#x5FC3;&#x5728;&#x4E8E;&#x4E0B;&#x9762;&#x4E24;&#x884C;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-comment">//beanDefinitionMap&#x662F;Map&lt;String, BeanDefinition&gt;&#xFF0C;</span>
<span class="hljs-comment">//&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x628A;beanName&#x4F5C;&#x4E3A;key&#xFF0C;ScopedProxyMode&#x4F5C;&#x4E3A;value&#xFF0C;&#x63A8;&#x5230;map&#x91CC;&#x9762;</span>
<span class="hljs-keyword">this</span>.beanDefinitionMap.put(beanName, beanDefinition);

<span class="hljs-comment">//beanDefinitionNames&#x5C31;&#x662F;&#x4E00;&#x4E2A;List&lt;String&gt;,&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x628A;beanName&#x653E;&#x5230;List&#x4E2D;&#x53BB;</span>
<span class="hljs-keyword">this</span>.beanDefinitionNames.add(beanName);
</code></pre>
<p>&#x4ECE;&#x8FD9;&#x91CC;&#x53EF;&#x4EE5;&#x770B;&#x51FA; DefaultListableBeanFactory &#x5C31;&#x662F;&#x6211;&#x4EEC;&#x6240;&#x8BF4;&#x7684;&#x5BB9;&#x5668;&#x4E86;&#xFF0C;&#x91CC;&#x9762;&#x653E;&#x7740; beanDefinitionMap&#xFF0C;beanDefinitionNames&#xFF0C;beanDefinitionMap &#x662F;&#x4E00;&#x4E2A; hashMap&#xFF0C;beanName &#x4F5C;&#x4E3A; Key&#xFF0C;beanDefinition &#x4F5C;&#x4E3A;Value&#xFF0C;beanDefinitionNames &#x662F;&#x4E00;&#x4E2A;&#x96C6;&#x5408;&#xFF0C;&#x91CC;&#x9762;&#x5B58;&#x653E;&#x4E86; beanName&#x3002;&#x6253;&#x4E2A;&#x65AD;&#x70B9;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x8FD0;&#x884C;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;&#x76D1;&#x89C6;&#x8FD9;&#x4E24;&#x4E2A;&#x53D8;&#x91CF;&#xFF1A;</p>
<p><img src="../source/images/ch-05/ioc-07.png" alt="ioc-07"></p>
<p><img src="../source/images/ch-05/ioc-08.png" alt="ioc-08"></p>
<p><strong>DefaultListableBeanFactory &#x4E2D;&#x7684; beanDefinitionMap&#xFF0C;beanDefinitionNames &#x4E5F;&#x662F;&#x76F8;&#x5F53;&#x91CD;&#x8981;&#x7684;&#xFF0C;&#x4EE5;&#x540E;&#x4F1A;&#x7ECF;&#x5E38;&#x770B;&#x5230;&#x5B83;&#xFF0C;&#x6700;&#x597D;&#x770B;&#x5230;&#x5B83;&#xFF0C;&#x7B2C;&#x4E00;&#x65F6;&#x95F4;&#x5C31;&#x53EF;&#x4EE5;&#x53CD;&#x5E94;&#x51FA;&#x5B83;&#x91CC;&#x9762;&#x653E;&#x4E86;&#x4EC0;&#x4E48;&#x6570;&#x636E;</strong></p>
<p>&#x8FD9;&#x91CC;&#x4EC5;&#x4EC5;&#x662F;&#x6CE8;&#x518C;&#xFF0C;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x7684;&#x7406;&#x89E3;&#x4E3A;&#x628A;&#x4E00;&#x4E9B;&#x539F;&#x6599;&#x653E;&#x5165;&#x5DE5;&#x5382;&#xFF0C;&#x5DE5;&#x5382;&#x8FD8;&#x6CA1;&#x6709;&#x771F;&#x6B63;&#x7684;&#x53BB;&#x751F;&#x4EA7;&#x3002;</p>
<p>&#x4E0A;&#x9762;&#x5DF2;&#x7ECF;&#x4ECB;&#x7ECD;&#x8FC7;&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;&#x4E00;&#x8FDE;&#x4E32;&#x6CE8;&#x518C;&#x597D;&#x51E0;&#x4E2A; Bean&#xFF0C;&#x5728;&#x8FD9;&#x5176;&#x4E2D;&#x6700;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x4E2A; Bean&#xFF08;&#x6CA1;&#x6709;&#x4E4B;&#x4E00;&#xFF09;&#x5C31;&#x662F;BeanDefinitionRegistryPostProcessor Bean&#x3002;</p>
<p><strong>ConfigurationClassPostProcessor &#x5B9E;&#x73B0; BeanDefinitionRegistryPostProcessor &#x63A5;&#x53E3;&#xFF0C;BeanDefinitionRegistryPostProcessor &#x63A5;&#x53E3;&#x53C8;&#x6269;&#x5C55;&#x4E86; BeanFactoryPostProcessor &#x63A5;&#x53E3;&#xFF0C;BeanFactoryPostProcessor &#x662F; Spring &#x7684;&#x6269;&#x5C55;&#x70B9;&#x4E4B;&#x4E00;&#xFF0C;ConfigurationClassPostProcessor &#x662F; Spring &#x6781;&#x4E3A;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x5FC5;&#x987B;&#x7262;&#x7262;&#x7684;&#x8BB0;&#x4F4F;&#x4E0A;&#x9762;&#x6240;&#x8BF4;&#x7684;&#x8FD9;&#x4E2A;&#x7C7B;&#x548C;&#x5B83;&#x7684;&#x7EE7;&#x627F;&#x5173;&#x7CFB;&#x3002;</strong></p>
<p><img src="../source/images/ch-05/ioc-09.png" alt="ioc-09"></p>
<p>&#x9664;&#x4E86;&#x6CE8;&#x518C;&#x4E86; ConfigurationClassPostProcessor&#xFF0C;&#x8FD8;&#x6CE8;&#x518C;&#x4E86;&#x5176;&#x4ED6; Bean&#xFF0C;&#x5176;&#x4ED6; Bean &#x4E5F;&#x90FD;&#x5B9E;&#x73B0;&#x4E86;&#x5176;&#x4ED6;&#x63A5;&#x53E3;&#xFF0C;&#x6BD4;&#x5982; BeanPostProcessor &#x7B49;&#x3002;</p>
<p><strong>BeanPostProcessor &#x63A5;&#x53E3;&#x4E5F;&#x662F; Spring &#x7684;&#x6269;&#x5C55;&#x70B9;&#x4E4B;&#x4E00;&#x3002;</strong></p>
<p>&#x81F3;&#x6B64;&#xFF0C;&#x5B9E;&#x4F8B;&#x5316; AnnotatedBeanDefinitionReader reader &#x5206;&#x6790;&#x5B8C;&#x6BD5;&#x3002;</p>
<h3 id="14-&#x521B;&#x5EFA;beandefinition&#x626B;&#x63CF;&#x5668;&#x2014;classpathbeandefinitionscanner"><a name="14-&#x521B;&#x5EFA;beandefinition&#x626B;&#x63CF;&#x5668;&#x2014;classpathbeandefinitionscanner" class="anchor-navigation-ex-anchor" href="#14-&#x521B;&#x5EFA;beandefinition&#x626B;&#x63CF;&#x5668;&#x2014;classpathbeandefinitionscanner"><i class="fa fa-link" aria-hidden="true"></i></a><a name="14-&#x521B;&#x5EFA;beandefinition&#x626B;&#x63CF;&#x5668;&#x2014;classpathbeandefinitionscanner" class="plugin-anchor" href="#14-&#x521B;&#x5EFA;beandefinition&#x626B;&#x63CF;&#x5668;&#x2014;classpathbeandefinitionscanner"><i class="fa fa-link" aria-hidden="true"></i></a>1.4 &#x521B;&#x5EFA;BeanDefinition&#x626B;&#x63CF;&#x5668;&#x2014;ClassPathBeanDefinitionScanner</h3>
<p>&#x7531;&#x4E8E;&#x5E38;&#x89C4;&#x4F7F;&#x7528;&#x65B9;&#x5F0F;&#x662F;&#x4E0D;&#x4F1A;&#x7528;&#x5230; AnnotationConfigApplicationContext &#x91CC;&#x9762;&#x7684; scanner &#x7684;&#xFF0C;&#x8FD9;&#x91CC;&#x7684; scanner &#x4EC5;&#x4EC5;&#x662F;&#x4E3A;&#x4E86;&#x7A0B;&#x5E8F;&#x5458;&#x53EF;&#x4EE5;&#x624B;&#x52A8;&#x8C03;&#x7528; AnnotationConfigApplicationContext &#x5BF9;&#x8C61;&#x7684; scan &#x65B9;&#x6CD5;&#x3002;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x770B; scanner &#x662F;&#x5982;&#x4F55;&#x88AB;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x4E86;&#x3002;</p>
<h3 id="15-&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#x4E3A;beandefinition&#x2014;registerannotatedclasses"><a name="15-&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#x4E3A;beandefinition&#x2014;registerannotatedclasses" class="anchor-navigation-ex-anchor" href="#15-&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#x4E3A;beandefinition&#x2014;registerannotatedclasses"><i class="fa fa-link" aria-hidden="true"></i></a><a name="15-&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#x4E3A;beandefinition&#x2014;registerannotatedclasses" class="plugin-anchor" href="#15-&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#x4E3A;beandefinition&#x2014;registerannotatedclasses"><i class="fa fa-link" aria-hidden="true"></i></a>1.5 &#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#x4E3A;BeanDefinition&#x2014;register(annotatedClasses)</h3>
<p>&#x628A;&#x76EE;&#x5149;&#x56DE;&#x5230;&#x6700;&#x5F00;&#x59CB;&#xFF0C;&#x518D;&#x5206;&#x6790;&#x7B2C;&#x4E8C;&#x884C;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code class="lang-java">register(annotatedClasses);
</code></pre>
<p>&#x8FD9;&#x91CC;&#x4F20;&#x8FDB;&#x53BB;&#x7684;&#x662F;&#x4E00;&#x4E2A;&#x6570;&#x7EC4;&#xFF0C;&#x6700;&#x7EC8;&#x4F1A;&#x5FAA;&#x73AF;&#x8C03;&#x7528;&#x5982;&#x4E0B;&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java">&lt;T&gt; <span class="hljs-function"><span class="hljs-keyword">void</span> <span class="hljs-title">doRegisterBean</span><span class="hljs-params">(Class&lt;T&gt; annotatedClass, @Nullable Supplier&lt;T&gt; instanceSupplier, @Nullable String name,
@Nullable Class&lt;? extends Annotation&gt;[] qualifiers, BeanDefinitionCustomizer... definitionCustomizers)</span> </span>{
    <span class="hljs-comment">// AnnotatedGenericBeanDefinition&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x4E00;&#x79CD;&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x662F;&#x7528;&#x6765;&#x63CF;&#x8FF0;Bean&#x7684;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;&#x4F5C;&#x7528;&#x5C31;&#x662F;&#x628A;&#x4F20;&#x5165;&#x7684;&#x6807;&#x8BB0;&#x4E86;&#x6CE8;&#x89E3;&#x7684;&#x7C7B;</span>
    <span class="hljs-comment">// &#x8F6C;&#x4E3A;AnnotatedGenericBeanDefinition&#x6570;&#x636E;&#x7ED3;&#x6784;&#xFF0C;&#x91CC;&#x9762;&#x6709;&#x4E00;&#x4E2A;getMetadata&#x65B9;&#x6CD5;&#xFF0C;&#x53EF;&#x4EE5;&#x62FF;&#x5230;&#x7C7B;&#x4E0A;&#x7684;&#x6CE8;&#x89E3;</span>
    AnnotatedGenericBeanDefinition abd = <span class="hljs-keyword">new</span> AnnotatedGenericBeanDefinition(annotatedClass);

    <span class="hljs-comment">// &#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x8DF3;&#x8FC7;&#x6CE8;&#x89E3;&#xFF0C;spring&#x4E2D;&#x6709;&#x4E00;&#x4E2A;@Condition&#x6CE8;&#x89E3;&#xFF0C;&#x5F53;&#x4E0D;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#xFF0C;&#x8FD9;&#x4E2A;bean&#x5C31;&#x4E0D;&#x4F1A;&#x88AB;&#x89E3;&#x6790;</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.conditionEvaluator.shouldSkip(abd.getMetadata())) {
        <span class="hljs-keyword">return</span>;
    }

    abd.setInstanceSupplier(instanceSupplier);

    <span class="hljs-comment">// &#x89E3;&#x6790;bean&#x7684;&#x4F5C;&#x7528;&#x57DF;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E;&#x7684;&#x8BDD;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;&#x5355;&#x4F8B;</span>
    ScopeMetadata scopeMetadata = <span class="hljs-keyword">this</span>.scopeMetadataResolver.resolveScopeMetadata(abd);
    abd.setScope(scopeMetadata.getScopeName());

    <span class="hljs-comment">// &#x83B7;&#x5F97;beanName</span>
    String beanName = (name != <span class="hljs-keyword">null</span> ? name : <span class="hljs-keyword">this</span>.beanNameGenerator.generateBeanName(abd, <span class="hljs-keyword">this</span>.registry));

    <span class="hljs-comment">// &#x89E3;&#x6790;&#x901A;&#x7528;&#x6CE8;&#x89E3;&#xFF0C;&#x586B;&#x5145;&#x5230;AnnotatedGenericBeanDefinition&#xFF0C;&#x89E3;&#x6790;&#x7684;&#x6CE8;&#x89E3;&#x4E3A;Lazy&#xFF0C;Primary&#xFF0C;DependsOn&#xFF0C;Role&#xFF0C;Description</span>
    AnnotationConfigUtils.processCommonDefinitionAnnotations(abd);

    <span class="hljs-comment">// &#x9650;&#x5B9A;&#x7B26;&#x5904;&#x7406;&#xFF0C;&#x4E0D;&#x662F;&#x7279;&#x6307;@Qualifier&#x6CE8;&#x89E3;&#xFF0C;&#x4E5F;&#x6709;&#x53EF;&#x80FD;&#x662F;Primary,&#x6216;&#x8005;&#x662F;Lazy&#xFF0C;&#x6216;&#x8005;&#x662F;&#x5176;&#x4ED6;&#xFF08;&#x7406;&#x8BBA;&#x4E0A;&#x662F;&#x4EFB;&#x4F55;&#x6CE8;&#x89E3;&#xFF0C;&#x8FD9;&#x91CC;&#x6CA1;&#x6709;&#x5224;&#x65AD;&#x6CE8;&#x89E3;&#x7684;&#x6709;&#x6548;&#x6027;&#xFF09;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x5728;&#x5916;&#x9762;&#xFF0C;&#x4EE5;&#x7C7B;&#x4F3C;&#x8FD9;&#x79CD;</span>
    <span class="hljs-comment">// AnnotationConfigApplicationContext annotationConfigApplicationContext = new AnnotationConfigApplicationContext(Appconfig.class);&#x5E38;&#x89C4;&#x65B9;&#x5F0F;&#x53BB;&#x521D;&#x59CB;&#x5316;spring&#xFF0C;</span>
    <span class="hljs-comment">// qualifiers&#x6C38;&#x8FDC;&#x90FD;&#x662F;&#x7A7A;&#x7684;&#xFF0C;&#x5305;&#x62EC;&#x4E0A;&#x9762;&#x7684;name&#x548C;instanceSupplier&#x90FD;&#x662F;&#x540C;&#x6837;&#x7684;&#x9053;&#x7406;</span>
    <span class="hljs-comment">// &#x4F46;&#x662F;spring&#x63D0;&#x4F9B;&#x4E86;&#x5176;&#x4ED6;&#x65B9;&#x5F0F;&#x53BB;&#x6CE8;&#x518C;bean&#xFF0C;&#x5C31;&#x53EF;&#x80FD;&#x4F1A;&#x4F20;&#x5165;&#x4E86;</span>
    <span class="hljs-keyword">if</span> (qualifiers != <span class="hljs-keyword">null</span>) {
        <span class="hljs-comment">// &#x53EF;&#x4EE5;&#x4F20;&#x5165;qualifier&#x6570;&#x7EC4;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x5FAA;&#x73AF;&#x5904;&#x7406;</span>
        <span class="hljs-keyword">for</span> (Class&lt;? extends Annotation&gt; qualifier : qualifiers) {
            <span class="hljs-comment">// Primary&#x6CE8;&#x89E3;&#x4F18;&#x5148;</span>
            <span class="hljs-keyword">if</span> (Primary.class == qualifier) {
                abd.setPrimary(<span class="hljs-keyword">true</span>);
            }
            <span class="hljs-comment">// Lazy&#x6CE8;&#x89E3;</span>
            <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (Lazy.class == qualifier) {
                abd.setLazyInit(<span class="hljs-keyword">true</span>);
            }
            <span class="hljs-comment">// &#x5176;&#x4ED6;&#xFF0C;AnnotatedGenericBeanDefinition&#x6709;&#x4E2A;Map&lt;String,AutowireCandidateQualifier&gt;&#x5C5E;&#x6027;&#xFF0C;&#x76F4;&#x63A5;push&#x8FDB;&#x53BB;</span>
            <span class="hljs-keyword">else</span> {
                abd.addQualifier(<span class="hljs-keyword">new</span> AutowireCandidateQualifier(qualifier));
            }
        }
    }

    <span class="hljs-keyword">for</span> (BeanDefinitionCustomizer customizer : definitionCustomizers) {
        customizer.customize(abd);
    }

    <span class="hljs-comment">// &#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7528;&#x5904;&#x4E0D;&#x5927;&#xFF0C;&#x5C31;&#x662F;&#x628A;AnnotatedGenericBeanDefinition&#x6570;&#x636E;&#x7ED3;&#x6784;&#x548C;beanName&#x5C01;&#x88C5;&#x5230;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x4E2D;</span>
    BeanDefinitionHolder definitionHolder = <span class="hljs-keyword">new</span> BeanDefinitionHolder(abd, beanName);

    definitionHolder = AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="hljs-keyword">this</span>.registry);

    <span class="hljs-comment">// &#x6CE8;&#x518C;&#xFF0C;&#x6700;&#x7EC8;&#x4F1A;&#x8C03;&#x7528;DefaultListableBeanFactory&#x4E2D;&#x7684;registerBeanDefinition&#x65B9;&#x6CD5;&#x53BB;&#x6CE8;&#x518C;&#xFF0C;</span>
    <span class="hljs-comment">// DefaultListableBeanFactory&#x7EF4;&#x62A4;&#x7740;&#x4E00;&#x7CFB;&#x5217;&#x4FE1;&#x606F;&#xFF0C;&#x6BD4;&#x5982;beanDefinitionNames&#xFF0C;beanDefinitionMap</span>
    <span class="hljs-comment">// beanDefinitionNames&#x662F;&#x4E00;&#x4E2A;List&lt;String&gt;,&#x7528;&#x6765;&#x4FDD;&#x5B58;beanName</span>
    <span class="hljs-comment">// beanDefinitionMap&#x662F;&#x4E00;&#x4E2A;Map,&#x7528;&#x6765;&#x4FDD;&#x5B58;beanName&#x548C;beanDefinition</span>
    BeanDefinitionReaderUtils.registerBeanDefinition(definitionHolder, <span class="hljs-keyword">this</span>.registry);
}
</code></pre>
<p>&#x5728;&#x8FD9;&#x91CC;&#x53C8;&#x8981;&#x8BF4;&#x660E;&#x4E0B;&#xFF0C;&#x4EE5;&#x5E38;&#x89C4;&#x65B9;&#x5F0F;&#x53BB;&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x6B64;&#x65B9;&#x6CD5;&#x4E2D;&#x9664;&#x4E86;&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#xFF0C;&#x5176;&#x4ED6;&#x53C2;&#x6570;&#x90FD;&#x662F;&#x9ED8;&#x8BA4;&#x503C;&#x3002;</p>
<ol>
<li>&#x901A;&#x8FC7; AnnotatedGenericBeanDefinition &#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF0C;&#x83B7;&#x5F97;&#x914D;&#x7F6E;&#x7C7B;&#x7684; BeanDefinition&#xFF0C;&#x8FD9;&#x91CC;&#x662F;&#x4E0D;&#x662F;&#x4F3C;&#x66FE;&#x76F8;&#x4F3C;&#xFF0C;&#x5728;&#x6CE8;&#x518C; ConfigurationClassPostProcessor &#x7C7B;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4E5F;&#x662F;&#x901A;&#x8FC7;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x53BB;&#x83B7;&#x5F97; BeanDefinition &#x7684;&#xFF0C;&#x53EA;&#x4E0D;&#x8FC7;&#x5F53;&#x65F6;&#x662F;&#x901A;&#x8FC7; RootBeanDefinition &#x53BB;&#x83B7;&#x5F97;&#xFF0C;&#x73B0;&#x5728;&#x662F;&#x901A;&#x8FC7; AnnotatedGenericBeanDefinition &#x53BB;&#x83B7;&#x5F97;&#x3002;</li>
<li>&#x5224;&#x65AD;&#x9700;&#x4E0D;&#x9700;&#x8981;&#x8DF3;&#x8FC7;&#x6CE8;&#x518C;&#xFF0C;Spring &#x4E2D;&#x6709;&#x4E00;&#x4E2A; @Condition &#x6CE8;&#x89E3;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#xFF0C;&#x5C31;&#x4F1A;&#x8DF3;&#x8FC7;&#x8FD9;&#x4E2A;&#x7C7B;&#x7684;&#x6CE8;&#x518C;&#x3002;</li>
<li>&#x7136;&#x540E;&#x662F;&#x89E3;&#x6790;&#x4F5C;&#x7528;&#x57DF;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E;&#x7684;&#x8BDD;&#xFF0C;&#x9ED8;&#x8BA4;&#x4E3A;&#x5355;&#x4F8B;</li>
<li>&#x83B7;&#x5F97; BeanName&#x3002;</li>
<li>&#x89E3;&#x6790;&#x901A;&#x7528;&#x6CE8;&#x89E3;&#xFF0C;&#x586B;&#x5145;&#x5230; AnnotatedGenericBeanDefinition&#xFF0C;&#x89E3;&#x6790;&#x7684;&#x6CE8;&#x89E3;&#x4E3A; Lazy&#xFF0C;Primary&#xFF0C;DependsOn&#xFF0C;Role&#xFF0C;Description&#x3002;</li>
<li>&#x9650;&#x5B9A;&#x7B26;&#x5904;&#x7406;&#xFF0C;&#x4E0D;&#x662F;&#x7279;&#x6307; @Qualifier &#x6CE8;&#x89E3;&#xFF0C;&#x4E5F;&#x6709;&#x53EF;&#x80FD;&#x662F; Primary&#xFF0C;&#x6216;&#x8005;&#x662F; Lazy&#xFF0C;&#x6216;&#x8005;&#x662F;&#x5176;&#x4ED6;&#xFF08;&#x7406;&#x8BBA;&#x4E0A;&#x662F;&#x4EFB;&#x4F55;&#x6CE8;&#x89E3;&#xFF0C;&#x8FD9;&#x91CC;&#x6CA1;&#x6709;&#x5224;&#x65AD;&#x6CE8;&#x89E3;&#x7684;&#x6709;&#x6548;&#x6027;&#xFF09;&#x3002;</li>
<li>&#x628A; AnnotatedGenericBeanDefinition &#x6570;&#x636E;&#x7ED3;&#x6784;&#x548C; beanName &#x5C01;&#x88C5;&#x5230;&#x4E00;&#x4E2A;&#x5BF9;&#x8C61;&#x4E2D;&#xFF08;&#x8FD9;&#x4E2A;&#x4E0D;&#x662F;&#x5F88;&#x91CD;&#x8981;&#xFF0C;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x7684;&#x7406;&#x89E3;&#x4E3A;&#x65B9;&#x4FBF;&#x4F20;&#x53C2;&#xFF09;&#x3002;</li>
<li>&#x6CE8;&#x518C;&#xFF0C;&#x6700;&#x7EC8;&#x4F1A;&#x8C03;&#x7528; DefaultListableBeanFactory &#x4E2D;&#x7684; registerBeanDefinition &#x65B9;&#x6CD5;&#x53BB;&#x6CE8;&#x518C;&#xFF1A;</li>
</ol>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">registerBeanDefinition</span><span class="hljs-params">(
                BeanDefinitionHolder definitionHolder, BeanDefinitionRegistry registry)</span> 
                <span class="hljs-keyword">throws</span> BeanDefinitionStoreException </span>{

    <span class="hljs-comment">// &#x83B7;&#x53D6;beanName</span>
    <span class="hljs-comment">// Register bean definition under primary name.</span>
    String beanName = definitionHolder.getBeanName();

    <span class="hljs-comment">// &#x6CE8;&#x518C;bean</span>
    registry.registerBeanDefinition(beanName, definitionHolder.getBeanDefinition());

    <span class="hljs-comment">// Spring&#x652F;&#x6301;&#x522B;&#x540D;</span>
    <span class="hljs-comment">// Register aliases for bean name, if any.</span>
    String[] aliases = definitionHolder.getAliases();
    <span class="hljs-keyword">if</span> (aliases != <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">for</span> (String alias : aliases) {
            registry.registerAlias(beanName, alias);
        }
    }
}
</code></pre>
<p>&#x8FD9;&#x4E2A; registerBeanDefinition &#x662F;&#x4E0D;&#x662F;&#x53C8;&#x6709;&#x4E00;&#x79CD;&#x4F3C;&#x66FE;&#x76F8;&#x4F3C;&#x7684;&#x611F;&#x89C9;&#xFF0C;&#x6CA1;&#x9519;&#xFF0C;&#x5728;&#x4E0A;&#x9762;&#x6CE8;&#x518C; Spring &#x5185;&#x7F6E;&#x7684; Bean &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5DF2;&#x7ECF;&#x89E3;&#x6790;&#x8FC7;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E86;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x4E0D;&#x91CD;&#x590D;&#x4E86;&#xFF0C;&#x6B64;&#x65F6;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x518D;&#x89C2;&#x5BDF;&#x4E0B; beanDefinitionMap beanDefinitionNames &#x4E24;&#x4E2A;&#x53D8;&#x91CF;&#xFF0C;&#x9664;&#x4E86; Spring &#x5185;&#x7F6E;&#x7684; Bean&#xFF0C;&#x8FD8;&#x6709;&#x6211;&#x4EEC;&#x4F20;&#x8FDB;&#x6765;&#x7684; Bean&#xFF0C;&#x8FD9;&#x91CC;&#x7684; Bean &#x5F53;&#x7136;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x7C7B;&#x4E86;&#xFF1A;</p>
<p><img src="../source/images/ch-05/ioc-10.png" alt="ioc-10"></p>
<p><img src="../source/images/ch-05/ioc-11.png" alt="ioc-11"></p>
<p>&#x5230;&#x8FD9;&#x91CC;&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#x4E5F;&#x5206;&#x6790;&#x5B8C;&#x6BD5;&#x4E86;&#x3002;</p>
<h3 id="16-refresh"><a name="16-refresh" class="anchor-navigation-ex-anchor" href="#16-refresh"><i class="fa fa-link" aria-hidden="true"></i></a><a name="16-refresh" class="plugin-anchor" href="#16-refresh"><i class="fa fa-link" aria-hidden="true"></i></a>1.6 refresh()</h3>
<p>&#x5927;&#x5BB6;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x5176;&#x5B9E;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;Spring &#x8FD8;&#x6CA1;&#x6709;&#x8FDB;&#x884C;&#x626B;&#x63CF;&#xFF0C;&#x53EA;&#x662F;&#x5B9E;&#x4F8B;&#x5316;&#x4E86;&#x4E00;&#x4E2A;&#x5DE5;&#x5382;&#xFF0C;&#x6CE8;&#x518C;&#x4E86;&#x4E00;&#x4E9B;&#x5185;&#x7F6E;&#x7684;Bean&#x548C;&#x6211;&#x4EEC;&#x4F20;&#x8FDB;&#x53BB;&#x7684;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x771F;&#x6B63;&#x7684;&#x5927;&#x5934;&#x662F;&#x5728;&#x7B2C;&#x4E09;&#x884C;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code class="lang-java">refresh();
</code></pre>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x505A;&#x4E86;&#x5F88;&#x591A;&#x4E8B;&#x60C5;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x70B9;&#x5F00;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">refresh</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> BeansException, IllegalStateException </span>{
    <span class="hljs-keyword">synchronized</span> (<span class="hljs-keyword">this</span>.startupShutdownMonitor) {
        <span class="hljs-comment">// Prepare this context for refreshing.</span>
        <span class="hljs-comment">// &#x5237;&#x65B0;&#x9884;&#x5904;&#x7406;&#xFF0C;&#x548C;&#x4E3B;&#x6D41;&#x7A0B;&#x5173;&#x7CFB;&#x4E0D;&#x5927;&#xFF0C;&#x5C31;&#x662F;&#x4FDD;&#x5B58;&#x4E86;&#x5BB9;&#x5668;&#x7684;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#xFF0C;&#x542F;&#x52A8;&#x6807;&#x5FD7;&#x7B49;</span>
        prepareRefresh();

        <span class="hljs-comment">// DefaultListableBeanFactory</span>
        <span class="hljs-comment">// Tell the subclass to refresh the internal bean factory.</span>
        <span class="hljs-comment">// &#x548C;&#x4E3B;&#x6D41;&#x7A0B;&#x5173;&#x7CFB;&#x4E5F;&#x4E0D;&#x5927;&#xFF0C;&#x6700;&#x7EC8;&#x83B7;&#x5F97;&#x4E86;DefaultListableBeanFactory&#xFF0C;</span>
        <span class="hljs-comment">// DefaultListableBeanFactory&#x5B9E;&#x73B0;&#x4E86;ConfigurableListableBeanFactory</span>
        ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory();

        <span class="hljs-comment">// Prepare the bean factory for use in this context.</span>
        <span class="hljs-comment">// &#x8FD8;&#x662F;&#x4E00;&#x4E9B;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#xFF0C;&#x6DFB;&#x52A0;&#x4E86;&#x4E24;&#x4E2A;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF1A;ApplicationContextAwareProcessor&#xFF0C;ApplicationListenerDetector</span>
        <span class="hljs-comment">// &#x8FD8;&#x8BBE;&#x7F6E;&#x4E86; &#x5FFD;&#x7565;&#x81EA;&#x52A8;&#x88C5;&#x914D; &#x548C; &#x5141;&#x8BB8;&#x81EA;&#x52A8;&#x88C5;&#x914D; &#x7684;&#x63A5;&#x53E3;,&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#x67D0;&#x4E2A;bean&#x7684;&#x65F6;&#x5019;&#xFF0C;spring&#x5C31;&#x81EA;&#x52A8;&#x6CE8;&#x518C;singleton bean</span>
        <span class="hljs-comment">// &#x8FD8;&#x8BBE;&#x7F6E;&#x4E86;bean&#x8868;&#x8FBE;&#x5F0F;&#x89E3;&#x6790;&#x5668; &#x7B49;</span>
        prepareBeanFactory(beanFactory);

        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// Allows post-processing of the bean factory in context subclasses.</span>
            <span class="hljs-comment">// &#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x7A7A;&#x65B9;&#x6CD5;</span>
            postProcessBeanFactory(beanFactory);

            <span class="hljs-comment">// Invoke factory processors registered as beans in the context.</span>
            <span class="hljs-comment">// &#x6267;&#x884C;&#x81EA;&#x5B9A;&#x4E49;&#x7684;BeanFactoryProcessor&#x548C;&#x5185;&#x7F6E;&#x7684;BeanFactoryProcessor</span>
            invokeBeanFactoryPostProcessors(beanFactory);

            <span class="hljs-comment">// Register bean processors that intercept bean creation.</span>
            <span class="hljs-comment">// &#x6CE8;&#x518C;BeanPostProcessor</span>
            registerBeanPostProcessors(beanFactory);

            <span class="hljs-comment">// Initialize message source for this context.</span>
            initMessageSource();

            <span class="hljs-comment">// Initialize event multicaster for this context.</span>
            initApplicationEventMulticaster();

            <span class="hljs-comment">// Initialize other special beans in specific context subclasses.</span>
            <span class="hljs-comment">// &#x7A7A;&#x65B9;&#x6CD5;</span>
            onRefresh();

            <span class="hljs-comment">// Check for listener beans and register them.</span>
            registerListeners();

            <span class="hljs-comment">// Instantiate all remaining (non-lazy-init) singletons.</span>
            finishBeanFactoryInitialization(beanFactory);

            <span class="hljs-comment">// Last step: publish corresponding event.</span>
            finishRefresh();
        } <span class="hljs-keyword">catch</span> (BeansException ex) {
            <span class="hljs-keyword">if</span> (logger.isWarnEnabled()) {
                logger.warn(<span class="hljs-string">&quot;Exception encountered during context initialization - &quot;</span> +
                    <span class="hljs-string">&quot;cancelling refresh attempt: &quot;</span> + ex);
            }

            <span class="hljs-comment">// Destroy already created singletons to avoid dangling resources.</span>
            destroyBeans();

            <span class="hljs-comment">// Reset &apos;active&apos; flag.</span>
            cancelRefresh(ex);

            <span class="hljs-comment">// Propagate exception to caller.</span>
            <span class="hljs-keyword">throw</span> ex;
        }

        <span class="hljs-keyword">finally</span> {
            <span class="hljs-comment">// Reset common introspection caches in Spring&apos;s core, since we</span>
            <span class="hljs-comment">// might not ever need metadata for singleton beans anymore...</span>
            resetCommonCaches();
        }
    }
}
</code></pre>
<p>&#x91CC;&#x9762;&#x6709;&#x5F88;&#x591A;&#x5C0F;&#x65B9;&#x6CD5;&#xFF0C;&#x6211;&#x4EEC;&#x4ECA;&#x5929;&#x7684;&#x76EE;&#x6807;&#x662F;&#x5206;&#x6790;&#x524D;&#x4E94;&#x4E2A;&#x5C0F;&#x65B9;&#x6CD5;&#xFF1A;</p>
<h4 id="preparerefresh"><a name="preparerefresh" class="anchor-navigation-ex-anchor" href="#preparerefresh"><i class="fa fa-link" aria-hidden="true"></i></a><a name="preparerefresh" class="plugin-anchor" href="#preparerefresh"><i class="fa fa-link" aria-hidden="true"></i></a>prepareRefresh</h4>
<p>&#x4ECE;&#x547D;&#x540D;&#x6765;&#x770B;&#xFF0C;&#x5C31;&#x77E5;&#x9053;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E3B;&#x8981;&#x505A;&#x4E86;&#x4E00;&#x4E9B;&#x5237;&#x65B0;&#x524D;&#x7684;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#xFF0C;&#x548C;&#x4E3B;&#x6D41;&#x7A0B;&#x5173;&#x7CFB;&#x4E0D;&#x5927;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x4FDD;&#x5B58;&#x4E86;&#x5BB9;&#x5668;&#x7684;&#x542F;&#x52A8;&#x65F6;&#x95F4;&#xFF0C;&#x542F;&#x52A8;&#x6807;&#x5FD7;&#x7B49;&#x3002;</p>
<h4 id="configurablelistablebeanfactory-beanfactory--obtainfreshbeanfactory"><a name="configurablelistablebeanfactory-beanfactory--obtainfreshbeanfactory" class="anchor-navigation-ex-anchor" href="#configurablelistablebeanfactory-beanfactory--obtainfreshbeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a><a name="configurablelistablebeanfactory-beanfactory--obtainfreshbeanfactory" class="plugin-anchor" href="#configurablelistablebeanfactory-beanfactory--obtainfreshbeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a>ConfigurableListableBeanFactory beanFactory = obtainFreshBeanFactory()</h4>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x548C;&#x4E3B;&#x6D41;&#x7A0B;&#x5173;&#x7CFB;&#x4E5F;&#x4E0D;&#x662F;&#x5F88;&#x5927;&#xFF0C;&#x53EF;&#x4EE5;&#x7B80;&#x5355;&#x7684;&#x8BA4;&#x4E3A;&#xFF0C;&#x5C31;&#x662F;&#x628A; beanFactory &#x53D6;&#x51FA;&#x6765;&#x800C;&#x5DF2;&#x3002;XML &#x6A21;&#x5F0F;&#x4E0B;&#x4F1A;&#x5728;&#x8FD9;&#x91CC;&#x8BFB;&#x53D6; BeanDefinition</p>
<h4 id="preparebeanfactory"><a name="preparebeanfactory" class="anchor-navigation-ex-anchor" href="#preparebeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a><a name="preparebeanfactory" class="plugin-anchor" href="#preparebeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a>prepareBeanFactory</h4>
<pre><code class="lang-java"><span class="hljs-comment">// &#x8FD8;&#x662F;&#x4E00;&#x4E9B;&#x51C6;&#x5907;&#x5DE5;&#x4F5C;&#xFF0C;&#x6DFB;&#x52A0;&#x4E86;&#x4E24;&#x4E2A;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF1A;ApplicationContextAwareProcessor&#xFF0C;ApplicationListenerDetector</span>
<span class="hljs-comment">// &#x8FD8;&#x8BBE;&#x7F6E;&#x4E86; &#x5FFD;&#x7565;&#x81EA;&#x52A8;&#x88C5;&#x914D; &#x548C; &#x5141;&#x8BB8;&#x81EA;&#x52A8;&#x88C5;&#x914D; &#x7684;&#x63A5;&#x53E3;,&#x5982;&#x679C;&#x4E0D;&#x5B58;&#x5728;&#x67D0;&#x4E2A;bean&#x7684;&#x65F6;&#x5019;&#xFF0C;spring&#x5C31;&#x81EA;&#x52A8;&#x6CE8;&#x518C;singleton bean</span>
<span class="hljs-comment">// &#x8FD8;&#x8BBE;&#x7F6E;&#x4E86;bean&#x8868;&#x8FBE;&#x5F0F;&#x89E3;&#x6790;&#x5668; &#x7B49;</span>
prepareBeanFactory(beanFactory);
</code></pre>
<p><img src="../source/images/ch-05/ioc-12.png" alt="ioc-12"></p>
<p>&#x8FD9;&#x4EE3;&#x7801;&#x76F8;&#x6BD4;&#x524D;&#x9762;&#x4E24;&#x4E2A;&#x5C31;&#x6BD4;&#x8F83;&#x91CD;&#x8981;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x9700;&#x8981;&#x70B9;&#x8FDB;&#x53BB;&#x597D;&#x597D;&#x770B;&#x770B;&#xFF0C;&#x505A;&#x4E86;&#x4EC0;&#x4E48;&#x64CD;&#x4F5C;:</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">prepareBeanFactory</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> </span>{
    <span class="hljs-comment">// Tell the internal bean factory to use the context&apos;s class loader etc.</span>
    beanFactory.setBeanClassLoader(getClassLoader());<span class="hljs-comment">//&#x8BBE;&#x7F6E;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;</span>

    <span class="hljs-comment">// &#x8BBE;&#x7F6E;bean&#x8868;&#x8FBE;&#x5F0F;&#x89E3;&#x6790;&#x5668;</span>
    beanFactory.setBeanExpressionResolver(<span class="hljs-keyword">new</span> StandardBeanExpressionResolver(beanFactory.getBeanClassLoader()));

    <span class="hljs-comment">// &#x5C5E;&#x6027;&#x7F16;&#x8F91;&#x5668;&#x652F;&#x6301;</span>
    beanFactory.addPropertyEditorRegistrar(<span class="hljs-keyword">new</span> ResourceEditorRegistrar(<span class="hljs-keyword">this</span>, getEnvironment()));

    <span class="hljs-comment">// Configure the bean factory with context callbacks.</span>
    <span class="hljs-comment">// &#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF1A;ApplicationContextAwareProcessor&#xFF0C;&#x6B64;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5904;&#x7406;&#x5668;&#x5B9E;&#x73B0;&#x4E86;BeanPostProcessor&#x63A5;&#x53E3;</span>
    beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> ApplicationContextAwareProcessor(<span class="hljs-keyword">this</span>));

    <span class="hljs-comment">// &#x4EE5;&#x4E0B;&#x63A5;&#x53E3;&#xFF0C;&#x5FFD;&#x7565;&#x81EA;&#x52A8;&#x88C5;&#x914D;</span>
    beanFactory.ignoreDependencyInterface(EnvironmentAware.class);
    beanFactory.ignoreDependencyInterface(EmbeddedValueResolverAware.class);
    beanFactory.ignoreDependencyInterface(ResourceLoaderAware.class);
    beanFactory.ignoreDependencyInterface(ApplicationEventPublisherAware.class);
    beanFactory.ignoreDependencyInterface(MessageSourceAware.class);
    beanFactory.ignoreDependencyInterface(ApplicationContextAware.class);

    <span class="hljs-comment">// BeanFactory interface not registered as resolvable type in a plain factory.</span>
    <span class="hljs-comment">// MessageSource registered (and found for autowiring) as a bean.</span>
    <span class="hljs-comment">// &#x4EE5;&#x4E0B;&#x63A5;&#x53E3;&#xFF0C;&#x5141;&#x8BB8;&#x81EA;&#x52A8;&#x88C5;&#x914D;,&#x7B2C;&#x4E00;&#x4E2A;&#x53C2;&#x6570;&#x662F;&#x81EA;&#x52A8;&#x88C5;&#x914D;&#x7684;&#x7C7B;&#x578B;&#xFF0C;&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x5B57;&#x6BB5;&#x662F;&#x81EA;&#x52A8;&#x88C5;&#x914D;&#x7684;&#x503C;</span>
    beanFactory.registerResolvableDependency(BeanFactory.class, beanFactory);
    beanFactory.registerResolvableDependency(ResourceLoader.class, <span class="hljs-keyword">this</span>);
    beanFactory.registerResolvableDependency(ApplicationEventPublisher.class, <span class="hljs-keyword">this</span>);
    beanFactory.registerResolvableDependency(ApplicationContext.class, <span class="hljs-keyword">this</span>);

    <span class="hljs-comment">// Register early post-processor for detecting inner beans as ApplicationListeners.</span>
    <span class="hljs-comment">// &#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF1A;ApplicationListenerDetector&#xFF0C;&#x6B64;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x5B9E;&#x73B0;&#x4E86;BeanPostProcessor&#x63A5;&#x53E3;</span>
    beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> ApplicationListenerDetector(<span class="hljs-keyword">this</span>));

    <span class="hljs-comment">// Detect a LoadTimeWeaver and prepare for weaving, if found.</span>
    <span class="hljs-keyword">if</span> (beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) {
        beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));
        <span class="hljs-comment">// Set a temporary ClassLoader for type matching.</span>
        beanFactory.setTempClassLoader(<span class="hljs-keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));
    }

    <span class="hljs-comment">// &#x5982;&#x679C;&#x6CA1;&#x6709;&#x6CE8;&#x518C;&#x8FC7;bean&#x540D;&#x79F0;&#x4E3A;XXX&#xFF0C;spring&#x5C31;&#x81EA;&#x5DF1;&#x521B;&#x5EFA;&#x4E00;&#x4E2A;&#x540D;&#x79F0;&#x4E3A;XXX&#x7684;singleton bean</span>
    <span class="hljs-comment">// Register default environment beans.</span>
    <span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(ENVIRONMENT_BEAN_NAME)) {
        beanFactory.registerSingleton(ENVIRONMENT_BEAN_NAME, getEnvironment());
    }
    <span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_PROPERTIES_BEAN_NAME)) {
        beanFactory.registerSingleton(SYSTEM_PROPERTIES_BEAN_NAME, getEnvironment().getSystemProperties());
    }
    <span class="hljs-keyword">if</span> (!beanFactory.containsLocalBean(SYSTEM_ENVIRONMENT_BEAN_NAME)) {
        beanFactory.registerSingleton(SYSTEM_ENVIRONMENT_BEAN_NAME, getEnvironment().getSystemEnvironment());
    }
}
</code></pre>
<p>&#x4E3B;&#x8981;&#x505A;&#x4E86;&#x5982;&#x4E0B;&#x7684;&#x64CD;&#x4F5C;&#xFF1A;</p>
<ul>
<li>&#x8BBE;&#x7F6E;&#x4E86;&#x4E00;&#x4E2A;&#x7C7B;&#x52A0;&#x8F7D;&#x5668;</li>
<li>&#x8BBE;&#x7F6E;&#x4E86;bean&#x8868;&#x8FBE;&#x5F0F;&#x89E3;&#x6790;&#x5668;</li>
<li>&#x6DFB;&#x52A0;&#x4E86;&#x5C5E;&#x6027;&#x7F16;&#x8F91;&#x5668;&#x7684;&#x652F;&#x6301;</li>
<li>&#x6DFB;&#x52A0;&#x4E86;&#x4E00;&#x4E2A;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF1A;ApplicationContextAwareProcessor&#xFF0C;&#x6B64;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x5B9E;&#x73B0;&#x4E86; BeanPostProcessor &#x63A5;&#x53E3;</li>
<li>&#x8BBE;&#x7F6E;&#x4E86;&#x4E00;&#x4E9B;&#x5FFD;&#x7565;&#x81EA;&#x52A8;&#x88C5;&#x914D;&#x7684;&#x63A5;&#x53E3;</li>
<li>&#x8BBE;&#x7F6E;&#x4E86;&#x4E00;&#x4E9B;&#x5141;&#x8BB8;&#x81EA;&#x52A8;&#x88C5;&#x914D;&#x7684;&#x63A5;&#x53E3;&#xFF0C;&#x5E76;&#x4E14;&#x8FDB;&#x884C;&#x4E86;&#x8D4B;&#x503C;&#x64CD;&#x4F5C;</li>
<li>&#x5728;&#x5BB9;&#x5668;&#x4E2D;&#x8FD8;&#x6CA1;&#x6709; XX &#x7684; bean &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x5E2E;&#x6211;&#x4EEC;&#x6CE8;&#x518C; beanName &#x4E3A; XX &#x7684; singleton bean</li>
</ul>
<h4 id="postprocessbeanfactorybeanfactory"><a name="postprocessbeanfactorybeanfactory" class="anchor-navigation-ex-anchor" href="#postprocessbeanfactorybeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a><a name="postprocessbeanfactorybeanfactory" class="plugin-anchor" href="#postprocessbeanfactorybeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a>postProcessBeanFactory(beanFactory)</h4>
<pre><code class="lang-java"><span class="hljs-comment">//&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x7A7A;&#x65B9;&#x6CD5;</span>
postProcessBeanFactory(beanFactory);
</code></pre>
<h4 id="invokebeanfactorypostprocessorsbeanfactory"><a name="invokebeanfactorypostprocessorsbeanfactory" class="anchor-navigation-ex-anchor" href="#invokebeanfactorypostprocessorsbeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a><a name="invokebeanfactorypostprocessorsbeanfactory" class="plugin-anchor" href="#invokebeanfactorypostprocessorsbeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a>invokeBeanFactoryPostProcessors(beanFactory)</h4>
<p>&#x53EF;&#x4EE5;&#x7ED3;&#x5408;&#x6D41;&#x7A0B;&#x56FE;&#x4E00;&#x8D77;&#x89C2;&#x770B;&#x66F4;&#x4F73;&#xFF1A;</p>
<p><a href="https://www.processon.com/view/link/5f18298a7d9c0835d38a57c0" target="_blank">https://www.processon.com/view/link/5f18298a7d9c0835d38a57c0</a></p>
<pre><code class="lang-java"> &#x6267;&#x884C;&#x81EA;&#x5B9A;&#x4E49;&#x7684;BeanFactoryProcessor&#x548C;&#x5185;&#x7F6E;&#x7684;<span class="hljs-function">BeanFactoryProcessor
<span class="hljs-title">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(beanFactory)</span></span>;

<span class="hljs-comment">// &#x91CD;&#x70B9;&#x4EE3;&#x7801;&#x7EC8;&#x4E8E;&#x6765;&#x4E86;&#xFF0C;&#x53EF;&#x4EE5;&#x8BF4; &#x8FD9;&#x53E5;&#x4EE3;&#x7801;&#x662F;&#x76EE;&#x524D;&#x4E3A;&#x6B62;&#x6700;&#x91CD;&#x8981;&#xFF0C;&#x4E5F;&#x662F;&#x5185;&#x5BB9;&#x6700;&#x591A;&#x7684;&#x4EE3;&#x7801;&#x4E86;&#xFF0C;&#x6211;&#x4EEC;&#x6709;&#x5FC5;&#x8981;&#x597D;&#x597D;&#x5206;&#x6790;&#x4E0B;&#xFF1A;</span>
<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(ConfigurableListableBeanFactory beanFactory)</span> </span>{

<span class="hljs-comment">// getBeanFactoryPostProcessors&#x771F;&#x662F;&#x5751;&#xFF0C;&#x7B2C;&#x4E00;&#x6B21;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6123;&#x4F4F;&#x4E86;&#xFF0C;&#x603B;&#x89C9;&#x5F97;&#x83B7;&#x5F97;&#x7684;&#x6C38;&#x8FDC;&#x90FD;&#x662F;&#x7A7A;&#x7684;&#x96C6;&#x5408;&#xFF0C;&#x6389;&#x5165;&#x5751;&#x91CC;&#xFF0C;&#x4E45;&#x4E45;&#x65E0;&#x6CD5;&#x81EA;&#x62D4;</span>
<span class="hljs-comment">// &#x540E;&#x6765;&#x624D;&#x77E5;&#x9053;spring&#x5141;&#x8BB8;&#x6211;&#x4EEC;&#x624B;&#x52A8;&#x6DFB;&#x52A0;BeanFactoryPostProcessor</span>
<span class="hljs-comment">// &#x5373;&#xFF1A;annotationConfigApplicationContext.addBeanFactoryPostProcessor(XXX);</span>
PostProcessorRegistrationDelegate.invokeBeanFactoryPostProcessors(beanFactory, getBeanFactoryPostProcessors());

    <span class="hljs-comment">// Detect a LoadTimeWeaver and prepare for weaving, if found in the meantime</span>
    <span class="hljs-comment">// (e.g. through an @Bean method registered by ConfigurationClassPostProcessor)</span>
    <span class="hljs-keyword">if</span> (beanFactory.getTempClassLoader() == <span class="hljs-keyword">null</span> &amp;&amp; beanFactory.containsBean(LOAD_TIME_WEAVER_BEAN_NAME)) {
        beanFactory.addBeanPostProcessor(<span class="hljs-keyword">new</span> LoadTimeWeaverAwareProcessor(beanFactory));
        beanFactory.setTempClassLoader(<span class="hljs-keyword">new</span> ContextTypeMatchClassLoader(beanFactory.getBeanClassLoader()));
    }
}
</code></pre>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x770B;&#x770B;&#x7B2C;&#x4E00;&#x4E2A;&#x5C0F;&#x65B9;&#x6CD5;&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> List&lt;BeanFactoryPostProcessor&gt; <span class="hljs-title">getBeanFactoryPostProcessors</span><span class="hljs-params">()</span> </span>{     
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">this</span>.beanFactoryPostProcessors;
}
</code></pre>
<p>&#x8FD9;&#x91CC;&#x83B7;&#x5F97;&#x7684;&#x662F; BeanFactoryPostProcessor&#xFF0C;&#x5F53;&#x6211;&#x770B;&#x5230;&#x8FD9;&#x91CC;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6123;&#x4F4F;&#x4E86;&#xFF0C;&#x901A;&#x8FC7; IDEA &#x7684;&#x67E5;&#x627E;&#x5F15;&#x7528;&#x529F;&#x80FD;&#xFF0C;&#x6211;&#x53D1;&#x73B0;&#x8FD9;&#x4E2A;&#x96C6;&#x5408;&#x6C38;&#x8FDC;&#x90FD;&#x662F;&#x7A7A;&#x7684;&#xFF0C;&#x6839;&#x672C;&#x6CA1;&#x6709;&#x4EE3;&#x7801;&#x4E3A;&#x8FD9;&#x4E2A;&#x96C6;&#x5408;&#x6DFB;&#x52A0;&#x6570;&#x636E;&#xFF0C;&#x5F88;&#x4E45;&#x90FD;&#x6CA1;&#x6709;&#x60F3;&#x901A;&#xFF0C;&#x540E;&#x6765;&#x624D;&#x77E5;&#x9053;&#x6211;&#x4EEC;&#x5728;&#x5916;&#x90E8;&#x53EF;&#x4EE5;&#x624B;&#x52A8;&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x800C;&#x4E0D;&#x662F;&#x4EA4;&#x7ED9; Spring &#x53BB;&#x626B;&#x63CF;&#xFF0C;&#x5373;&#xFF1A;</p>
<pre><code class="lang-java">AnnotationConfigApplicationContext annotationConfigApplicationContext =
                <span class="hljs-keyword">new</span> AnnotationConfigApplicationContext(AppConfig.class);
annotationConfigApplicationContext.addBeanFactoryPostProcessor(XXX);
</code></pre>
<p>&#x53EA;&#x6709;&#x8FD9;&#x6837;&#xFF0C;&#x8FD9;&#x4E2A;&#x96C6;&#x5408;&#x624D;&#x4E0D;&#x4F1A;&#x4E3A;&#x7A7A;&#xFF0C;&#x4F46;&#x662F;&#x5E94;&#x8BE5;&#x6CA1;&#x6709;&#x4EBA;&#x8FD9;&#x4E48;&#x505A;&#x5427;&#xFF0C;&#x5F53;&#x7136;&#x4E5F;&#x6709;&#x53EF;&#x80FD;&#x662F;&#x6211;&#x5B64;&#x964B;&#x5BE1;&#x95FB;&#x3002;</p>
<p>&#x8BA9;&#x6211;&#x4EEC;&#x70B9;&#x5F00; invokeBeanFactoryPostProcessors &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeBeanFactoryPostProcessors</span><span class="hljs-params">(
        ConfigurableListableBeanFactory beanFactory, List&lt;BeanFactoryPostProcessor&gt; beanFactoryPostProcessors)</span> </span>{

    <span class="hljs-comment">// Invoke BeanDefinitionRegistryPostProcessors first, if any.</span>
    Set&lt;String&gt; processedBeans = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();

    <span class="hljs-comment">// beanFactory&#x662F;DefaultListableBeanFactory&#xFF0C;&#x662F;BeanDefinitionRegistry&#x7684;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x80AF;&#x5B9A;&#x6EE1;&#x8DB3;if</span>
    <span class="hljs-keyword">if</span> (beanFactory <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistry) {
        BeanDefinitionRegistry registry = (BeanDefinitionRegistry) beanFactory;

        <span class="hljs-comment">// regularPostProcessors &#x7528;&#x6765;&#x5B58;&#x653E;BeanFactoryPostProcessor&#xFF0C;</span>
        List&lt;BeanFactoryPostProcessor&gt; regularPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

        <span class="hljs-comment">// registryProcessors &#x7528;&#x6765;&#x5B58;&#x653E;BeanDefinitionRegistryPostProcessor</span>
        <span class="hljs-comment">// BeanDefinitionRegistryPostProcessor&#x6269;&#x5C55;&#x4E86;BeanFactoryPostProcessor</span>
        List&lt;BeanDefinitionRegistryPostProcessor&gt; registryProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

        <span class="hljs-comment">// &#x5FAA;&#x73AF;&#x4F20;&#x8FDB;&#x6765;&#x7684;beanFactoryPostProcessors&#xFF0C;&#x6B63;&#x5E38;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;beanFactoryPostProcessors&#x80AF;&#x5B9A;&#x6CA1;&#x6709;&#x6570;&#x636E;</span>
        <span class="hljs-comment">// &#x56E0;&#x4E3A;beanFactoryPostProcessors&#x662F;&#x83B7;&#x5F97;&#x624B;&#x52A8;&#x6DFB;&#x52A0;&#x7684;&#xFF0C;&#x800C;&#x4E0D;&#x662F;spring&#x626B;&#x63CF;&#x7684;</span>
        <span class="hljs-comment">// &#x53EA;&#x6709;&#x624B;&#x52A8;&#x8C03;&#x7528;annotationConfigApplicationContext.addBeanFactoryPostProcessor(XXX)&#x624D;&#x4F1A;&#x6709;&#x6570;&#x636E;</span>
        <span class="hljs-keyword">for</span> (BeanFactoryPostProcessor postProcessor : beanFactoryPostProcessors) {
            <span class="hljs-comment">// &#x5224;&#x65AD;postProcessor&#x662F;&#x4E0D;&#x662F;BeanDefinitionRegistryPostProcessor&#xFF0C;&#x56E0;&#x4E3A;BeanDefinitionRegistryPostProcessor</span>
            <span class="hljs-comment">// &#x6269;&#x5C55;&#x4E86;BeanFactoryPostProcessor&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x5148;&#x8981;&#x5224;&#x65AD;&#x662F;&#x4E0D;&#x662F;BeanDefinitionRegistryPostProcessor</span>
            <span class="hljs-comment">// &#x662F;&#x7684;&#x8BDD;&#xFF0C;&#x76F4;&#x63A5;&#x6267;&#x884C;postProcessBeanDefinitionRegistry&#x65B9;&#x6CD5;&#xFF0C;&#x7136;&#x540E;&#x628A;&#x5BF9;&#x8C61;&#x88C5;&#x5230;registryProcessors&#x91CC;&#x9762;&#x53BB;</span>
            <span class="hljs-keyword">if</span> (postProcessor <span class="hljs-keyword">instanceof</span> BeanDefinitionRegistryPostProcessor) {
                BeanDefinitionRegistryPostProcessor registryProcessor =
                        (BeanDefinitionRegistryPostProcessor) postProcessor;
                registryProcessor.postProcessBeanDefinitionRegistry(registry);
                registryProcessors.add(registryProcessor);
            }

            <span class="hljs-keyword">else</span> {<span class="hljs-comment">//&#x4E0D;&#x662F;&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x88C5;&#x5230;regularPostProcessors</span>
                regularPostProcessors.add(postProcessor);
            }
        }

        <span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span>
        <span class="hljs-comment">// uninitialized to let the bean factory post-processors apply to them!</span>
        <span class="hljs-comment">// Separate between BeanDefinitionRegistryPostProcessors that implement</span>
        <span class="hljs-comment">// PriorityOrdered, Ordered, and the rest.</span>
        <span class="hljs-comment">// &#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x53D8;&#x91CF;&#xFF0C;&#x7528;&#x6765;&#x88C5;&#x8F7D;BeanDefinitionRegistryPostProcessor</span>
        <span class="hljs-comment">// BeanDefinitionRegistry&#x7EE7;&#x627F;&#x4E86;PostProcessorBeanFactoryPostProcessor</span>
        List&lt;BeanDefinitionRegistryPostProcessor&gt; currentRegistryProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();

        <span class="hljs-comment">// First, invoke the BeanDefinitionRegistryPostProcessors that implement PriorityOrdered.</span>
        <span class="hljs-comment">// &#x83B7;&#x5F97;&#x5B9E;&#x73B0;BeanDefinitionRegistryPostProcessor&#x63A5;&#x53E3;&#x7684;&#x7C7B;&#x7684;BeanName:org.springframework.context.annotation.internalConfigurationAnnotationProcessor</span>
        <span class="hljs-comment">// &#x5E76;&#x4E14;&#x88C5;&#x5165;&#x6570;&#x7EC4;postProcessorNames&#xFF0C;&#x6211;&#x7406;&#x89E3;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x53EA;&#x4F1A;&#x627E;&#x5230;&#x4E00;&#x4E2A;</span>
        <span class="hljs-comment">// &#x8FD9;&#x91CC;&#x53C8;&#x6709;&#x4E00;&#x4E2A;&#x5751;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x81EA;&#x5DF1;&#x521B;&#x5EFA;&#x4E86;&#x4E00;&#x4E2A;&#x5B9E;&#x73B0;BeanDefinitionRegistryPostProcessor&#x63A5;&#x53E3;&#x7684;&#x7C7B;&#xFF0C;&#x4E5F;&#x6253;&#x4E0A;&#x4E86;@Component&#x6CE8;&#x89E3;</span>
        <span class="hljs-comment">// &#x914D;&#x7F6E;&#x7C7B;&#x4E5F;&#x52A0;&#x4E0A;&#x4E86;@Component&#x6CE8;&#x89E3;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x5374;&#x6CA1;&#x6709;&#x62FF;&#x5230;</span>
        <span class="hljs-comment">// &#x56E0;&#x4E3A;&#x76F4;&#x5230;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;Spring&#x8FD8;&#x6CA1;&#x6709;&#x53BB;&#x626B;&#x63CF;&#xFF0C;&#x626B;&#x63CF;&#x662F;&#x5728;ConfigurationClassPostProcessor&#x7C7B;&#x4E2D;&#x5B8C;&#x6210;&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E0B;&#x9762;&#x7684;&#x7B2C;&#x4E00;&#x4E2A;</span>
        <span class="hljs-comment">// invokeBeanDefinitionRegistryPostProcessors&#x65B9;&#x6CD5;</span>
        String[] postProcessorNames =
                beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);

        <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) {
            <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {
                <span class="hljs-comment">// &#x83B7;&#x5F97;ConfigurationClassPostProcessor&#x7C7B;&#xFF0C;&#x5E76;&#x4E14;&#x653E;&#x5230;currentRegistryProcessors</span>
                <span class="hljs-comment">// ConfigurationClassPostProcessor&#x662F;&#x5F88;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x5B83;&#x5B9E;&#x73B0;&#x4E86;BeanDefinitionRegistryPostProcessor&#x63A5;&#x53E3;</span>
                <span class="hljs-comment">// BeanDefinitionRegistryPostProcessor&#x63A5;&#x53E3;&#x53C8;&#x5B9E;&#x73B0;&#x4E86;BeanFactoryPostProcessor&#x63A5;&#x53E3;</span>
                <span class="hljs-comment">// ConfigurationClassPostProcessor&#x662F;&#x6781;&#x5176;&#x91CD;&#x8981;&#x7684;&#x7C7B;</span>
                <span class="hljs-comment">// &#x91CC;&#x9762;&#x6267;&#x884C;&#x4E86;&#x626B;&#x63CF;Bean&#xFF0C;Import&#xFF0C;ImportResouce&#x7B49;&#x5404;&#x79CD;&#x64CD;&#x4F5C;</span>
                <span class="hljs-comment">// &#x7528;&#x6765;&#x5904;&#x7406;&#x914D;&#x7F6E;&#x7C7B;&#xFF08;&#x6709;&#x4E24;&#x79CD;&#x60C5;&#x51B5; &#x4E00;&#x79CD;&#x662F;&#x4F20;&#x7EDF;&#x610F;&#x4E49;&#x4E0A;&#x7684;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4E00;&#x79CD;&#x662F;&#x666E;&#x901A;&#x7684;bean&#xFF09;&#x7684;&#x5404;&#x79CD;&#x903B;&#x8F91;</span>
                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));
                <span class="hljs-comment">// &#x628A;name&#x653E;&#x5230;processedBeans&#xFF0C;&#x540E;&#x7EED;&#x4F1A;&#x6839;&#x636E;&#x8FD9;&#x4E2A;&#x96C6;&#x5408;&#x6765;&#x5224;&#x65AD;&#x5904;&#x7406;&#x5668;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x88AB;&#x6267;&#x884C;&#x8FC7;&#x4E86;</span>
                processedBeans.add(ppName);
            }
        }

        <span class="hljs-comment">// &#x5904;&#x7406;&#x6392;&#x5E8F;</span>
        sortPostProcessors(currentRegistryProcessors, beanFactory);

        <span class="hljs-comment">// &#x5408;&#x5E76;Processors&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x8981;&#x5408;&#x5E76;&#xFF0C;&#x56E0;&#x4E3A;registryProcessors&#x662F;&#x88C5;&#x8F7D;BeanDefinitionRegistryPostProcessor&#x7684;</span>
        <span class="hljs-comment">// &#x4E00;&#x5F00;&#x59CB;&#x7684;&#x65F6;&#x5019;&#xFF0C;spring&#x53EA;&#x4F1A;&#x6267;&#x884C;BeanDefinitionRegistryPostProcessor&#x72EC;&#x6709;&#x7684;&#x65B9;&#x6CD5;</span>
        <span class="hljs-comment">// &#x800C;&#x4E0D;&#x4F1A;&#x6267;&#x884C;BeanDefinitionRegistryPostProcessor&#x7236;&#x7C7B;&#x65B9;&#x6CD5;&#xFF0C;&#x5373;BeanFactoryProcessor&#x7684;&#x65B9;&#x6CD5;</span>
        <span class="hljs-comment">// &#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x628A;&#x5904;&#x7406;&#x5668;&#x653E;&#x5165;&#x4E00;&#x4E2A;&#x96C6;&#x5408;&#x4E2D;&#xFF0C;&#x540E;&#x7EED;&#x7EDF;&#x4E00;&#x6267;&#x884C;&#x7236;&#x7C7B;&#x7684;&#x65B9;&#x6CD5;</span>
        registryProcessors.addAll(currentRegistryProcessors);

        <span class="hljs-comment">// &#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x6267;&#x884C;ConfigurationClassPostProcessor&#x7684;postProcessBeanDefinitionRegistry&#x65B9;&#x6CD5;</span>
        <span class="hljs-comment">// Spring&#x70ED;&#x63D2;&#x64AD;&#x7684;&#x4F53;&#x73B0;&#xFF0C;&#x50CF;ConfigurationClassPostProcessor&#x5C31;&#x76F8;&#x5F53;&#x4E8E;&#x4E00;&#x4E2A;&#x7EC4;&#x4EF6;&#xFF0C;Spring&#x5F88;&#x591A;&#x4E8B;&#x60C5;&#x5C31;&#x662F;&#x4EA4;&#x7ED9;&#x7EC4;&#x4EF6;&#x53BB;&#x7BA1;&#x7406;</span>
        <span class="hljs-comment">// &#x5982;&#x679C;&#x4E0D;&#x60F3;&#x7528;&#x8FD9;&#x4E2A;&#x7EC4;&#x4EF6;&#xFF0C;&#x76F4;&#x63A5;&#x628A;&#x6CE8;&#x518C;&#x7EC4;&#x4EF6;&#x7684;&#x90A3;&#x4E00;&#x6B65;&#x53BB;&#x6389;&#x5C31;&#x53EF;&#x4EE5;</span>
        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);

        <span class="hljs-comment">// &#x56E0;&#x4E3A;currentRegistryProcessors&#x662F;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x53D8;&#x91CF;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x6E05;&#x9664;</span>
        currentRegistryProcessors.clear();

        <span class="hljs-comment">// Next, invoke the BeanDefinitionRegistryPostProcessors that implement Ordered.</span>
        <span class="hljs-comment">// &#x518D;&#x6B21;&#x6839;&#x636E;BeanDefinitionRegistryPostProcessor&#x83B7;&#x5F97;BeanName&#xFF0C;&#x770B;&#x8FD9;&#x4E2A;BeanName&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x88AB;&#x6267;&#x884C;&#x8FC7;&#x4E86;&#xFF0C;&#x6709;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;Ordered&#x63A5;&#x53E3;</span>
        <span class="hljs-comment">// &#x5982;&#x679C;&#x6CA1;&#x6709;&#x88AB;&#x6267;&#x884C;&#x8FC7;&#xFF0C;&#x4E5F;&#x5B9E;&#x73B0;&#x4E86;Ordered&#x63A5;&#x53E3;&#x7684;&#x8BDD;&#xFF0C;&#x628A;&#x5BF9;&#x8C61;&#x63A8;&#x9001;&#x5230;currentRegistryProcessors&#xFF0C;&#x540D;&#x79F0;&#x63A8;&#x9001;&#x5230;processedBeans</span>
        <span class="hljs-comment">// &#x5982;&#x679C;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;Ordered&#x63A5;&#x53E3;&#x7684;&#x8BDD;&#xFF0C;&#x8FD9;&#x91CC;&#x4E0D;&#x628A;&#x6570;&#x636E;&#x52A0;&#x5230;currentRegistryProcessors&#xFF0C;processedBeans&#x4E2D;&#xFF0C;&#x540E;&#x7EED;&#x518D;&#x505A;&#x5904;&#x7406;</span>
        <span class="hljs-comment">// &#x8FD9;&#x91CC;&#x624D;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x7684;&#x5B9E;&#x73B0;&#x4E86;BeanDefinitionRegistryPostProcessor&#x7684;Bean</span>
        postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);
        <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) {
            <span class="hljs-keyword">if</span> (!processedBeans.contains(ppName) &amp;&amp; beanFactory.isTypeMatch(ppName, Ordered.class)) {
                currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));
                processedBeans.add(ppName);
            }
        }

        <span class="hljs-comment">// &#x5904;&#x7406;&#x6392;&#x5E8F;</span>
        sortPostProcessors(currentRegistryProcessors, beanFactory);

        <span class="hljs-comment">// &#x5408;&#x5E76;Processors</span>
        registryProcessors.addAll(currentRegistryProcessors);

        <span class="hljs-comment">// &#x6267;&#x884C;&#x6211;&#x4EEC;&#x81EA;&#x5B9A;&#x4E49;&#x7684;BeanDefinitionRegistryPostProcessor</span>
        invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);

        <span class="hljs-comment">// &#x6E05;&#x7A7A;&#x4E34;&#x65F6;&#x53D8;&#x91CF;</span>
        currentRegistryProcessors.clear();

        <span class="hljs-comment">// Finally, invoke all other BeanDefinitionRegistryPostProcessors until no further ones appear.</span>
        <span class="hljs-comment">// &#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x6267;&#x884C;&#x4E86;&#x5B9E;&#x73B0;&#x4E86;Ordered&#x63A5;&#x53E3;&#x7684;BeanDefinitionRegistryPostProcessor&#xFF0C;</span>
        <span class="hljs-comment">// &#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x5C31;&#x662F;&#x6267;&#x884C;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;Ordered&#x63A5;&#x53E3;&#x7684;BeanDefinitionRegistryPostProcessor</span>
        <span class="hljs-keyword">boolean</span> reiterate = <span class="hljs-keyword">true</span>;
        <span class="hljs-keyword">while</span> (reiterate) {
            reiterate = <span class="hljs-keyword">false</span>;
            postProcessorNames = beanFactory.getBeanNamesForType(BeanDefinitionRegistryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);
            <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) {
                <span class="hljs-keyword">if</span> (!processedBeans.contains(ppName)) {
                    currentRegistryProcessors.add(beanFactory.getBean(ppName, BeanDefinitionRegistryPostProcessor.class));
                    processedBeans.add(ppName);
                    reiterate = <span class="hljs-keyword">true</span>;
                }
            }
            sortPostProcessors(currentRegistryProcessors, beanFactory);
            registryProcessors.addAll(currentRegistryProcessors);
            invokeBeanDefinitionRegistryPostProcessors(currentRegistryProcessors, registry);
            currentRegistryProcessors.clear();
        }

        <span class="hljs-comment">// Now, invoke the postProcessBeanFactory callback of all processors handled so far.</span>
        <span class="hljs-comment">// registryProcessors&#x96C6;&#x5408;&#x88C5;&#x8F7D;BeanDefinitionRegistryPostProcessor</span>
        <span class="hljs-comment">// &#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x6267;&#x884C;&#x5B50;&#x7C7B;&#x72EC;&#x6709;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x518D;&#x628A;&#x7236;&#x7C7B;&#x7684;&#x65B9;&#x6CD5;&#x4E5F;&#x6267;&#x884C;&#x4E00;&#x6B21;</span>
        invokeBeanFactoryPostProcessors(registryProcessors, beanFactory);

        <span class="hljs-comment">// regularPostProcessors&#x88C5;&#x8F7D;BeanFactoryPostProcessor&#xFF0C;&#x6267;&#x884C;BeanFactoryPostProcessor&#x7684;&#x65B9;&#x6CD5;</span>
        <span class="hljs-comment">// &#x4F46;&#x662F;regularPostProcessors&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x662F;&#x4E0D;&#x4F1A;&#x6709;&#x6570;&#x636E;&#x7684;&#xFF0C;&#x53EA;&#x6709;&#x5728;&#x5916;&#x9762;&#x624B;&#x52A8;&#x6DFB;&#x52A0;BeanFactoryPostProcessor&#xFF0C;&#x624D;&#x4F1A;&#x6709;&#x6570;&#x636E;</span>
        invokeBeanFactoryPostProcessors(regularPostProcessors, beanFactory);
    }

    <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// Invoke factory processors registered with the context instance.</span>
        invokeBeanFactoryPostProcessors(beanFactoryPostProcessors, beanFactory);
    }

    <span class="hljs-comment">// Do not initialize FactoryBeans here: We need to leave all regular beans</span>
    <span class="hljs-comment">// uninitialized to let the bean factory post-processors apply to them!</span>
    <span class="hljs-comment">// &#x627E;&#x5230;BeanFactoryPostProcessor&#x5B9E;&#x73B0;&#x7C7B;&#x7684;BeanName&#x6570;&#x7EC4;</span>
    String[] postProcessorNames =
            beanFactory.getBeanNamesForType(BeanFactoryPostProcessor.class, <span class="hljs-keyword">true</span>, <span class="hljs-keyword">false</span>);

    <span class="hljs-comment">// Separate between BeanFactoryPostProcessors that implement PriorityOrdered,</span>
    <span class="hljs-comment">// Ordered, and the rest.</span>
    List&lt;BeanFactoryPostProcessor&gt; priorityOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    List&lt;String&gt; orderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    List&lt;String&gt; nonOrderedPostProcessorNames = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-comment">// &#x5FAA;&#x73AF;BeanName&#x6570;&#x7EC4;</span>
    <span class="hljs-keyword">for</span> (String ppName : postProcessorNames) {
        <span class="hljs-comment">// &#x5982;&#x679C;&#x8FD9;&#x4E2A;Bean&#x88AB;&#x6267;&#x884C;&#x8FC7;&#x4E86;&#xFF0C;&#x8DF3;&#x8FC7;</span>
        <span class="hljs-keyword">if</span> (processedBeans.contains(ppName)) {
            <span class="hljs-comment">// skip - already processed in first phase above</span>
        }
        <span class="hljs-comment">// &#x5982;&#x679C;&#x5B9E;&#x73B0;&#x4E86;PriorityOrdered&#x63A5;&#x53E3;&#xFF0C;&#x52A0;&#x5165;&#x5230;priorityOrderedPostProcessors</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, PriorityOrdered.class)) {
            priorityOrderedPostProcessors.add(beanFactory.getBean(ppName, BeanFactoryPostProcessor.class));
        }
        <span class="hljs-comment">// &#x5982;&#x679C;&#x5B9E;&#x73B0;&#x4E86;Ordered&#x63A5;&#x53E3;&#xFF0C;&#x52A0;&#x5165;&#x5230;orderedPostProcessorNames</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (beanFactory.isTypeMatch(ppName, Ordered.class)) {
            orderedPostProcessorNames.add(ppName);
        }
        <span class="hljs-comment">// &#x5982;&#x679C;&#x65E2;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;PriorityOrdered&#xFF0C;&#x4E5F;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;Ordered&#x3002;&#x52A0;&#x5165;&#x5230;nonOrderedPostProcessorNames</span>
        <span class="hljs-keyword">else</span> {
            nonOrderedPostProcessorNames.add(ppName);
        }
    }

    <span class="hljs-comment">// &#x6392;&#x5E8F;&#x5904;&#x7406;priorityOrderedPostProcessors&#xFF0C;&#x5373;&#x5B9E;&#x73B0;&#x4E86;PriorityOrdered&#x63A5;&#x53E3;&#x7684;BeanFactoryPostProcessor</span>
    <span class="hljs-comment">// First, invoke the BeanFactoryPostProcessors that implement PriorityOrdered.</span>
    sortPostProcessors(priorityOrderedPostProcessors, beanFactory);
    <span class="hljs-comment">// &#x6267;&#x884C;priorityOrderedPostProcessors</span>
    invokeBeanFactoryPostProcessors(priorityOrderedPostProcessors, beanFactory);

    <span class="hljs-comment">// &#x6267;&#x884C;&#x5B9E;&#x73B0;&#x4E86;Ordered&#x63A5;&#x53E3;&#x7684;BeanFactoryPostProcessor</span>
    <span class="hljs-comment">// Next, invoke the BeanFactoryPostProcessors that implement Ordered.</span>
    List&lt;BeanFactoryPostProcessor&gt; orderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-keyword">for</span> (String postProcessorName : orderedPostProcessorNames) {
        orderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));
    }
    sortPostProcessors(orderedPostProcessors, beanFactory);
    invokeBeanFactoryPostProcessors(orderedPostProcessors, beanFactory);

    <span class="hljs-comment">// &#x6267;&#x884C;&#x65E2;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;PriorityOrdered&#x63A5;&#x53E3;&#xFF0C;&#x4E5F;&#x6CA1;&#x6709;&#x5B9E;&#x73B0;Ordered&#x63A5;&#x53E3;&#x7684;BeanFactoryPostProcessor</span>
    <span class="hljs-comment">// Finally, invoke all other BeanFactoryPostProcessors.</span>
    List&lt;BeanFactoryPostProcessor&gt; nonOrderedPostProcessors = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-keyword">for</span> (String postProcessorName : nonOrderedPostProcessorNames) {
        nonOrderedPostProcessors.add(beanFactory.getBean(postProcessorName, BeanFactoryPostProcessor.class));
    }
    invokeBeanFactoryPostProcessors(nonOrderedPostProcessors, beanFactory);

    <span class="hljs-comment">// Clear cached merged bean definitions since the post-processors might have</span>
    <span class="hljs-comment">// modified the original metadata, e.g. replacing placeholders in values...</span>
    beanFactory.clearMetadataCache();
}
</code></pre>
<p>&#x9996;&#x5148;&#x5224;&#x65AD; beanFactory &#x662F;&#x4E0D;&#x662F; BeanDefinitionRegistry &#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x5F53;&#x7136;&#x80AF;&#x5B9A;&#x662F;&#x7684;&#xFF0C;&#x7136;&#x540E;&#x6267;&#x884C;&#x5982;&#x4E0B;&#x64CD;&#x4F5C;&#xFF1A;</p>
<ul>
<li><p>&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;Set&#xFF0C;&#x88C5;&#x8F7D; BeanName&#xFF0C;&#x540E;&#x9762;&#x4F1A;&#x6839;&#x636E;&#x8FD9;&#x4E2A; Set&#xFF0C;&#x6765;&#x5224;&#x65AD;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x662F;&#x5426;&#x88AB;&#x6267;&#x884C;&#x8FC7;&#x4E86;&#x3002;</p>
</li>
<li><p>&#x5B9A;&#x4E49;&#x4E86;&#x4E24;&#x4E2A;List&#xFF0C;&#x4E00;&#x4E2A;&#x662F; regularPostProcessors&#xFF0C;&#x7528;&#x6765;&#x88C5;&#x8F7D; BeanFactoryPostProcessor&#xFF0C;&#x4E00;&#x4E2A;&#x662F;registryProcessors &#x7528;&#x6765;&#x88C5;&#x8F7D; BeanDefinitionRegistryPostProcessor&#xFF0C;&#x5176;&#x4E2D;BeanDefinitionRegistryPostProcessor &#x6269;&#x5C55;&#x4E86; BeanFactoryPostProcessor&#x3002;BeanDefinitionRegistryPostProcessor &#x6709;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;&#x72EC;&#x6709;&#x7684; postProcessBeanDefinitionRegistry &#x65B9;&#x6CD5;&#xFF0C;&#x4E00;&#x4E2A;&#x662F;&#x7236;&#x7C7B;&#x7684; postProcessBeanFactory &#x65B9;&#x6CD5;&#x3002;</p>
</li>
<li><p>&#x5FAA;&#x73AF;&#x4F20;&#x8FDB;&#x6765;&#x7684; beanFactoryPostProcessors&#xFF0C;&#x4E0A;&#x9762;&#x5DF2;&#x7ECF;&#x89E3;&#x91CA;&#x8FC7;&#x4E86;&#xFF0C;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x8FD9;&#x91CC;&#x6C38;&#x8FDC;&#x90FD;&#x662F;&#x7A7A;&#x7684;&#xFF0C;&#x53EA;&#x6709;&#x624B;&#x52A8; add beanFactoryPostProcessor&#xFF0C;&#x8FD9;&#x91CC;&#x624D;&#x4F1A;&#x6709;&#x6570;&#x636E;&#x3002;&#x6211;&#x4EEC;&#x5047;&#x8BBE; beanFactoryPostProcessors &#x6709;&#x6570;&#x636E;&#xFF0C;&#x8FDB;&#x5165;&#x5FAA;&#x73AF;&#xFF0C;&#x5224;&#x65AD; postProcessor &#x662F;&#x4E0D;&#x662F; BeanDefinitionRegistryPostProcessor&#xFF0C;&#x56E0;&#x4E3A;BeanDefinitionRegistryPostProcessor &#x6269;&#x5C55;&#x4E86; BeanFactoryPostProcessor&#xFF0C;&#x6240;&#x4EE5;&#x8FD9;&#x91CC;&#x5148;&#x8981;&#x5224;&#x65AD;&#x662F;&#x4E0D;&#x662F; BeanDefinitionRegistryPostProcessor&#xFF0C;&#x662F;&#x7684;&#x8BDD;&#xFF0C;&#x6267;&#x884C; postProcessBeanDefinitionRegistry &#x65B9;&#x6CD5;&#xFF0C;&#x7136;&#x540E;&#x628A;&#x5BF9;&#x8C61;&#x88C5;&#x5230; registryProcessors &#x91CC;&#x9762;&#x53BB;&#xFF0C;&#x4E0D;&#x662F;&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x88C5;&#x5230; regularPostProcessors&#x3002;</p>
</li>
<li><p>&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x53D8;&#x91CF;&#xFF1A;currentRegistryProcessors&#xFF0C;&#x7528;&#x6765;&#x88C5;&#x8F7D; BeanDefinitionRegistryPostProcessor&#x3002;</p>
</li>
<li><p>getBeanNamesForType&#xFF0C;&#x987E;&#x540D;&#x601D;&#x4E49;&#xFF0C;&#x662F;&#x6839;&#x636E;&#x7C7B;&#x578B;&#x67E5;&#x5230; BeanNames&#xFF0C;&#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x70B9;&#x9700;&#x8981;&#x6CE8;&#x610F;&#xFF0C;&#x5C31;&#x662F;&#x53BB;&#x54EA;&#x91CC;&#x627E;&#xFF0C;&#x70B9;&#x5F00;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7684;&#x8BDD;&#xFF0C;&#x5C31;&#x77E5;&#x9053;&#x662F;&#x5FAA;&#x73AF; beanDefinitionNames &#x53BB;&#x627E;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4EE5;&#x540E;&#x4E5F;&#x4F1A;&#x7ECF;&#x5E38;&#x770B;&#x5230;&#x3002;&#x8FD9;&#x91CC;&#x4F20;&#x4E86; BeanDefinitionRegistryPostProcessor.class&#xFF0C;&#x5C31;&#x662F;&#x627E;&#x5230;&#x7C7B;&#x578B;&#x4E3A; BeanDefinitionRegistryPostProcessor &#x7684;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x5E76;&#x4E14;&#x8D4B;&#x503C;&#x7ED9; postProcessorNames&#x3002;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C;&#x53EA;&#x4F1A;&#x627E;&#x5230;&#x4E00;&#x4E2A;&#xFF0C;&#x5C31;&#x662F;org.springframework.context.annotation.internalConfigurationAnnotationProcessor&#xFF0C;&#x4E5F;&#x5C31;&#x662F; ConfigurationAnnotationProcessor&#x3002;&#x8FD9;&#x4E2A;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x5728;&#x4E0A;&#x4E00;&#x8282;&#x4E2D;&#x5DF2;&#x7ECF;&#x8BF4;&#x660E;&#x8FC7;&#x4E86;&#xFF0C;&#x5341;&#x5206;&#x91CD;&#x8981;&#x3002;&#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x4E2A;&#x95EE;&#x9898;&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x6211;&#x81EA;&#x5DF1;&#x5199;&#x4E86;&#x4E2A;&#x7C7B;&#xFF0C;&#x5B9E;&#x73B0;&#x4E86; BeanDefinitionRegistryPostProcessor &#x63A5;&#x53E3;&#xFF0C;&#x4E5F;&#x6253;&#x4E0A;&#x4E86; @Component &#x6CE8;&#x89E3;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x6CA1;&#x6709;&#x83B7;&#x5F97;&#xFF0C;&#x56E0;&#x4E3A;&#x76F4;&#x5230;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;Spring&#x8FD8;&#x6CA1;&#x6709;&#x5B8C;&#x6210;&#x626B;&#x63CF;&#xFF0C;&#x626B;&#x63CF;&#x662F;&#x5728;ConfigurationClassPostProcessor &#x7C7B;&#x4E2D;&#x5B8C;&#x6210;&#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x4E0B;&#x9762;&#x7B2C;&#x4E00;&#x4E2A;invokeBeanDefinitionRegistryPostProcessors &#x65B9;&#x6CD5;&#x3002;</p>
</li>
<li><p>&#x5FAA;&#x73AF; postProcessorNames&#xFF0C;&#x5176;&#x5B9E;&#x4E5F;&#x5C31;&#x662F;org.springframework.context.annotation.internalConfigurationAnnotationProcessor&#xFF0C;&#x5224;&#x65AD;&#x6B64;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x662F;&#x5426;&#x5B9E;&#x73B0;&#x4E86; PriorityOrdered &#x63A5;&#x53E3;&#xFF08;ConfigurationAnnotationProcessor &#x4E5F;&#x5B9E;&#x73B0;&#x4E86; PriorityOrdered &#x63A5;&#x53E3;&#xFF09;&#xFF0C;</p>
<p>&#x5982;&#x679C;&#x5B9E;&#x73B0;&#x4E86;&#xFF0C;&#x628A;&#x5B83;&#x6DFB;&#x52A0;&#x5230; currentRegistryProcessors &#x8FD9;&#x4E2A;&#x4E34;&#x65F6;&#x53D8;&#x91CF;&#x4E2D;&#xFF0C;&#x518D;&#x653E;&#x5165;    processedBeans&#xFF0C;&#x4EE3;&#x8868;&#x8FD9;&#x4E2A;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5DF2;&#x7ECF;&#x88AB;&#x5904;&#x7406;&#x8FC7;&#x4E86;&#x3002;&#x5F53;&#x7136;&#x73B0;&#x5728;&#x8FD8;&#x6CA1;&#x6709;&#x5904;&#x7406;&#xFF0C;&#x4F46;&#x662F;&#x9A6C;&#x4E0A;&#x5C31;&#x8981;&#x5904;&#x7406;&#x4E86;&#x3002;</p>
</li>
</ul>
<p><img src="../source/images/ch-05/ioc-13.png" alt="ioc-13"></p>
<ul>
<li>&#x8FDB;&#x884C;&#x6392;&#x5E8F;&#xFF0C;PriorityOrdered &#x662F;&#x4E00;&#x4E2A;&#x6392;&#x5E8F;&#x63A5;&#x53E3;&#xFF0C;&#x5982;&#x679C;&#x5B9E;&#x73B0;&#x4E86;&#x5B83;&#xFF0C;&#x5C31;&#x8BF4;&#x660E;&#x6B64;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x662F;&#x6709;&#x987A;&#x5E8F;&#x7684;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x6392;&#x5E8F;&#x3002;&#x5F53;&#x7136;&#x76EE;&#x524D;&#x8FD9;&#x91CC;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x5C31;&#x662F; ConfigurationClassPostProcessor&#x3002;</li>
<li>&#x628A; currentRegistryProcessors &#x5408;&#x5E76;&#x5230; registryProcessors&#xFF0C;&#x4E3A;&#x4EC0;&#x4E48;&#x9700;&#x8981;&#x5408;&#x5E76;&#xFF1F;&#x56E0;&#x4E3A;&#x4E00;&#x5F00;&#x59CB;spring&#x53EA;&#x4F1A;&#x6267;&#x884C; BeanDefinitionRegistryPostProcessor &#x72EC;&#x6709;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x800C;&#x4E0D;&#x4F1A;&#x6267;&#x884C; BeanDefinitionRegistryPostProcessor &#x7236;&#x7C7B;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5373; BeanFactoryProcessor &#x63A5;&#x53E3;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x628A;&#x8FD9;&#x4E9B;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x653E;&#x5165;&#x4E00;&#x4E2A;&#x96C6;&#x5408;&#x4E2D;&#xFF0C;&#x540E;&#x7EED;&#x7EDF;&#x4E00;&#x6267;&#x884C; BeanFactoryProcessor &#x63A5;&#x53E3;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x3002;&#x5F53;&#x7136;&#x76EE;&#x524D;&#x8FD9;&#x91CC;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x5C31;&#x662F; ConfigurationClassPostProcessor&#x3002;</li>
<li>&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x6267;&#x884C; currentRegistryProcessors &#x4E2D;&#x7684; ConfigurationClassPostProcessor &#x4E2D;&#x7684;postProcessBeanDefinitionRegistry &#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x5C31;&#x662F; Spring &#x8BBE;&#x8BA1;&#x601D;&#x60F3;&#x7684;&#x4F53;&#x73B0;&#x4E86;&#xFF0C;&#x5728;&#x8FD9;&#x91CC;&#x4F53;&#x73B0;&#x7684;&#x5C31;&#x662F;&#x5176;&#x4E2D;&#x7684;<strong>&#x70ED;&#x63D2;&#x62D4;</strong>&#xFF0C;&#x63D2;&#x4EF6;&#x5316;&#x5F00;&#x53D1;&#x7684;&#x601D;&#x60F3;&#x3002;Spring &#x4E2D;&#x5F88;&#x591A;&#x4E1C;&#x897F;&#x90FD;&#x662F;&#x4EA4;&#x7ED9;&#x63D2;&#x4EF6;&#x53BB;&#x5904;&#x7406;&#x7684;&#xFF0C;&#x8FD9;&#x4E2A;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x5C31;&#x76F8;&#x5F53;&#x4E8E;&#x4E00;&#x4E2A;&#x63D2;&#x4EF6;&#xFF0C;&#x5982;&#x679C;&#x4E0D;&#x60F3;&#x7528;&#x4E86;&#xFF0C;&#x76F4;&#x63A5;&#x4E0D;&#x6DFB;&#x52A0;&#x5C31;&#x662F;&#x4E86;&#x3002;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7279;&#x522B;&#x91CD;&#x8981;&#xFF0C;&#x6211;&#x4EEC;&#x540E;&#x9762;&#x4F1A;&#x8BE6;&#x7EC6;&#x8BF4;&#x6765;&#x3002;</li>
</ul>
<p><img src="../source/images/ch-05/ioc-14.png" alt="ioc-14"></p>
<ul>
<li><p>&#x6E05;&#x7A7A; currentRegistryProcessors&#xFF0C;&#x56E0;&#x4E3A; currentRegistryProcessors &#x662F;&#x4E00;&#x4E2A;&#x4E34;&#x65F6;&#x53D8;&#x91CF;&#xFF0C;&#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#x4E86;&#x76EE;&#x524D;&#x7684;&#x4F7F;&#x547D;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x6E05;&#x7A7A;&#xFF0C;&#x5F53;&#x7136;&#x540E;&#x9762;&#x8FD8;&#x4F1A;&#x7528;&#x5230;&#x3002;</p>
</li>
<li><p>&#x518D;&#x6B21;&#x6839;&#x636E; BeanDefinitionRegistryPostProcessor &#x83B7;&#x5F97; BeanName&#xFF0C;&#x7136;&#x540E;&#x8FDB;&#x884C;&#x5FAA;&#x73AF;&#xFF0C;&#x770B;&#x8FD9;&#x4E2A;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x662F;&#x5426;&#x88AB;&#x6267;&#x884C;&#x8FC7;&#x4E86;&#xFF0C;&#x5982;&#x679C;&#x6CA1;&#x6709;&#x88AB;&#x6267;&#x884C;&#x8FC7;&#xFF0C;&#x4E5F;&#x5B9E;&#x73B0;&#x4E86; Ordered &#x63A5;&#x53E3;&#x7684;&#x8BDD;&#xFF0C;&#x628A;&#x6B64;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x63A8;&#x9001;&#x5230;currentRegistryProcessors &#x548C; processedBeans &#x4E2D;&#x3002;</p>
<p>&#x8FD9;&#x91CC;&#x5C31;&#x53EF;&#x4EE5;&#x83B7;&#x5F97;&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x6253;&#x4E0A; @Component &#x6CE8;&#x89E3;&#x7684;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x4E86;&#xFF0C;&#x56E0;&#x4E3A; Spring &#x5DF2;&#x7ECF;&#x5B8C;&#x6210;&#x4E86;&#x626B;&#x63CF;&#xFF0C;&#x4F46;&#x662F;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x7531;&#x4E8E; ConfigurationClassPostProcessor &#x5728;&#x4E0A;&#x9762;&#x5DF2;&#x7ECF;&#x88AB;&#x6267;&#x884C;&#x8FC7;&#x4E86;&#xFF0C;&#x6240;&#x4EE5;&#x867D;&#x7136;&#x53EF;&#x4EE5;&#x901A;&#x8FC7;getBeanNamesForType &#x83B7;&#x5F97;&#xFF0C;&#x4F46;&#x662F;&#x5E76;&#x4E0D;&#x4F1A;&#x52A0;&#x5165;&#x5230; currentRegistryProcessors &#x548C; processedBeans&#x3002;</p>
</li>
<li><p>&#x5904;&#x7406;&#x6392;&#x5E8F;&#x3002;</p>
</li>
<li><p>&#x5408;&#x5E76; Processors&#xFF0C;&#x5408;&#x5E76;&#x7684;&#x7406;&#x7531;&#x548C;&#x4E0A;&#x9762;&#x662F;&#x4E00;&#x6837;&#x7684;&#x3002;</p>
</li>
<li><p>&#x6267;&#x884C;&#x6211;&#x4EEC;&#x81EA;&#x5B9A;&#x4E49;&#x7684; BeanDefinitionRegistryPostProcessor&#x3002;</p>
</li>
<li><p>&#x6E05;&#x7A7A;&#x4E34;&#x65F6;&#x53D8;&#x91CF;&#x3002;</p>
</li>
<li><p>&#x5728;&#x4E0A;&#x9762;&#x7684;&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x4EC5;&#x4EC5;&#x662F;&#x6267;&#x884C;&#x4E86;&#x5B9E;&#x73B0;&#x4E86; Ordered &#x63A5;&#x53E3;&#x7684; BeanDefinitionRegistryPostProcessor&#xFF0C;&#x8FD9;&#x91CC;&#x662F;&#x6267;&#x884C;&#x6CA1;&#x6709;&#x5B9E;&#x73B0; Ordered &#x63A5;&#x53E3;&#x7684; BeanDefinitionRegistryPostProcessor&#x3002;</p>
</li>
<li><p>&#x4E0A;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x662F;&#x6267;&#x884C;&#x5B50;&#x7C7B;&#x72EC;&#x6709;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x518D;&#x628A;&#x7236;&#x7C7B;&#x7684;&#x65B9;&#x6CD5;&#x4E5F;&#x6267;&#x884C;&#x4E00;&#x6B21;&#x3002;</p>
</li>
<li><p>&#x6267;&#x884C; regularPostProcessors &#x4E2D;&#x7684;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x7684;&#x662F;&#xFF0C;&#x5728;&#x4E00;&#x822C;&#x60C5;&#x51B5;&#x4E0B;&#xFF0C; regularPostProcessors &#x662F;&#x4E0D;&#x4F1A;&#x6709;&#x6570;&#x636E;&#x7684;&#xFF0C;&#x53EA;&#x6709;&#x5728;&#x5916;&#x9762;&#x624B;&#x52A8;&#x6DFB;&#x52A0; BeanFactoryPostProcessor&#xFF0C;&#x624D;&#x4F1A;&#x6709;&#x6570;&#x636E;&#x3002;</p>
</li>
<li><p>&#x67E5;&#x627E;&#x5B9E;&#x73B0;&#x4E86; BeanFactoryPostProcessor &#x7684;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x5E76;&#x4E14;&#x6267;&#x884C;&#x540E;&#x7F6E;&#x5904;&#x7406;&#x5668;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#x3002;&#x548C;&#x4E0A;&#x9762;&#x7684;&#x903B;&#x8F91;&#x5DEE;&#x4E0D;&#x591A;&#xFF0C;&#x4E0D;&#x518D;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#x3002;</p>
<p>&#x8FD9;&#x5C31;&#x662F;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x505A;&#x7684;&#x4E3B;&#x8981;&#x7684;&#x4E8B;&#x60C5;&#x4E86;&#xFF0C;&#x53EF;&#x4EE5;&#x8BF4;&#x662F;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#x7684;&#x3002;&#x4F46;&#x662F;&#x903B;&#x8F91;&#x8FD8;&#x662F;&#x6BD4;&#x8F83;&#x6E05;&#x6670;&#x7684;&#xFF0C;&#x5728;&#x7B2C;9&#x6B65;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x6211;&#x8BF4;&#x6709;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;&#x4F1A;&#x8BE6;&#x7EC6;&#x8BF4;&#x6765;&#xFF0C;&#x73B0;&#x5728;&#x5C31;&#x8BA9;&#x6211;&#x4EEC;&#x597D;&#x597D;&#x770B;&#x770B;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7A76;&#x7ADF;&#x505A;&#x4E86;&#x4EC0;&#x4E48;&#x5427;&#x3002;</p>
</li>
</ul>
<p><img src="../source/images/ch-05/ioc-15.png" alt="ioc-15"></p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processConfigBeanDefinitions</span><span class="hljs-params">(BeanDefinitionRegistry registry)</span> </span>{
    List&lt;BeanDefinitionHolder&gt; configCandidates = <span class="hljs-keyword">new</span> ArrayList&lt;&gt;();
    <span class="hljs-comment">// &#x83B7;&#x5F97;&#x6240;&#x6709;&#x7684;BeanDefinition&#x7684;Name&#xFF0C;&#x653E;&#x5165;candidateNames&#x6570;&#x7EC4;</span>
    String[] candidateNames = registry.getBeanDefinitionNames();
    <span class="hljs-comment">// &#x5FAA;&#x73AF;candidateNames&#x6570;&#x7EC4;</span>
    <span class="hljs-keyword">for</span> (String beanName : candidateNames) {
        <span class="hljs-comment">// &#x6839;&#x636E;beanName&#x83B7;&#x5F97;BeanDefinition</span>
        BeanDefinition beanDef = registry.getBeanDefinition(beanName);

        <span class="hljs-comment">// &#x5185;&#x90E8;&#x6709;&#x4E24;&#x4E2A;&#x6807;&#x8BB0;&#x4F4D;&#x6765;&#x6807;&#x8BB0;&#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x5904;&#x7406;&#x8FC7;&#x4E86;</span>
        <span class="hljs-comment">// &#x8FD9;&#x91CC;&#x4F1A;&#x5F15;&#x53D1;&#x4E00;&#x8FDE;&#x4E32;&#x77E5;&#x8BC6;&#x76F2;&#x70B9;</span>
        <span class="hljs-comment">// &#x5F53;&#x6211;&#x4EEC;&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EF;&#x4EE5;&#x4E0D;&#x52A0;Configuration&#x6CE8;&#x89E3;&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528;Component ComponentScan Import ImportResource&#x6CE8;&#x89E3;&#xFF0C;&#x79F0;&#x4E4B;&#x4E3A;Lite&#x914D;&#x7F6E;&#x7C7B;</span>
        <span class="hljs-comment">// &#x5982;&#x679C;&#x52A0;&#x4E86;Configuration&#x6CE8;&#x89E3;&#xFF0C;&#x5C31;&#x79F0;&#x4E4B;&#x4E3A;Full&#x914D;&#x7F6E;&#x7C7B;</span>
        <span class="hljs-comment">// &#x5982;&#x679C;&#x6211;&#x4EEC;&#x6CE8;&#x518C;&#x4E86;Lite&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x6211;&#x4EEC;getBean&#x8FD9;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x5B83;&#x5C31;&#x662F;&#x539F;&#x672C;&#x7684;&#x90A3;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;</span>
        <span class="hljs-comment">// &#x5982;&#x679C;&#x6211;&#x4EEC;&#x6CE8;&#x518C;&#x4E86;Full&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x6211;&#x4EEC;getBean&#x8FD9;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x5B83;&#x5DF2;&#x7ECF;&#x4E0D;&#x662F;&#x539F;&#x672C;&#x90A3;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#x4E86;&#xFF0C;&#x800C;&#x662F;&#x5DF2;&#x7ECF;&#x88AB;cgilb&#x4EE3;&#x7406;&#x7684;&#x7C7B;&#x4E86;</span>
        <span class="hljs-comment">// &#x5199;&#x4E00;&#x4E2A;A&#x7C7B;&#xFF0C;&#x5176;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF0C;&#x6253;&#x5370;&#x51FA;&#x201C;&#x4F60;&#x597D;&#x201D;</span>
        <span class="hljs-comment">// &#x518D;&#x5199;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x91CC;&#x9762;&#x6709;&#x4E24;&#x4E2A;bean&#x6CE8;&#x89E3;&#x7684;&#x65B9;&#x6CD5;</span>
        <span class="hljs-comment">// &#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5;new&#x4E86;A &#x7C7B;&#xFF0C;&#x5E76;&#x4E14;&#x8FD4;&#x56DE;A&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x628A;&#x6B64;&#x65B9;&#x6CD5;&#x79F0;&#x4E4B;&#x4E3A;getA</span>
        <span class="hljs-comment">// &#x7B2C;&#x4E8C;&#x4E2A;&#x65B9;&#x6CD5;&#x53C8;&#x8C03;&#x7528;&#x4E86;getA&#x65B9;&#x6CD5;</span>
        <span class="hljs-comment">// &#x5982;&#x679C;&#x914D;&#x7F6E;&#x7C7B;&#x662F;Lite&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x6253;&#x5370;&#x4E86;&#x4E24;&#x6B21;&#x201C;&#x4F60;&#x597D;&#x201D;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;A&#x7C7B;&#x88AB;new&#x4E86;&#x4E24;&#x6B21;</span>
        <span class="hljs-comment">// &#x5982;&#x679C;&#x914D;&#x7F6E;&#x7C7B;&#x662F;Full&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x53EA;&#x6253;&#x5370;&#x4E86;&#x4E00;&#x6B21;&#x201C;&#x4F60;&#x597D;&#x201D;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4;A&#x7C7B;&#x53EA;&#x88AB;new&#x4E86;&#x4E00;&#x6B21;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x7C7B;&#x88AB;cgilb&#x4EE3;&#x7406;&#x4E86;&#xFF0C;&#x65B9;&#x6CD5;&#x5DF2;&#x7ECF;&#x88AB;&#x6539;&#x5199;</span>
        <span class="hljs-keyword">if</span> (ConfigurationClassUtils.isFullConfigurationClass(beanDef) ||
                ConfigurationClassUtils.isLiteConfigurationClass(beanDef)) {
            <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) {
                logger.debug(<span class="hljs-string">&quot;Bean definition has already been processed as a configuration class: &quot;</span> + beanDef);
            }
        }

        <span class="hljs-comment">// &#x5224;&#x65AD;&#x662F;&#x5426;&#x4E3A;&#x914D;&#x7F6E;&#x7C7B;&#xFF08;&#x6709;&#x4E24;&#x79CD;&#x60C5;&#x51B5; &#x4E00;&#x79CD;&#x662F;&#x4F20;&#x7EDF;&#x610F;&#x4E49;&#x4E0A;&#x7684;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4E00;&#x79CD;&#x662F;&#x666E;&#x901A;&#x7684;bean&#xFF09;&#xFF0C;</span>
        <span class="hljs-comment">// &#x5728;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5185;&#x90E8;&#xFF0C;&#x4F1A;&#x505A;&#x5224;&#x65AD;&#xFF0C;&#x8FD9;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#x662F;Full&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x8FD8;&#x662F;Lite&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x5E76;&#x4E14;&#x505A;&#x4E0A;&#x6807;&#x8BB0;</span>
        <span class="hljs-comment">// &#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#xFF0C;&#x52A0;&#x5165;&#x5230;configCandidates</span>
        <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(beanDef, <span class="hljs-keyword">this</span>.metadataReaderFactory)) {
            configCandidates.add(<span class="hljs-keyword">new</span> BeanDefinitionHolder(beanDef, beanName));
        }
    }

    <span class="hljs-comment">// &#x5982;&#x679C;&#x6CA1;&#x6709;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;</span>
    <span class="hljs-comment">// Return immediately if no @Configuration classes were found</span>
    <span class="hljs-keyword">if</span> (configCandidates.isEmpty()) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-comment">// Sort by previously determined @Order value, if applicable</span>
    <span class="hljs-comment">// &#x5904;&#x7406;&#x6392;&#x5E8F;</span>
    configCandidates.sort((bd1, bd2) -&gt; {
        <span class="hljs-keyword">int</span> i1 = ConfigurationClassUtils.getOrder(bd1.getBeanDefinition());
        <span class="hljs-keyword">int</span> i2 = ConfigurationClassUtils.getOrder(bd2.getBeanDefinition());
        <span class="hljs-keyword">return</span> Integer.compare(i1, i2);
    });

    <span class="hljs-comment">// Detect any custom bean name generation strategy supplied through the enclosing application context</span>
    SingletonBeanRegistry sbr = <span class="hljs-keyword">null</span>;
    <span class="hljs-comment">// DefaultListableBeanFactory&#x6700;&#x7EC8;&#x4F1A;&#x5B9E;&#x73B0;SingletonBeanRegistry&#x63A5;&#x53E3;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x8FDB;&#x5165;&#x5230;&#x8FD9;&#x4E2A;if</span>
    <span class="hljs-keyword">if</span> (registry <span class="hljs-keyword">instanceof</span> SingletonBeanRegistry) {
        sbr = (SingletonBeanRegistry) registry;
        <span class="hljs-keyword">if</span> (!<span class="hljs-keyword">this</span>.localBeanNameGeneratorSet) {
            <span class="hljs-comment">// spring&#x4E2D;&#x53EF;&#x4EE5;&#x4FEE;&#x6539;&#x9ED8;&#x8BA4;&#x7684;bean&#x547D;&#x540D;&#x65B9;&#x5F0F;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x770B;&#x7528;&#x6237;&#x6709;&#x6CA1;&#x6709;&#x81EA;&#x5B9A;&#x4E49;bean&#x547D;&#x540D;&#x65B9;&#x5F0F;&#xFF0C;&#x867D;&#x7136;&#x4E00;&#x822C;&#x6CA1;&#x6709;&#x4EBA;&#x4F1A;&#x8FD9;&#x4E48;&#x505A;</span>
            BeanNameGenerator generator = (BeanNameGenerator) sbr.getSingleton(CONFIGURATION_BEAN_NAME_GENERATOR);
            <span class="hljs-keyword">if</span> (generator != <span class="hljs-keyword">null</span>) {
                <span class="hljs-keyword">this</span>.componentScanBeanNameGenerator = generator;
                <span class="hljs-keyword">this</span>.importBeanNameGenerator = generator;
            }
        }
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.environment == <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">this</span>.environment = <span class="hljs-keyword">new</span> StandardEnvironment();
    }

    <span class="hljs-comment">// Parse each @Configuration class</span>
    ConfigurationClassParser parser = <span class="hljs-keyword">new</span> ConfigurationClassParser(
            <span class="hljs-keyword">this</span>.metadataReaderFactory, <span class="hljs-keyword">this</span>.problemReporter, <span class="hljs-keyword">this</span>.environment,
            <span class="hljs-keyword">this</span>.resourceLoader, <span class="hljs-keyword">this</span>.componentScanBeanNameGenerator, registry);

    Set&lt;BeanDefinitionHolder&gt; candidates = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(configCandidates);
    Set&lt;ConfigurationClass&gt; alreadyParsed = <span class="hljs-keyword">new</span> HashSet&lt;&gt;(configCandidates.size());
    do {
        <span class="hljs-comment">// &#x89E3;&#x6790;&#x914D;&#x7F6E;&#x7C7B;&#xFF08;&#x4F20;&#x7EDF;&#x610F;&#x4E49;&#x4E0A;&#x7684;&#x914D;&#x7F6E;&#x7C7B;&#x6216;&#x8005;&#x662F;&#x666E;&#x901A;bean&#xFF0C;&#x6838;&#x5FC3;&#x6765;&#x4E86;&#xFF09;</span>
        parser.parse(candidates);
        parser.validate();

        Set&lt;ConfigurationClass&gt; configClasses = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;(parser.getConfigurationClasses());
        configClasses.removeAll(alreadyParsed);

        <span class="hljs-comment">// Read the model and create bean definitions based on its content</span>
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.reader == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">this</span>.reader = <span class="hljs-keyword">new</span> ConfigurationClassBeanDefinitionReader(
                    registry, <span class="hljs-keyword">this</span>.sourceExtractor, <span class="hljs-keyword">this</span>.resourceLoader, <span class="hljs-keyword">this</span>.environment,
                    <span class="hljs-keyword">this</span>.importBeanNameGenerator, parser.getImportRegistry());
        }
        <span class="hljs-comment">// &#x76F4;&#x5230;&#x8FD9;&#x4E00;&#x6B65;&#x624D;&#x628A;Import&#x7684;&#x7C7B;&#xFF0C;@Bean @ImportRosource &#x8F6C;&#x6362;&#x6210;BeanDefinition</span>
        <span class="hljs-keyword">this</span>.reader.loadBeanDefinitions(configClasses);
        alreadyParsed.addAll(configClasses);<span class="hljs-comment">//&#x628A;configClasses&#x52A0;&#x5165;&#x5230;alreadyParsed&#xFF0C;&#x4EE3;&#x8868;</span>

        candidates.clear();
        <span class="hljs-comment">// &#x83B7;&#x5F97;&#x6CE8;&#x518C;&#x5668;&#x91CC;&#x9762;BeanDefinition&#x7684;&#x6570;&#x91CF; &#x548C; candidateNames&#x8FDB;&#x884C;&#x6BD4;&#x8F83;</span>
        <span class="hljs-comment">// &#x5982;&#x679C;&#x5927;&#x4E8E;&#x7684;&#x8BDD;&#xFF0C;&#x8BF4;&#x660E;&#x6709;&#x65B0;&#x7684;BeanDefinition&#x6CE8;&#x518C;&#x8FDB;&#x6765;&#x4E86;</span>
        <span class="hljs-keyword">if</span> (registry.getBeanDefinitionCount() &gt; candidateNames.length) {
            <span class="hljs-comment">// &#x4ECE;&#x6CE8;&#x518C;&#x5668;&#x91CC;&#x9762;&#x83B7;&#x5F97;BeanDefinitionNames</span>
            String[] newCandidateNames = registry.getBeanDefinitionNames();
            <span class="hljs-comment">// candidateNames&#x8F6C;&#x6362;set</span>
            Set&lt;String&gt; oldCandidateNames = <span class="hljs-keyword">new</span> HashSet&lt;&gt;(Arrays.asList(candidateNames));
            Set&lt;String&gt; alreadyParsedClasses = <span class="hljs-keyword">new</span> HashSet&lt;&gt;();
            <span class="hljs-comment">// &#x5FAA;&#x73AF;alreadyParsed&#x3002;&#x628A;&#x7C7B;&#x540D;&#x52A0;&#x5165;&#x5230;alreadyParsedClasses</span>
            <span class="hljs-keyword">for</span> (ConfigurationClass configurationClass : alreadyParsed) {
                alreadyParsedClasses.add(configurationClass.getMetadata().getClassName());
            }
            <span class="hljs-keyword">for</span> (String candidateName : newCandidateNames) {
                <span class="hljs-keyword">if</span> (!oldCandidateNames.contains(candidateName)) {
                    BeanDefinition bd = registry.getBeanDefinition(candidateName);
                    <span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bd, <span class="hljs-keyword">this</span>.metadataReaderFactory) &amp;&amp;
                            !alreadyParsedClasses.contains(bd.getBeanClassName())) {
                        candidates.add(<span class="hljs-keyword">new</span> BeanDefinitionHolder(bd, candidateName));
                    }
                }
            }
            candidateNames = newCandidateNames;
        }
    }
    <span class="hljs-keyword">while</span> (!candidates.isEmpty());

    <span class="hljs-comment">// Register the ImportRegistry as a bean in order to support ImportAware @Configuration classes</span>
    <span class="hljs-keyword">if</span> (sbr != <span class="hljs-keyword">null</span> &amp;&amp; !sbr.containsSingleton(IMPORT_REGISTRY_BEAN_NAME)) {
        sbr.registerSingleton(IMPORT_REGISTRY_BEAN_NAME, parser.getImportRegistry());
    }

    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.metadataReaderFactory <span class="hljs-keyword">instanceof</span> CachingMetadataReaderFactory) {
        <span class="hljs-comment">// Clear cache in externally provided MetadataReaderFactory; this is a no-op</span>
        <span class="hljs-comment">// for a shared cache since it&apos;ll be cleared by the ApplicationContext.</span>
        ((CachingMetadataReaderFactory) <span class="hljs-keyword">this</span>.metadataReaderFactory).clearCache();
    }
}
</code></pre>
<ul>
<li>&#x83B7;&#x5F97;&#x6240;&#x6709;&#x7684; BeanName&#xFF0C;&#x653E;&#x5165; candidateNames &#x6570;&#x7EC4;&#x3002;</li>
<li>&#x5FAA;&#x73AF; candidateNames &#x6570;&#x7EC4;&#xFF0C;&#x6839;&#x636E; beanName &#x83B7;&#x5F97; BeanDefinition&#xFF0C;&#x5224;&#x65AD;&#x6B64; BeanDefinition &#x662F;&#x5426;&#x5DF2;&#x7ECF;&#x88AB;&#x5904;&#x7406;&#x8FC7;&#x4E86;&#x3002;</li>
<li><p>&#x5224;&#x65AD;&#x662F;&#x5426;&#x662F;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x7684;&#x8BDD;&#x3002;&#x52A0;&#x5165;&#x5230; configCandidates &#x6570;&#x7EC4;&#xFF0C;&#x5728;&#x5224;&#x65AD;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x8FD8;&#x4F1A;&#x6807;&#x8BB0;&#x914D;&#x7F6E;&#x7C7B;&#x5C5E;&#x4E8E;Full&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x8FD8;&#x662F; Lite &#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x8FD9;&#x91CC;&#x4F1A;&#x5F15;&#x53D1;&#x4E00;&#x8FDE;&#x4E32;&#x7684;&#x77E5;&#x8BC6;&#x76F2;&#x70B9;&#xFF1A;</p>
<ul>
<li>&#x5F53;&#x6211;&#x4EEC;&#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EF;&#x4EE5;&#x4E0D;&#x52A0; @Configuration &#x6CE8;&#x89E3;&#xFF0C;&#x76F4;&#x63A5;&#x4F7F;&#x7528; @Component @ComponentScan @Import @ImportResource &#x7B49;&#x6CE8;&#x89E3;&#xFF0C;Spring &#x628A;&#x8FD9;&#x79CD;&#x914D;&#x7F6E;&#x7C7B;&#x79F0;&#x4E4B;&#x4E3A; Lite &#x914D;&#x7F6E;&#x7C7B;&#xFF0C; &#x5982;&#x679C;&#x52A0;&#x4E86; @Configuration &#x6CE8;&#x89E3;&#xFF0C;&#x5C31;&#x79F0;&#x4E4B;&#x4E3A;Full&#x914D;&#x7F6E;&#x7C7B;&#x3002;</li>
<li>&#x5982;&#x679C;&#x6211;&#x4EEC;&#x6CE8;&#x518C;&#x4E86; Lite &#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x6211;&#x4EEC; getBean &#x8FD9;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x5B83;&#x5C31;&#x662F;&#x539F;&#x672C;&#x7684;&#x90A3;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x5982;&#x679C;&#x6211;&#x4EEC;&#x6CE8;&#x518C;&#x4E86; Full &#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x6211;&#x4EEC; getBean &#x8FD9;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x5B83;&#x5DF2;&#x7ECF;&#x4E0D;&#x662F;&#x539F;&#x672C;&#x90A3;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#x4E86;&#xFF0C;&#x800C;&#x662F;&#x5DF2;&#x7ECF;&#x88AB; cgilb &#x4EE3;&#x7406;&#x7684;&#x7C7B;&#x4E86;&#x3002;</li>
<li>&#x5199;&#x4E00;&#x4E2A; A &#x7C7B;&#xFF0C;&#x5176;&#x4E2D;&#x6709;&#x4E00;&#x4E2A;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF0C;&#x6253;&#x5370;&#x51FA;&#x201C;&#x4F60;&#x597D;&#x201D;&#xFF0C;&#x518D;&#x5199;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x91CC;&#x9762;&#x6709;&#x4E24;&#x4E2A;&#x88AB; @bean &#x6CE8;&#x89E3;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x5176;&#x4E2D;&#x4E00;&#x4E2A;&#x65B9;&#x6CD5; new &#x4E86; A &#x7C7B;&#xFF0C;&#x5E76;&#x4E14;&#x8FD4;&#x56DE;A&#x7684;&#x5BF9;&#x8C61;&#xFF0C;&#x628A;&#x6B64;&#x65B9;&#x6CD5;&#x79F0;&#x4E4B;&#x4E3A; getA&#xFF0C;&#x7B2C;&#x4E8C;&#x4E2A;&#x65B9;&#x6CD5;&#x53C8;&#x8C03;&#x7528;&#x4E86; getA &#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C;&#x914D;&#x7F6E;&#x7C7B;&#x662F; Lite &#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x6253;&#x5370;&#x4E86;&#x4E24;&#x6B21;&#x201C;&#x4F60;&#x597D;&#x201D;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4; A &#x7C7B;&#x88AB; new &#x4E86;&#x4E24;&#x6B21;&#xFF0C;&#x5982;&#x679C;&#x914D;&#x7F6E;&#x7C7B;&#x662F;Full&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4F1A;&#x53D1;&#x73B0;&#x53EA;&#x6253;&#x5370;&#x4E86;&#x4E00;&#x6B21;&#x201C;&#x4F60;&#x597D;&#x201D;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x8BF4; A &#x7C7B;&#x53EA;&#x88AB; new &#x4E86;&#x4E00;&#x6B21;&#xFF0C;&#x56E0;&#x4E3A;&#x8FD9;&#x4E2A;&#x7C7B;&#x88AB; cgilb &#x4EE3;&#x7406;&#x4E86;&#xFF0C;&#x65B9;&#x6CD5;&#x5DF2;&#x7ECF;&#x88AB;&#x6539;&#x5199;&#x3002;</li>
</ul>
</li>
<li><p>&#x5982;&#x679C;&#x6CA1;&#x6709;&#x914D;&#x7F6E;&#x7C7B;&#x76F4;&#x63A5;&#x8FD4;&#x56DE;&#x3002;</p>
</li>
<li>&#x5904;&#x7406;&#x6392;&#x5E8F;&#x3002;</li>
<li>&#x89E3;&#x6790;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x53EF;&#x80FD;&#x662F; Full &#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x4E5F;&#x6709;&#x53EF;&#x80FD;&#x662F; Lite &#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x8FD9;&#x4E2A;&#x5C0F;&#x65B9;</li>
<li>&#x5728;&#x7B2C;6&#x6B65;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EA;&#x662F;&#x6CE8;&#x518C;&#x4E86;&#x90E8;&#x5206; Bean&#xFF0C;&#x50CF; @Import @Bean &#x7B49;&#xFF0C;&#x662F;&#x6CA1;&#x6709;&#x88AB;&#x6CE8;&#x518C;&#x7684;&#xFF0C;&#x8FD9;&#x91CC;&#x7EDF;&#x4E00;&#x5BF9;&#x8FD9;&#x4E9B;&#x8FDB;&#x884C;&#x6CE8;&#x518C;&#x3002;</li>
</ul>
<p>&#x4E0B;&#x9762;&#x662F;&#x89E3;&#x6790;&#x914D;&#x7F6E;&#x7C7B;&#x7684;&#x8FC7;&#x7A0B;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parse</span><span class="hljs-params">(Set&lt;BeanDefinitionHolder&gt; configCandidates)</span> </span>{
    <span class="hljs-keyword">this</span>.deferredImportSelectors = <span class="hljs-keyword">new</span> LinkedList&lt;&gt;();
    <span class="hljs-comment">// &#x5FAA;&#x73AF;&#x4F20;&#x8FDB;&#x6765;&#x7684;&#x914D;&#x7F6E;&#x7C7B;</span>
    <span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : configCandidates) {
        BeanDefinition bd = holder.getBeanDefinition();<span class="hljs-comment">//&#x83B7;&#x5F97;BeanDefinition</span>
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// &#x5982;&#x679C;&#x83B7;&#x5F97;BeanDefinition&#x662F;AnnotatedBeanDefinition&#x7684;&#x5B9E;&#x4F8B;</span>
            <span class="hljs-keyword">if</span> (bd <span class="hljs-keyword">instanceof</span> AnnotatedBeanDefinition) {
                parse(((AnnotatedBeanDefinition) bd).getMetadata(), holder.getBeanName());
            } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (bd <span class="hljs-keyword">instanceof</span> AbstractBeanDefinition &amp;&amp; ((AbstractBeanDefinition) bd).hasBeanClass()) {
                parse(((AbstractBeanDefinition) bd).getBeanClass(), holder.getBeanName());
            } <span class="hljs-keyword">else</span> {
                parse(bd.getBeanClassName(), holder.getBeanName());
            }
        } <span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) {
            <span class="hljs-keyword">throw</span> ex;
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(
                    <span class="hljs-string">&quot;Failed to parse configuration class [&quot;</span> + bd.getBeanClassName() + <span class="hljs-string">&quot;]&quot;</span>, ex);
        }
    }

    <span class="hljs-comment">// &#x6267;&#x884C;DeferredImportSelector</span>
    processDeferredImportSelectors();
}
</code></pre>
<p>&#x56E0;&#x4E3A;&#x53EF;&#x4EE5;&#x6709;&#x591A;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x5FAA;&#x73AF;&#x5904;&#x7406;&#x3002;&#x6211;&#x4EEC;&#x7684;&#x914D;&#x7F6E;&#x7C7B;&#x7684; BeanDefinition &#x662F; AnnotatedBeanDefinition &#x7684;&#x5B9E;&#x4F8B;&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x8FDB;&#x5165;&#x7B2C;&#x4E00;&#x4E2A; if&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> <span class="hljs-keyword">void</span> <span class="hljs-title">parse</span><span class="hljs-params">(AnnotationMetadata metadata, String beanName)</span> <span class="hljs-keyword">throws</span> IOException </span>{
    processConfigurationClass(<span class="hljs-keyword">new</span> ConfigurationClass(metadata, beanName));
}

<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processConfigurationClass</span><span class="hljs-params">(ConfigurationClass configClass)</span> <span class="hljs-keyword">throws</span> IOException </span>{

    <span class="hljs-comment">// &#x5224;&#x65AD;&#x662F;&#x5426;&#x9700;&#x8981;&#x8DF3;&#x8FC7;</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.conditionEvaluator.shouldSkip(configClass.getMetadata(), ConfigurationPhase.PARSE_CONFIGURATION)) {
        <span class="hljs-keyword">return</span>;
    }

    ConfigurationClass existingClass = <span class="hljs-keyword">this</span>.configurationClasses.get(configClass);
    <span class="hljs-keyword">if</span> (existingClass != <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">if</span> (configClass.isImported()) {
            <span class="hljs-keyword">if</span> (existingClass.isImported()) {
                existingClass.mergeImportedBy(configClass);
            }
            <span class="hljs-comment">// Otherwise ignore new imported config class; existing non-imported class overrides it.</span>
            <span class="hljs-keyword">return</span>;
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// Explicit bean definition found, probably replacing an import.</span>
            <span class="hljs-comment">// Let&apos;s remove the old one and go with the new one.</span>
            <span class="hljs-keyword">this</span>.configurationClasses.remove(configClass);
            <span class="hljs-keyword">this</span>.knownSuperclasses.values().removeIf(configClass::equals);
        }
    }

    <span class="hljs-comment">// Recursively process the configuration class and its superclass hierarchy.</span>
    SourceClass sourceClass = asSourceClass(configClass);
    do {
        sourceClass = doProcessConfigurationClass(configClass, sourceClass);
    }
    <span class="hljs-keyword">while</span> (sourceClass != <span class="hljs-keyword">null</span>);

    <span class="hljs-keyword">this</span>.configurationClasses.put(configClass, configClass);
}
</code></pre>
<p>&#x91CD;&#x70B9;&#x5728;&#x4E8E; doProcessConfigurationClass &#x65B9;&#x6CD5;&#xFF0C;&#x9700;&#x8981;&#x7279;&#x522B;&#x6CE8;&#x610F;&#xFF0C;&#x6700;&#x540E;&#x4E00;&#x884C;&#x4EE3;&#x7801;&#xFF0C;&#x4F1A;&#x628A; configClass &#x653E;&#x5165;&#x4E00;&#x4E2A; Map&#xFF0C;&#x4F1A;&#x5728;&#x4E0A;&#x9762;&#x7B2C;7&#x6B65;&#x4E2D;&#x7528;&#x5230;&#x3002;</p>
<p><img src="../source/images/ch-05/ioc-16.png" alt="ioc-16"></p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">final</span> SourceClass <span class="hljs-title">doProcessConfigurationClass</span><span class="hljs-params">(ConfigurationClass configClass, SourceClass sourceClass)</span>
            <span class="hljs-keyword">throws</span> IOException </span>{

    <span class="hljs-comment">// &#x9012;&#x5F52;&#x5904;&#x7406;&#x5185;&#x90E8;&#x7C7B;&#xFF0C;&#x4E00;&#x822C;&#x4E0D;&#x4F1A;&#x5199;&#x5185;&#x90E8;&#x7C7B;</span>
    <span class="hljs-comment">// Recursively process any member (nested) classes first</span>
    processMemberClasses(configClass, sourceClass);

    <span class="hljs-comment">// Process any @PropertySource annotations</span>
    <span class="hljs-comment">// &#x5904;&#x7406;@PropertySource&#x6CE8;&#x89E3;&#xFF0C;@PropertySource&#x6CE8;&#x89E3;&#x7528;&#x6765;&#x52A0;&#x8F7D;properties&#x6587;&#x4EF6;</span>
    <span class="hljs-keyword">for</span> (AnnotationAttributes propertySource : AnnotationConfigUtils.attributesForRepeatable(
            sourceClass.getMetadata(), PropertySources.class,
            org.springframework.context.annotation.PropertySource.class)) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.environment <span class="hljs-keyword">instanceof</span> ConfigurableEnvironment) {
            processPropertySource(propertySource);
        } <span class="hljs-keyword">else</span> {
            logger.warn(<span class="hljs-string">&quot;Ignoring @PropertySource annotation on [&quot;</span> + sourceClass.getMetadata().getClassName() +
                    <span class="hljs-string">&quot;]. Reason: Environment must implement ConfigurableEnvironment&quot;</span>);
        }
    }

    <span class="hljs-comment">// Process any @ComponentScan annotations</span>
    <span class="hljs-comment">// &#x83B7;&#x5F97;ComponentScan&#x6CE8;&#x89E3;&#x5177;&#x4F53;&#x7684;&#x5185;&#x5BB9;&#xFF0C;ComponentScan&#x6CE8;&#x89E3;&#x9664;&#x4E86;&#x6700;&#x5E38;&#x7528;&#x7684;basePackage&#x4E4B;&#x5916;&#xFF0C;&#x8FD8;&#x6709;includeFilters&#xFF0C;excludeFilters&#x7B49;</span>
    Set&lt;AnnotationAttributes&gt; componentScans = AnnotationConfigUtils.attributesForRepeatable(
            sourceClass.getMetadata(), ComponentScans.class, ComponentScan.class);

    <span class="hljs-comment">// &#x5982;&#x679C;&#x6CA1;&#x6709;&#x6253;&#x4E0A;ComponentScan&#xFF0C;&#x6216;&#x8005;&#x88AB;@Condition&#x6761;&#x4EF6;&#x8DF3;&#x8FC7;&#xFF0C;&#x5C31;&#x4E0D;&#x518D;&#x8FDB;&#x5165;&#x8FD9;&#x4E2A;if</span>
    <span class="hljs-keyword">if</span> (!componentScans.isEmpty() &amp;&amp;
            !<span class="hljs-keyword">this</span>.conditionEvaluator.shouldSkip(sourceClass.getMetadata(), ConfigurationPhase.REGISTER_BEAN)) {
        <span class="hljs-comment">// &#x5FAA;&#x73AF;&#x5904;&#x7406;componentScans</span>
        <span class="hljs-keyword">for</span> (AnnotationAttributes componentScan : componentScans) {
            <span class="hljs-comment">// The config class is annotated with @ComponentScan -&gt; perform the scan immediately</span>
            <span class="hljs-comment">// componentScan&#x5C31;&#x662F;@ComponentScan&#x4E0A;&#x7684;&#x5177;&#x4F53;&#x5185;&#x5BB9;&#xFF0C;sourceClass.getMetadata().getClassName()&#x5C31;&#x662F;&#x914D;&#x7F6E;&#x7C7B;&#x7684;&#x540D;&#x79F0;</span>
            Set&lt;BeanDefinitionHolder&gt; scannedBeanDefinitions =
                    <span class="hljs-keyword">this</span>.componentScanParser.parse(componentScan, sourceClass.getMetadata().getClassName());
            <span class="hljs-comment">// Check the set of scanned definitions for any further config classes and parse recursively if needed</span>
            <span class="hljs-keyword">for</span> (BeanDefinitionHolder holder : scannedBeanDefinitions) {
                BeanDefinition bdCand = holder.getBeanDefinition().getOriginatingBeanDefinition();
                <span class="hljs-keyword">if</span> (bdCand == <span class="hljs-keyword">null</span>) {
                    bdCand = holder.getBeanDefinition();
                }
                <span class="hljs-keyword">if</span> (ConfigurationClassUtils.checkConfigurationClassCandidate(bdCand, <span class="hljs-keyword">this</span>.metadataReaderFactory)) {
                    <span class="hljs-comment">// &#x9012;&#x5F52;&#x8C03;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x53EF;&#x80FD;&#x7EC4;&#x4EF6;&#x7C7B;&#x6709;&#x88AB;@Bean&#x6807;&#x8BB0;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x6216;&#x8005;&#x7EC4;&#x4EF6;&#x7C7B;&#x672C;&#x8EAB;&#x4E5F;&#x6709;ComponentScan&#x7B49;&#x6CE8;&#x89E3;</span>
                    parse(bdCand.getBeanClassName(), holder.getBeanName());
                }
            }
        }
    }

    <span class="hljs-comment">// Process any @Import annotations</span>
    <span class="hljs-comment">// &#x5904;&#x7406;@Import&#x6CE8;&#x89E3;</span>
    <span class="hljs-comment">// @Import&#x6CE8;&#x89E3;&#x662F;spring&#x4E2D;&#x5F88;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x4E2A;&#x6CE8;&#x89E3;&#xFF0C;Springboot&#x5927;&#x91CF;&#x5E94;&#x7528;&#x8FD9;&#x4E2A;&#x6CE8;&#x89E3;</span>
    <span class="hljs-comment">// @Import&#x4E09;&#x79CD;&#x7C7B;&#xFF0C;&#x4E00;&#x79CD;&#x662F;Import&#x666E;&#x901A;&#x7C7B;&#xFF0C;&#x4E00;&#x79CD;&#x662F;Import ImportSelector&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x79CD;&#x662F;Import ImportBeanDefinitionRegistrar</span>
    <span class="hljs-comment">// getImports(sourceClass)&#x662F;&#x83B7;&#x5F97;import&#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x8FD4;&#x56DE;&#x7684;&#x662F;&#x4E00;&#x4E2A;set</span>
    processImports(configClass, sourceClass, getImports(sourceClass), <span class="hljs-keyword">true</span>);

    <span class="hljs-comment">// Process any @ImportResource annotations</span>
    <span class="hljs-comment">// &#x5904;&#x7406;@ImportResource&#x6CE8;&#x89E3;</span>
    AnnotationAttributes importResource =
            AnnotationConfigUtils.attributesFor(sourceClass.getMetadata(), ImportResource.class);
    <span class="hljs-keyword">if</span> (importResource != <span class="hljs-keyword">null</span>) {
        String[] resources = importResource.getStringArray(<span class="hljs-string">&quot;locations&quot;</span>);
        Class&lt;? extends BeanDefinitionReader&gt; readerClass = importResource.getClass(<span class="hljs-string">&quot;reader&quot;</span>);
        <span class="hljs-keyword">for</span> (String resource : resources) {
            String resolvedResource = <span class="hljs-keyword">this</span>.environment.resolveRequiredPlaceholders(resource);
            configClass.addImportedResource(resolvedResource, readerClass);
        }
    }

    <span class="hljs-comment">// &#x5904;&#x7406;@Bean&#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x83B7;&#x5F97;&#x4E86;&#x5E26;&#x6709;@Bean&#x7684;&#x65B9;&#x6CD5;&#x540E;&#xFF0C;&#x4E0D;&#x662F;&#x9A6C;&#x4E0A;&#x8F6C;&#x6362;&#x6210;BeanDefinition&#xFF0C;&#x800C;&#x662F;&#x5148;&#x7528;&#x4E00;&#x4E2A;set&#x63A5;&#x6536;</span>
    <span class="hljs-comment">// Process individual @Bean methods</span>
    Set&lt;MethodMetadata&gt; beanMethods = retrieveBeanMethodMetadata(sourceClass);
    <span class="hljs-keyword">for</span> (MethodMetadata methodMetadata : beanMethods) {
        configClass.addBeanMethod(<span class="hljs-keyword">new</span> BeanMethod(methodMetadata, configClass));
    }

    <span class="hljs-comment">// Process default methods on interfaces</span>
    processInterfaces(configClass, sourceClass);

    <span class="hljs-comment">// Process superclass, if any</span>
    <span class="hljs-keyword">if</span> (sourceClass.getMetadata().hasSuperClass()) {
        String superclass = sourceClass.getMetadata().getSuperClassName();
        <span class="hljs-keyword">if</span> (superclass != <span class="hljs-keyword">null</span> &amp;&amp; !superclass.startsWith(<span class="hljs-string">&quot;java&quot;</span>) &amp;&amp;
                !<span class="hljs-keyword">this</span>.knownSuperclasses.containsKey(superclass)) {
            <span class="hljs-keyword">this</span>.knownSuperclasses.put(superclass, configClass);
            <span class="hljs-comment">// Superclass found, return its annotation metadata and recurse</span>
            <span class="hljs-keyword">return</span> sourceClass.getSuperClass();
        }
    }

    <span class="hljs-comment">// No superclass -&gt; processing is complete</span>
    <span class="hljs-keyword">return</span> <span class="hljs-keyword">null</span>;
}
</code></pre>
<ul>
<li>&#x9012;&#x5F52;&#x5904;&#x7406;&#x5185;&#x90E8;&#x7C7B;&#xFF0C;&#x4E00;&#x822C;&#x4E0D;&#x4F1A;&#x4F7F;&#x7528;&#x5185;&#x90E8;&#x7C7B;&#x3002;</li>
<li>&#x5904;&#x7406; @PropertySource &#x6CE8;&#x89E3;&#xFF0C;@PropertySource &#x6CE8;&#x89E3;&#x7528;&#x6765;&#x52A0;&#x8F7D; properties &#x6587;&#x4EF6;&#x3002;</li>
<li>&#x83B7;&#x5F97; ComponentScan &#x6CE8;&#x89E3;&#x5177;&#x4F53;&#x7684;&#x5185;&#x5BB9;&#xFF0C;ComponentScan &#x6CE8;&#x89E3;&#x9664;&#x4E86;&#x6700;&#x5E38;&#x7528;&#x7684; basePackage &#x4E4B;&#x5916;&#xFF0C;&#x8FD8;&#x6709;includeFilters&#xFF0C;excludeFilters &#x7B49;&#x3002;</li>
<li><p>&#x5224;&#x65AD;&#x6709;&#x6CA1;&#x6709;&#x88AB; @ComponentScans &#x6807;&#x8BB0;&#xFF0C;&#x6216;&#x8005;&#x88AB; @Condition &#x6761;&#x4EF6;&#x5E26;&#x8FC7;&#xFF0C;&#x5982;&#x679C;&#x6EE1;&#x8DB3;&#x6761;&#x4EF6;&#x7684;&#x8BDD;&#xFF0C;&#x8FDB;&#x5165; if&#xFF0C;&#x8FDB;&#x884C;&#x5982;&#x4E0B;&#x64CD;&#x4F5C;&#xFF1A;</p>
<ul>
<li>&#x6267;&#x884C;&#x626B;&#x63CF;&#x64CD;&#x4F5C;&#xFF0C;&#x628A;&#x626B;&#x63CF;&#x51FA;&#x6765;&#x7684;&#x653E;&#x5165; set&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7A0D;&#x540E;&#x518D;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#x3002;</li>
<li>&#x5FAA;&#x73AF; set&#xFF0C;&#x5224;&#x65AD;&#x662F;&#x5426;&#x662F;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x662F;&#x7684;&#x8BDD;&#xFF0C;&#x9012;&#x5F52;&#x8C03;&#x7528; parse &#x65B9;&#x6CD5;&#xFF0C;&#x56E0;&#x4E3A;&#x88AB;&#x626B;&#x63CF;&#x51FA;&#x6765;&#x7684;&#x7C7B;&#xFF0C;&#x8FD8;&#x662F;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x6709; @ComponentScans &#x6CE8;&#x89E3;&#xFF0C;&#x6216;&#x8005;&#x5176;&#x4E2D;&#x6709;&#x88AB; @Bean &#x6807;&#x8BB0;&#x7684;&#x65B9;&#x6CD5; &#x7B49;&#x7B49;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x518D;&#x6B21;&#x88AB;&#x89E3;&#x6790;&#x3002;</li>
</ul>
</li>
<li><p>&#x5904;&#x7406; @Import &#x6CE8;&#x89E3;&#xFF0C;@Import &#x662F; Spring &#x4E2D;&#x5F88;&#x91CD;&#x8981;&#x7684;&#x4E00;&#x4E2A;&#x6CE8;&#x89E3;&#xFF0C;&#x6B63;&#x662F;&#x7531;&#x4E8E;&#x5B83;&#x7684;&#x5B58;&#x5728;&#xFF0C;&#x8BA9; Spring &#x975E;&#x5E38;&#x7075;&#x6D3B;&#xFF0C;&#x4E0D;&#x7BA1;&#x662F; Spring &#x5185;&#x90E8;&#xFF0C;&#x8FD8;&#x662F;&#x4E0E; Spring &#x6574;&#x5408;&#x7684;&#x7B2C;&#x4E09;&#x65B9;&#x6280;&#x672F;&#xFF0C;&#x90FD;&#x5927;&#x91CF;&#x7684;&#x8FD0;&#x7528;&#x4E86; @Import &#x6CE8;&#x89E3;&#xFF0C;@Import &#x6709;&#x4E09;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;&#x4E00;&#x79CD;&#x662F; Import &#x666E;&#x901A;&#x7C7B;&#xFF0C;&#x4E00;&#x79CD;&#x662F; Import ImportSelector&#xFF0C;&#x8FD8;&#x6709;&#x4E00;&#x79CD;&#x662F; Import ImportBeanDefinitionRegistrar&#xFF0C;getImports(sourceClass) &#x662F;&#x83B7;&#x5F97; import &#x7684;&#x5185;&#x5BB9;&#xFF0C;&#x8FD4;&#x56DE;&#x7684;&#x662F;&#x4E00;&#x4E2A; set&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x7A0D;&#x540E;&#x518D;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#x3002;</p>
</li>
<li>&#x5904;&#x7406; @ImportResource &#x6CE8;&#x89E3;&#x3002;</li>
<li>&#x5904;&#x7406; @Bean &#x7684;&#x65B9;&#x6CD5;&#xFF0C;&#x53EF;&#x4EE5;&#x770B;&#x5230;&#x83B7;&#x5F97;&#x4E86;&#x5E26;&#x6709; @Bean &#x7684;&#x65B9;&#x6CD5;&#x540E;&#xFF0C;&#x4E0D;&#x662F;&#x9A6C;&#x4E0A;&#x8F6C;&#x6362;&#x6210; BeanDefinition&#xFF0C;&#x800C;&#x662F;&#x5148;&#x7528;&#x4E00;&#x4E2A; set &#x63A5;&#x6536;&#x3002;</li>
</ul>
<p>&#x6211;&#x4EEC;&#x5148;&#x6765;&#x770B;4.1&#x4E2D;&#x7684;&#x90A3;&#x4E2A;&#x65B9;&#x6CD5;&#xFF1A;</p>
<p><img src="../source/images/ch-05/ioc-17.png" alt="ioc-17"></p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title">parse</span><span class="hljs-params">(AnnotationAttributes componentScan, <span class="hljs-keyword">final</span> String declaringClass)</span> </span>{
    <span class="hljs-comment">// &#x626B;&#x63CF;&#x5668;&#xFF0C;&#x8FD8;&#x8BB0;&#x4E0D;&#x8BB0;&#x5728;new AnnotationConfigApplicationContext&#x7684;&#x65F6;&#x5019;</span>
    <span class="hljs-comment">// &#x4F1A;&#x8C03;&#x7528;AnnotationConfigApplicationContext&#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;</span>
    <span class="hljs-comment">// &#x6784;&#x9020;&#x65B9;&#x6CD5;&#x91CC;&#x9762;&#x6709;&#x4E00;&#x53E5; this.scanner = new ClassPathBeanDefinitionScanner(this);</span>
    <span class="hljs-comment">// &#x5F53;&#x65F6;&#x8BF4;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x4E0D;&#x91CD;&#x8981;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x8BC1;&#x660E;&#x4E86;&#x3002;&#x5E38;&#x89C4;&#x7528;&#x6CD5;&#x4E2D;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x6267;&#x884C;&#x626B;&#x63CF;&#x7684;&#x53EA;&#x4F1A;&#x662F;&#x8FD9;&#x91CC;&#x7684;scanner&#x5BF9;&#x8C61;</span>
    ClassPathBeanDefinitionScanner scanner = <span class="hljs-keyword">new</span> ClassPathBeanDefinitionScanner(<span class="hljs-keyword">this</span>.registry,
            componentScan.getBoolean(<span class="hljs-string">&quot;useDefaultFilters&quot;</span>), <span class="hljs-keyword">this</span>.environment, <span class="hljs-keyword">this</span>.resourceLoader);

    <span class="hljs-comment">// &#x5224;&#x65AD;&#x662F;&#x5426;&#x91CD;&#x5199;&#x4E86;&#x9ED8;&#x8BA4;&#x7684;&#x547D;&#x540D;&#x89C4;&#x5219;</span>
    Class&lt;? extends BeanNameGenerator&gt; generatorClass = componentScan.getClass(<span class="hljs-string">&quot;nameGenerator&quot;</span>);
    <span class="hljs-keyword">boolean</span> useInheritedGenerator = (BeanNameGenerator.class == generatorClass);
    scanner.setBeanNameGenerator(useInheritedGenerator ? <span class="hljs-keyword">this</span>.beanNameGenerator :
            BeanUtils.instantiateClass(generatorClass));

    ScopedProxyMode scopedProxyMode = componentScan.getEnum(<span class="hljs-string">&quot;scopedProxy&quot;</span>);
    <span class="hljs-keyword">if</span> (scopedProxyMode != ScopedProxyMode.DEFAULT) {
        scanner.setScopedProxyMode(scopedProxyMode);
    }
    <span class="hljs-keyword">else</span> {
        Class&lt;? extends ScopeMetadataResolver&gt; resolverClass = componentScan.getClass(<span class="hljs-string">&quot;scopeResolver&quot;</span>);
        scanner.setScopeMetadataResolver(BeanUtils.instantiateClass(resolverClass));
    }

    scanner.setResourcePattern(componentScan.getString(<span class="hljs-string">&quot;resourcePattern&quot;</span>));

    <span class="hljs-comment">// addIncludeFilter addExcludeFilter,&#x6700;&#x7EC8;&#x662F;&#x5F80;List&lt;TypeFilter&gt;&#x91CC;&#x9762;&#x586B;&#x5145;&#x6570;&#x636E;</span>
    <span class="hljs-comment">// TypeFilter&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x5F0F;&#x63A5;&#x53E3;&#xFF0C;&#x51FD;&#x6570;&#x5F0F;&#x63A5;&#x53E3;&#x5728;java8&#x7684;&#x65F6;&#x5019;&#x5927;&#x653E;&#x5F02;&#x5F69;&#xFF0C;&#x53EA;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x865A;&#x65B9;&#x6CD5;&#x7684;&#x63A5;&#x53E3;&#x88AB;&#x79F0;&#x4E3A;&#x51FD;&#x6570;&#x5F0F;&#x63A5;&#x53E3;</span>
    <span class="hljs-comment">// &#x5F53;&#x8C03;&#x7528;scanner.addIncludeFilter  scanner.addExcludeFilter &#x4EC5;&#x4EC5;&#x628A; &#x5B9A;&#x4E49;&#x7684;&#x89C4;&#x5219;&#x585E;&#x8FDB;&#x53BB;&#xFF0C;&#x5E76;&#x4E48;&#x6709;&#x771F;&#x6B63;&#x53BB;&#x6267;&#x884C;&#x5339;&#x914D;&#x8FC7;&#x7A0B;</span>

    <span class="hljs-comment">// &#x5904;&#x7406;includeFilters</span>
    <span class="hljs-keyword">for</span> (AnnotationAttributes filter : componentScan.getAnnotationArray(<span class="hljs-string">&quot;includeFilters&quot;</span>)) {
        <span class="hljs-keyword">for</span> (TypeFilter typeFilter : typeFiltersFor(filter)) {
            scanner.addIncludeFilter(typeFilter);
        }
    }

    <span class="hljs-comment">// &#x5904;&#x7406;excludeFilters</span>
    <span class="hljs-keyword">for</span> (AnnotationAttributes filter : componentScan.getAnnotationArray(<span class="hljs-string">&quot;excludeFilters&quot;</span>)) {
        <span class="hljs-keyword">for</span> (TypeFilter typeFilter : typeFiltersFor(filter)) {
            scanner.addExcludeFilter(typeFilter);
        }
    }

    <span class="hljs-keyword">boolean</span> lazyInit = componentScan.getBoolean(<span class="hljs-string">&quot;lazyInit&quot;</span>);
    <span class="hljs-keyword">if</span> (lazyInit) {
        scanner.getBeanDefinitionDefaults().setLazyInit(<span class="hljs-keyword">true</span>);
    }

    Set&lt;String&gt; basePackages = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();
    String[] basePackagesArray = componentScan.getStringArray(<span class="hljs-string">&quot;basePackages&quot;</span>);
    <span class="hljs-keyword">for</span> (String pkg : basePackagesArray) {
        String[] tokenized = StringUtils.tokenizeToStringArray(<span class="hljs-keyword">this</span>.environment.resolvePlaceholders(pkg),
                ConfigurableApplicationContext.CONFIG_LOCATION_DELIMITERS);
        Collections.addAll(basePackages, tokenized);
    }
    <span class="hljs-comment">// &#x4ECE;&#x4E0B;&#x9762;&#x7684;&#x4EE3;&#x7801;&#x53EF;&#x4EE5;&#x770B;&#x51FA;ComponentScans&#x6307;&#x5B9A;&#x626B;&#x63CF;&#x76EE;&#x6807;&#xFF0C;&#x9664;&#x4E86;&#x6700;&#x5E38;&#x7528;&#x7684;basePackages&#xFF0C;&#x8FD8;&#x6709;&#x4E24;&#x79CD;&#x65B9;&#x5F0F;</span>
    <span class="hljs-comment">// 1.&#x6307;&#x5B9A;basePackageClasses&#xFF0C;&#x5C31;&#x662F;&#x6307;&#x5B9A;&#x591A;&#x4E2A;&#x7C7B;&#xFF0C;&#x53EA;&#x8981;&#x662F;&#x4E0E;&#x8FD9;&#x51E0;&#x4E2A;&#x7C7B;&#x540C;&#x7EA7;&#x7684;&#xFF0C;&#x6216;&#x8005;&#x5728;&#x8FD9;&#x51E0;&#x4E2A;&#x7C7B;&#x4E0B;&#x7EA7;&#x7684;&#x90FD;&#x53EF;&#x4EE5;&#x88AB;&#x626B;&#x63CF;&#x5230;&#xFF0C;&#x8FD9;&#x79CD;&#x65B9;&#x5F0F;&#x5176;&#x5B9E;&#x662F;spring&#x6BD4;&#x8F83;&#x63A8;&#x8350;&#x7684;</span>
    <span class="hljs-comment">// &#x56E0;&#x4E3A;&#x6307;&#x5B9A;basePackages&#x6CA1;&#x6709;IDE&#x7684;&#x68C0;&#x67E5;&#xFF0C;&#x5BB9;&#x6613;&#x51FA;&#x9519;&#xFF0C;&#x4F46;&#x662F;&#x6307;&#x5B9A;&#x4E00;&#x4E2A;&#x7C7B;&#xFF0C;&#x5C31;&#x6709;IDE&#x7684;&#x68C0;&#x67E5;&#x4E86;&#xFF0C;&#x4E0D;&#x5BB9;&#x6613;&#x51FA;&#x9519;&#xFF0C;&#x7ECF;&#x5E38;&#x4F1A;&#x7528;&#x4E00;&#x4E2A;&#x7A7A;&#x7684;&#x7C7B;&#x6765;&#x4F5C;&#x4E3A;basePackageClasses</span>
    <span class="hljs-comment">// 2.&#x76F4;&#x63A5;&#x4E0D;&#x6307;&#x5B9A;&#xFF0C;&#x9ED8;&#x8BA4;&#x4F1A;&#x628A;&#x4E0E;&#x914D;&#x7F6E;&#x7C7B;&#x540C;&#x7EA7;&#xFF0C;&#x6216;&#x8005;&#x5728;&#x914D;&#x7F6E;&#x7C7B;&#x4E0B;&#x7EA7;&#x7684;&#x4F5C;&#x4E3A;&#x626B;&#x63CF;&#x76EE;&#x6807;</span>
    <span class="hljs-keyword">for</span> (Class&lt;?&gt; clazz : componentScan.getClassArray(<span class="hljs-string">&quot;basePackageClasses&quot;</span>)) {
        basePackages.add(ClassUtils.getPackageName(clazz));
    }
    <span class="hljs-keyword">if</span> (basePackages.isEmpty()) {
        basePackages.add(ClassUtils.getPackageName(declaringClass));
    }

    <span class="hljs-comment">// &#x628A;&#x89C4;&#x5219;&#x586B;&#x5145;&#x5230;&#x6392;&#x9664;&#x89C4;&#x5219;&#xFF1A;List&lt;TypeFilter&gt;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x628A; &#x6CE8;&#x518C;&#x7C7B;&#x81EA;&#x8EAB;&#x5F53;&#x4F5C;&#x6392;&#x9664;&#x89C4;&#x5219;&#xFF0C;&#x771F;&#x6B63;&#x6267;&#x884C;&#x5339;&#x914D;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x628A;&#x81EA;&#x8EAB;&#x7ED9;&#x6392;&#x9664;</span>
    scanner.addExcludeFilter(<span class="hljs-keyword">new</span> AbstractTypeHierarchyTraversingFilter(<span class="hljs-keyword">false</span>, <span class="hljs-keyword">false</span>) {
        <span class="hljs-meta">@Override</span>
        <span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">boolean</span> <span class="hljs-title">matchClassName</span><span class="hljs-params">(String className)</span> </span>{
            <span class="hljs-keyword">return</span> declaringClass.equals(className);
        }
    });
    <span class="hljs-comment">// basePackages&#x662F;&#x4E00;&#x4E2A;LinkedHashSet&lt;String&gt;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x628A;basePackages&#x8F6C;&#x4E3A;&#x5B57;&#x7B26;&#x4E32;&#x6570;&#x7EC4;&#x7684;&#x5F62;&#x5F0F;</span>
    <span class="hljs-keyword">return</span> scanner.doScan(StringUtils.toStringArray(basePackages));
}
</code></pre>
<ul>
<li>&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x626B;&#x63CF;&#x5668; scanner&#xFF0C;&#x8FD8;&#x8BB0;&#x4E0D;&#x8BB0;&#x5728; new AnnotationConfigApplicationContext &#x7684;&#x65F6;&#x5019;&#xFF0C;&#x4F1A;&#x8C03;&#x7528;AnnotationConfigApplicationContext &#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#xFF0C;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x91CC;&#x9762;&#x6709;&#x4E00;&#x53E5; <code>this.scanner = new ClassPathBeanDefinitionScanner(this);</code> &#x5F53;&#x65F6;&#x8BF4;&#x8FD9;&#x4E2A;&#x5BF9;&#x8C61;&#x4E0D;&#x91CD;&#x8981;&#xFF0C;&#x8FD9;&#x91CC;&#x5C31;&#x662F;&#x8BC1;&#x660E;&#x4E86;&#x3002;&#x5E38;&#x89C4;&#x7528;&#x6CD5;&#x4E2D;&#xFF0C;&#x5B9E;&#x9645;&#x4E0A;&#x6267;&#x884C;&#x626B;&#x63CF;&#x7684;&#x53EA;&#x4F1A;&#x662F;&#x8FD9;&#x91CC;&#x7684;scanner&#x5BF9;&#x8C61;&#x3002;</li>
<li>&#x5904;&#x7406; includeFilters&#xFF0C;&#x5C31;&#x662F;&#x628A;&#x89C4;&#x5219;&#x6DFB;&#x52A0;&#x5230; scanner&#x3002;</li>
<li>&#x5904;&#x7406; excludeFilters&#xFF0C;&#x5C31;&#x662F;&#x628A;&#x89C4;&#x5219;&#x6DFB;&#x52A0;&#x5230; scanner&#x3002;</li>
<li>&#x89E3;&#x6790; basePackages&#xFF0C;&#x83B7;&#x5F97;&#x9700;&#x8981;&#x626B;&#x63CF;&#x54EA;&#x4E9B;&#x5305;&#x3002;</li>
<li>&#x6DFB;&#x52A0;&#x4E00;&#x4E2A;&#x9ED8;&#x8BA4;&#x7684;&#x6392;&#x9664;&#x89C4;&#x5219;&#xFF1A;&#x6392;&#x9664;&#x81EA;&#x8EAB;&#x3002;</li>
<li>&#x6267;&#x884C;&#x626B;&#x63CF;&#xFF0C;&#x7A0D;&#x540E;&#x8BE6;&#x7EC6;&#x8BF4;&#x660E;&#x3002;</li>
</ul>
<p>&#x8FD9;&#x91CC;&#x9700;&#x8981;&#x505A;&#x4E00;&#x4E2A;&#x8865;&#x5145;&#x8BF4;&#x660E;&#xFF0C;&#x6DFB;&#x52A0;&#x89C4;&#x5219;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x53EA;&#x662F;&#x628A;&#x5177;&#x4F53;&#x7684;&#x89C4;&#x5219;&#x653E;&#x5165;&#x89C4;&#x5219;&#x7C7B;&#x7684;&#x96C6;&#x5408;&#x4E2D;&#x53BB;&#xFF0C;&#x89C4;&#x5219;&#x7C7B;&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x5F0F;&#x63A5;&#x53E3;&#xFF0C;&#x53EA;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A;&#x865A;&#x65B9;&#x6CD5;&#x7684;&#x63A5;&#x53E3;&#x88AB;&#x79F0;&#x4E3A;&#x51FD;&#x6570;&#x5F0F;&#x63A5;&#x53E3;&#xFF0C;&#x51FD;&#x6570;&#x5F0F;&#x63A5;&#x53E3;&#x5728; java8 &#x7684;&#x65F6;&#x5019;&#x5927;&#x653E;&#x5F02;&#x5F69;&#xFF0C;&#x8FD9;&#x91CC;&#x53EA;&#x662F;&#x628A;&#x89C4;&#x5219;&#x65B9;&#x585E;&#x8FDB;&#x53BB;&#xFF0C;&#x5E76;&#x6CA1;&#x6709;&#x771F;&#x6B63;&#x6267;&#x884C;&#x5339;&#x914D;&#x89C4;&#x5219;&#x3002;</p>
<p>&#x6211;&#x4EEC;&#x6765;&#x770B;&#x770B;&#x5230;&#x5E95;&#x662F;&#x600E;&#x4E48;&#x6267;&#x884C;&#x626B;&#x63CF;&#x7684;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">protected</span> Set&lt;BeanDefinitionHolder&gt; <span class="hljs-title">doScan</span><span class="hljs-params">(String... basePackages)</span> </span>{
    Assert.notEmpty(basePackages, <span class="hljs-string">&quot;At least one base package must be specified&quot;</span>);
    Set&lt;BeanDefinitionHolder&gt; beanDefinitions = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();
    <span class="hljs-comment">// &#x5FAA;&#x73AF;&#x5904;&#x7406;basePackages</span>
    <span class="hljs-keyword">for</span> (String basePackage : basePackages) {
        <span class="hljs-comment">// &#x6839;&#x636E;&#x5305;&#x540D;&#x627E;&#x5230;&#x7B26;&#x5408;&#x6761;&#x4EF6;&#x7684;BeanDefinition&#x96C6;&#x5408;</span>
        Set&lt;BeanDefinition&gt; candidates = findCandidateComponents(basePackage);
        <span class="hljs-keyword">for</span> (BeanDefinition candidate : candidates) {
            ScopeMetadata scopeMetadata = <span class="hljs-keyword">this</span>.scopeMetadataResolver.resolveScopeMetadata(candidate);
            candidate.setScope(scopeMetadata.getScopeName());
            String beanName = <span class="hljs-keyword">this</span>.beanNameGenerator.generateBeanName(candidate, <span class="hljs-keyword">this</span>.registry);
            <span class="hljs-comment">//&#x7531;findCandidateComponents&#x5185;&#x90E8;&#x53EF;&#x77E5;&#xFF0C;&#x8FD9;&#x91CC;&#x7684;candidate&#x662F;ScannedGenericBeanDefinition</span>
            <span class="hljs-comment">// &#x800C;ScannedGenericBeanDefinition&#x662F;AbstractBeanDefinition&#x548C;AnnotatedBeanDefinition&#x7684;&#x4E4B;&#x7C7B;</span>
            <span class="hljs-comment">// &#x6240;&#x4EE5;&#x4E0B;&#x9762;&#x7684;&#x4E24;&#x4E2A;if&#x90FD;&#x4F1A;&#x8FDB;&#x5165;</span>
            <span class="hljs-keyword">if</span> (candidate <span class="hljs-keyword">instanceof</span> AbstractBeanDefinition) {
                <span class="hljs-comment">// &#x5185;&#x90E8;&#x4F1A;&#x8BBE;&#x7F6E;&#x9ED8;&#x8BA4;&#x503C;</span>
                postProcessBeanDefinition((AbstractBeanDefinition) candidate, beanName);
            }
            <span class="hljs-keyword">if</span> (candidate <span class="hljs-keyword">instanceof</span> AnnotatedBeanDefinition) {
                <span class="hljs-comment">// &#x5982;&#x679C;&#x662F;AnnotatedBeanDefinition&#xFF0C;&#x8FD8;&#x4F1A;&#x518D;&#x8BBE;&#x7F6E;&#x4E00;&#x6B21;&#x503C;</span>
                AnnotationConfigUtils.processCommonDefinitionAnnotations((AnnotatedBeanDefinition) candidate);
            }
            <span class="hljs-keyword">if</span> (checkCandidate(beanName, candidate)) {
                BeanDefinitionHolder definitionHolder = <span class="hljs-keyword">new</span> BeanDefinitionHolder(candidate, beanName);
                definitionHolder =
                        AnnotationConfigUtils.applyScopedProxyMode(scopeMetadata, definitionHolder, <span class="hljs-keyword">this</span>.registry);
                beanDefinitions.add(definitionHolder);
                registerBeanDefinition(definitionHolder, <span class="hljs-keyword">this</span>.registry);
            }
        }
    }
    <span class="hljs-keyword">return</span> beanDefinitions;
}
</code></pre>
<p>&#x56E0;&#x4E3A;basePackages&#x53EF;&#x80FD;&#x6709;&#x591A;&#x4E2A;&#xFF0C;&#x6240;&#x4EE5;&#x9700;&#x8981;&#x5FAA;&#x73AF;&#x5904;&#x7406;&#xFF0C;&#x6700;&#x7EC8;&#x4F1A;&#x8FDB;&#x884C;Bean&#x7684;&#x6CE8;&#x518C;&#x3002;&#x4E0B;&#x9762;&#x518D;&#x6765;&#x770B;&#x770B; findCandidateComponents &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> Set&lt;BeanDefinition&gt; <span class="hljs-title">findCandidateComponents</span><span class="hljs-params">(String basePackage)</span> </span>{
    <span class="hljs-comment">// spring&#x652F;&#x6301;component&#x7D22;&#x5F15;&#x6280;&#x672F;&#xFF0C;&#x9700;&#x8981;&#x5F15;&#x5165;&#x4E00;&#x4E2A;&#x7EC4;&#x4EF6;&#xFF0C;&#x56E0;&#x4E3A;&#x5927;&#x90E8;&#x5206;&#x60C5;&#x51B5;&#x4E0D;&#x4F1A;&#x5F15;&#x5165;&#x8FD9;&#x4E2A;&#x7EC4;&#x4EF6;</span>
    <span class="hljs-comment">// &#x6240;&#x4EE5;&#x4E0D;&#x4F1A;&#x8FDB;&#x5165;&#x5230;&#x8FD9;&#x4E2A;if</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.componentsIndex != <span class="hljs-keyword">null</span> &amp;&amp; indexSupportsIncludeFilters()) {
        <span class="hljs-keyword">return</span> addCandidateComponentsFromIndex(<span class="hljs-keyword">this</span>.componentsIndex, basePackage);
    }
    <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">return</span> scanCandidateComponents(basePackage);
    }
}
</code></pre>
<p>Spring &#x652F;&#x6301; component &#x7D22;&#x5F15;&#x6280;&#x672F;&#xFF0C;&#x9700;&#x8981;&#x5F15;&#x5165;&#x4E00;&#x4E2A;&#x7EC4;&#x4EF6;&#xFF0C;&#x5927;&#x90E8;&#x5206;&#x9879;&#x76EE;&#x6CA1;&#x6709;&#x5F15;&#x5165;&#x8FD9;&#x4E2A;&#x7EC4;&#x4EF6;&#xFF0C;&#x6240;&#x4EE5;&#x4F1A;&#x8FDB;&#x5165; scanCandidateComponents &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">private</span> Set&lt;BeanDefinition&gt; <span class="hljs-title">scanCandidateComponents</span><span class="hljs-params">(String basePackage)</span> </span>{
    Set&lt;BeanDefinition&gt; candidates = <span class="hljs-keyword">new</span> LinkedHashSet&lt;&gt;();
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// &#x628A; &#x4F20;&#x8FDB;&#x6765;&#x7684;&#x7C7B;&#x4F3C; &#x547D;&#x540D;&#x7A7A;&#x95F4;&#x5F62;&#x5F0F;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x8F6C;&#x6362;&#x6210;&#x7C7B;&#x4F3C;&#x7C7B;&#x6587;&#x4EF6;&#x5730;&#x5740;&#x7684;&#x5F62;&#x5F0F;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x524D;&#x9762;&#x52A0;&#x4E0A;classpath*:</span>
        <span class="hljs-comment">// &#x5373;&#xFF1A;com.xx=&gt;classpath*:com/xx/**/*.class</span>
        String packageSearchPath = ResourcePatternResolver.CLASSPATH_ALL_URL_PREFIX +
                resolveBasePackage(basePackage) + <span class="hljs-string">&apos;/&apos;</span> + <span class="hljs-keyword">this</span>.resourcePattern;
        <span class="hljs-comment">// &#x6839;&#x636E;packageSearchPath&#xFF0C;&#x83B7;&#x5F97;&#x7B26;&#x5408;&#x8981;&#x6C42;&#x7684;&#x6587;&#x4EF6;</span>
        Resource[] resources = getResourcePatternResolver().getResources(packageSearchPath);
        <span class="hljs-keyword">boolean</span> traceEnabled = logger.isTraceEnabled();
        <span class="hljs-keyword">boolean</span> debugEnabled = logger.isDebugEnabled();
        <span class="hljs-comment">// &#x5FAA;&#x73AF;&#x8D44;&#x6E90;</span>
        <span class="hljs-keyword">for</span> (Resource resource : resources) {
            <span class="hljs-keyword">if</span> (traceEnabled) {
                logger.trace(<span class="hljs-string">&quot;Scanning &quot;</span> + resource);
            }

            <span class="hljs-comment">// &#x5224;&#x65AD;&#x8D44;&#x6E90;&#x662F;&#x5426;&#x53EF;&#x8BFB;&#xFF0C;&#x5E76;&#x4E14;&#x4E0D;&#x662F;&#x4E00;&#x4E2A;&#x76EE;&#x5F55;</span>
            <span class="hljs-keyword">if</span> (resource.isReadable()) {
                <span class="hljs-keyword">try</span> {
                    <span class="hljs-comment">// metadataReader &#x5143;&#x6570;&#x636E;&#x8BFB;&#x53D6;&#x5668;&#xFF0C;&#x89E3;&#x6790;resource&#xFF0C;&#x4E5F;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x63CF;&#x8FF0;&#x8D44;&#x6E90;&#x7684;&#x6570;&#x636E;&#x7ED3;&#x6784;</span>
                    MetadataReader metadataReader = getMetadataReaderFactory().getMetadataReader(resource);
                    <span class="hljs-comment">// &#x5728;isCandidateComponent&#x65B9;&#x6CD5;&#x5185;&#x90E8;&#x4F1A;&#x771F;&#x6B63;&#x6267;&#x884C;&#x5339;&#x914D;&#x89C4;&#x5219;</span>
                    <span class="hljs-comment">// &#x6CE8;&#x518C;&#x914D;&#x7F6E;&#x7C7B;&#x81EA;&#x8EAB;&#x4F1A;&#x88AB;&#x6392;&#x9664;&#xFF0C;&#x4E0D;&#x4F1A;&#x8FDB;&#x5165;&#x5230;&#x8FD9;&#x4E2A;if</span>
                    <span class="hljs-keyword">if</span> (isCandidateComponent(metadataReader)) {
                        ScannedGenericBeanDefinition sbd = <span class="hljs-keyword">new</span> ScannedGenericBeanDefinition(metadataReader);
                        sbd.setResource(resource);
                        sbd.setSource(resource);
                        <span class="hljs-keyword">if</span> (isCandidateComponent(sbd)) {
                            <span class="hljs-keyword">if</span> (debugEnabled) {
                                logger.debug(<span class="hljs-string">&quot;Identified candidate component class: &quot;</span> + resource);
                            }
                            candidates.add(sbd);
                        }
                        <span class="hljs-keyword">else</span> {
                            <span class="hljs-keyword">if</span> (debugEnabled) {
                                logger.debug(<span class="hljs-string">&quot;Ignored because not a concrete top-level class: &quot;</span> + resource);
                            }
                        }
                    }
                    <span class="hljs-keyword">else</span> {
                        <span class="hljs-keyword">if</span> (traceEnabled) {
                            logger.trace(<span class="hljs-string">&quot;Ignored because not matching any filter: &quot;</span> + resource);
                        }
                    }
                }
                <span class="hljs-keyword">catch</span> (Throwable ex) {
                    <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(
                            <span class="hljs-string">&quot;Failed to read candidate component class: &quot;</span> + resource, ex);
                }
            }
            <span class="hljs-keyword">else</span> {
                <span class="hljs-keyword">if</span> (traceEnabled) {
                    logger.trace(<span class="hljs-string">&quot;Ignored because not readable: &quot;</span> + resource);
                }
            }
        }
    }
    <span class="hljs-keyword">catch</span> (IOException ex) {
        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(<span class="hljs-string">&quot;I/O failure during classpath scanning&quot;</span>, ex);
    }
    <span class="hljs-keyword">return</span> candidates;
}
</code></pre>
<ul>
<li>&#x628A;&#x4F20;&#x8FDB;&#x6765;&#x7684;&#x7C7B;&#x4F3C;&#x547D;&#x540D;&#x7A7A;&#x95F4;&#x5F62;&#x5F0F;&#x7684;&#x5B57;&#x7B26;&#x4E32;&#x8F6C;&#x6362;&#x6210;&#x7C7B;&#x4F3C;&#x7C7B;&#x6587;&#x4EF6;&#x5730;&#x5740;&#x7684;&#x5F62;&#x5F0F;&#xFF0C;&#x7136;&#x540E;&#x5728;&#x524D;&#x9762;&#x52A0;&#x4E0A; classpath&#xFF0C;&#x5373;&#xFF1A;<code>com.xx=&gt;classpath*:com/xx/**/*.class</code>&#x3002;</li>
<li>&#x6839;&#x636E; packageSearchPath&#xFF0C;&#x83B7;&#x5F97;&#x7B26;&#x5408;&#x8981;&#x6C42;&#x7684;&#x6587;&#x4EF6;&#x3002;</li>
<li>&#x5FAA;&#x73AF;&#x7B26;&#x5408;&#x8981;&#x6C42;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x8FDB;&#x4E00;&#x6B65;&#x8FDB;&#x884C;&#x5224;&#x65AD;&#x3002;</li>
</ul>
<p>&#x6700;&#x7EC8;&#x4F1A;&#x628A;&#x7B26;&#x5408;&#x8981;&#x6C42;&#x7684;&#x6587;&#x4EF6;&#xFF0C;&#x8F6C;&#x6362;&#x4E3A; BeanDefinition&#xFF0C;&#x5E76;&#x4E14;&#x8FD4;&#x56DE;&#x3002;</p>
<p><img src="../source/images/ch-05/ioc-18.png" alt="ioc-18"></p>
<p><strong>@Import&#x89E3;&#x6790;&#xFF1A;</strong></p>
<p>&#x76F4;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;&#x4E0A;&#x9762;&#x8BF4;&#x7684;4.1&#x4E2D;&#x63D0;&#x5230;&#x7684;&#x65B9;&#x6CD5;&#x7EC8;&#x4E8E;&#x5206;&#x6790;&#x5B8C;&#x6BD5;&#x4E86;&#xFF0C;&#x8BA9;&#x6211;&#x4EEC;&#x518D;&#x770B;&#x770B;&#x4E0A;&#x9762;&#x63D0;&#x5230;&#x7684;&#x7B2C;5&#x6B65;&#x4E2D;&#x7684;&#x5904;&#x7406; @Import &#x6CE8;&#x89E3;&#x65B9;&#x6CD5;&#xFF1A;</p>
<p><img src="../source/images/ch-05/ioc-19.png" alt="ioc-19"></p>
<pre><code class="lang-java"><span class="hljs-comment">// &#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x4E0D;&#x662F;&#x5F88;&#x719F;&#x6089;&#xFF0C;&#x6CA1;&#x9519;&#xFF0C;processImports&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5C31;&#x662F;&#x5728;processConfigurationClass&#x65B9;&#x6CD5;&#x4E2D;&#x88AB;&#x8C03;&#x7528;&#x7684;</span>
<span class="hljs-comment">// processImports&#x53C8;&#x4E3B;&#x52A8;&#x8C03;&#x7528;processConfigurationClass&#x65B9;&#x6CD5;&#xFF0C;&#x662F;&#x4E00;&#x4E2A;&#x9012;&#x5F52;&#x8C03;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;Import&#x7684;&#x666E;&#x901A;&#x7C7B;&#xFF0C;&#x4E5F;&#x6709;&#x53EF;&#x80FD;&#x88AB;&#x52A0;&#x4E86;Import&#x6CE8;&#x89E3;&#xFF0C;@ComponentScan&#x6CE8;&#x89E3; &#x6216;&#x8005;&#x5176;&#x4ED6;&#x6CE8;&#x89E3;&#xFF0C;&#x6240;&#x4EE5;&#x666E;&#x901A;&#x7C7B;&#x9700;&#x8981;&#x518D;&#x6B21;&#x88AB;&#x89E3;&#x6790;</span>
<span class="hljs-comment">// &#x5982;&#x679C;Import ImportSelector&#x5C31;&#x8DD1;&#x5230;&#x4E86;&#x7B2C;&#x4E00;&#x4E2A;if&#x4E2D;&#x53BB;&#xFF0C;&#x9996;&#x5148;&#x6267;&#x884C;Aware&#x63A5;&#x53E3;&#x65B9;&#x6CD5;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x5728;&#x5B9E;&#x73B0;ImportSelector&#x7684;&#x540C;&#x65F6;&#xFF0C;&#x8FD8;&#x53EF;&#x4EE5;&#x5B9E;&#x73B0;Aware&#x63A5;&#x53E3;</span>
<span class="hljs-comment">// &#x7136;&#x540E;&#x5224;&#x65AD;&#x662F;&#x4E0D;&#x662F;DeferredImportSelector&#xFF0C;DeferredImportSelector&#x6269;&#x5C55;&#x4E86;ImportSelector</span>
<span class="hljs-comment">// &#x5982;&#x679C;&#x4E0D;&#x662F;&#x7684;&#x8BDD;&#xFF0C;&#x8C03;&#x7528;selectImports&#x65B9;&#x6CD5;&#xFF0C;&#x83B7;&#x5F97;&#x5168;&#x9650;&#x5B9A;&#x7C7B;&#x540D;&#x6570;&#x7EC4;&#xFF0C;&#x5728;&#x8F6C;&#x6362;&#x6210;&#x7C7B;&#x7684;&#x6570;&#x7EC4;&#xFF0C;&#x7136;&#x540E;&#x518D;&#x8C03;&#x7528;processImports&#xFF0C;&#x53C8;&#x7279;&#x4E48;&#x7684;&#x662F;&#x4E00;&#x4E2A;&#x9012;&#x5F52;&#x8C03;&#x7528;...</span>
<span class="hljs-comment">// &#x53EF;&#x80FD;&#x53C8;&#x6709;&#x4E09;&#x79CD;&#x60C5;&#x51B5;&#xFF0C;&#x4E00;&#x79CD;&#x60C5;&#x51B5;&#x662F;selectImports&#x7684;&#x7C7B;&#x662F;&#x4E00;&#x4E2A;&#x666E;&#x901A;&#x7C7B;&#xFF0C;&#x7B2C;&#x4E8C;&#x79CD;&#x60C5;&#x51B5;&#x662F;selectImports&#x7684;&#x7C7B;&#x662F;&#x4E00;&#x4E2A;ImportBeanDefinitionRegistrar&#x7C7B;&#xFF0C;&#x7B2C;&#x4E09;&#x79CD;&#x60C5;&#x51B5;&#x662F;&#x8FD8;&#x662F;&#x4E00;&#x4E2A;ImportSelector&#x7C7B;...</span>
<span class="hljs-comment">// &#x6240;&#x4EE5;&#x53C8;&#x9700;&#x8981;&#x9012;&#x5F52;&#x8C03;&#x7528;</span>
<span class="hljs-comment">// &#x5982;&#x679C;Import ImportBeanDefinitionRegistrar&#x5C31;&#x8DD1;&#x5230;&#x4E86;&#x7B2C;&#x4E8C;&#x4E2A;if&#xFF0C;&#x8FD8;&#x662F;&#x4F1A;&#x6267;&#x884C;Aware&#x63A5;&#x53E3;&#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x91CC;&#x7EC8;&#x4E8E;&#x6CA1;&#x6709;&#x9012;&#x5F52;&#x4E86;&#xFF0C;&#x4F1A;&#x628A;&#x6570;&#x636E;&#x653E;&#x5230;ConfigurationClass&#x4E2D;&#x7684;Map&lt;ImportBeanDefinitionRegistrar, AnnotationMetadata&gt; importBeanDefinitionRegistrars&#x4E2D;&#x53BB;</span>
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">processImports</span><span class="hljs-params">(ConfigurationClass configClass, SourceClass currentSourceClass,
                            Collection&lt;SourceClass&gt; importCandidates, <span class="hljs-keyword">boolean</span> checkForCircularImports)</span> </span>{

    <span class="hljs-keyword">if</span> (importCandidates.isEmpty()) {
        <span class="hljs-keyword">return</span>;
    }

    <span class="hljs-keyword">if</span> (checkForCircularImports &amp;&amp; isChainedImportOnStack(configClass)) {
        <span class="hljs-keyword">this</span>.problemReporter.error(<span class="hljs-keyword">new</span> CircularImportProblem(configClass, <span class="hljs-keyword">this</span>.importStack));
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-keyword">this</span>.importStack.push(configClass);
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">for</span> (SourceClass candidate : importCandidates) {
                <span class="hljs-keyword">if</span> (candidate.isAssignable(ImportSelector.class)) {
                    <span class="hljs-comment">// Candidate class is an ImportSelector -&gt; delegate to it to determine imports</span>
                    Class&lt;?&gt; candidateClass = candidate.loadClass();
                    ImportSelector selector = BeanUtils.instantiateClass(candidateClass, ImportSelector.class);
                    ParserStrategyUtils.invokeAwareMethods(
                            selector, <span class="hljs-keyword">this</span>.environment, <span class="hljs-keyword">this</span>.resourceLoader, <span class="hljs-keyword">this</span>.registry);
                    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.deferredImportSelectors != <span class="hljs-keyword">null</span> &amp;&amp; selector <span class="hljs-keyword">instanceof</span> DeferredImportSelector) {
                        <span class="hljs-keyword">this</span>.deferredImportSelectors.add(
                                <span class="hljs-keyword">new</span> DeferredImportSelectorHolder(configClass, (DeferredImportSelector) selector));
                    } <span class="hljs-keyword">else</span> {
                        String[] importClassNames = selector.selectImports(currentSourceClass.getMetadata());
                        Collection&lt;SourceClass&gt; importSourceClasses = asSourceClasses(importClassNames);
                        processImports(configClass, currentSourceClass, importSourceClasses, <span class="hljs-keyword">false</span>);
                    }
                } <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (candidate.isAssignable(ImportBeanDefinitionRegistrar.class)) {
                    <span class="hljs-comment">// Candidate class is an ImportBeanDefinitionRegistrar -&gt;</span>
                    <span class="hljs-comment">// delegate to it to register additional bean definitions</span>
                    Class&lt;?&gt; candidateClass = candidate.loadClass();
                    ImportBeanDefinitionRegistrar registrar =
                            BeanUtils.instantiateClass(candidateClass, ImportBeanDefinitionRegistrar.class);
                    ParserStrategyUtils.invokeAwareMethods(
                            registrar, <span class="hljs-keyword">this</span>.environment, <span class="hljs-keyword">this</span>.resourceLoader, <span class="hljs-keyword">this</span>.registry);
                    configClass.addImportBeanDefinitionRegistrar(registrar, currentSourceClass.getMetadata());
                } <span class="hljs-keyword">else</span> {
                    <span class="hljs-comment">// Candidate class not an ImportSelector or ImportBeanDefinitionRegistrar -&gt;</span>
                    <span class="hljs-comment">// process it as an @Configuration class</span>
                    <span class="hljs-keyword">this</span>.importStack.registerImport(
                            currentSourceClass.getMetadata(), candidate.getMetadata().getClassName());
                    processConfigurationClass(candidate.asConfigClass(configClass));
                }
            }
        } <span class="hljs-keyword">catch</span> (BeanDefinitionStoreException ex) {
            <span class="hljs-keyword">throw</span> ex;
        } <span class="hljs-keyword">catch</span> (Throwable ex) {
            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> BeanDefinitionStoreException(
                    <span class="hljs-string">&quot;Failed to process import candidates for configuration class [&quot;</span> +
                            configClass.getMetadata().getClassName() + <span class="hljs-string">&quot;]&quot;</span>, ex);
        } <span class="hljs-keyword">finally</span> {
            <span class="hljs-keyword">this</span>.importStack.pop();
        }
    }
}
</code></pre>
<p><img src="../source/images/ch-05/ioc-20.png" alt="ioc-20"></p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5927;&#x6982;&#x7684;&#x4F5C;&#x7528;&#x5DF2;&#x7ECF;&#x5728;&#x6CE8;&#x91CA;&#x4E2D;&#x5DF2;&#x7ECF;&#x5199;&#x660E;&#x4E86;&#xFF0C;&#x5C31;&#x4E0D;&#x518D;&#x91CD;&#x590D;&#x4E86;&#x3002;</p>
<p>&#x76F4;&#x5230;&#x8FD9;&#x91CC;&#xFF0C;&#x624D;&#x628A; ConfigurationClassPostProcessor &#x4E2D;&#x7684; processConfigBeanDefinitions &#x65B9;&#x6CD5;&#x7B80;&#x5355;&#x7684;&#x8FC7;&#x4E86;&#x4E00;&#x4E0B;&#x3002;&#x4F46;&#x662F;&#x8FD9;&#x8FD8;&#x6CA1;&#x6709;&#x7ED3;&#x675F;&#xFF0C;&#x8FD9;&#x91CC;&#x53EA;&#x4F1A;&#x89E3;&#x6790; @Import &#x7684; Bean &#x800C;&#x5DF2;&#xFF0C; &#x4E0D;&#x4F1A;&#x6CE8;&#x518C;&#x3002;</p>
<p>&#x540E;&#x7EED;&#x8FD8;&#x6709;&#x4E2A;&#x70B9;&#xFF1A;processConfigBeanDefinitions &#x662F; BeanDefinitionRegistryPostProcessor &#x63A5;&#x53E3;&#x4E2D;&#x7684;&#x65B9;&#x6CD5;&#xFF0C;BeanDefinitionRegistryPostProcessor &#x6269;&#x5C55;&#x4E86; BeanFactoryPostProcessor&#xFF0C;&#x8FD8;&#x6709; postProcessBeanFactory &#x65B9;&#x6CD5;&#x6CA1;&#x6709;&#x5206;&#x6790;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x5E72;&#x561B;&#x7684;&#xFF0C;&#x7B80;&#x5355;&#x7684;&#x6765;&#x8BF4;&#xFF0C;&#x5C31;&#x662F;&#x5224;&#x65AD;&#x914D;&#x7F6E;&#x7C7B;&#x662F; Lite &#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x8FD8;&#x662F; Full &#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x5982;&#x679C;&#x662F;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x5C31;&#x4F1A;&#x88AB; Cglib &#x4EE3;&#x7406;&#xFF0C;&#x76EE;&#x7684;&#x5C31;&#x662F;&#x4FDD;&#x8BC1;Bean&#x7684;&#x4F5C;&#x7528;&#x57DF;&#x3002;&#x5173;&#x4E8E;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x5B9E;&#x5728;&#x662F;&#x6BD4;&#x8F83;&#x590D;&#x6742;&#xFF0C;&#x8BFE;&#x7A0B;&#x4E2D;&#x8BB2;&#x89E3;&#x3002;</p>
<p><img src="../source/images/ch-05/ioc-21.png" alt="ioc-21"></p>
<p>&#x6211;&#x4EEC;&#x6765;&#x505A;&#x4E00;&#x4E2A;&#x603B;&#x7ED3;&#xFF0C;ConfigurationClassPostProcessor &#x4E2D;&#x7684; processConfigBeanDefinitions &#x65B9;&#x6CD5;&#x5341;&#x5206;&#x91CD;&#x8981;&#xFF0C;&#x4E3B;&#x8981;&#x662F;&#x5B8C;&#x6210;&#x626B;&#x63CF;&#xFF0C;&#x6700;&#x7EC8;&#x6CE8;&#x518C;&#x6211;&#x4EEC;&#x5B9A;&#x4E49;&#x7684; Bean&#x3002;</p>
<h4 id="registerbeanpostprocessorsbeanfactory"><a name="registerbeanpostprocessorsbeanfactory" class="anchor-navigation-ex-anchor" href="#registerbeanpostprocessorsbeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a><a name="registerbeanpostprocessorsbeanfactory" class="plugin-anchor" href="#registerbeanpostprocessorsbeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a>registerBeanPostProcessors(beanFactory);</h4>
<p>&#x5B9E;&#x4F8B;&#x5316;&#x548C;&#x6CE8;&#x518C;beanFactory&#x4E2D;&#x6269;&#x5C55;&#x4E86; <code>BeanPostProcessor</code> &#x7684;bean&#x3002;</p>
<p>&#x4F8B;&#x5982;&#xFF1A;</p>
<p>AutowiredAnnotationBeanPostProcessor (&#x5904;&#x7406;&#x88AB; @Autowired &#x6CE8;&#x89E3;&#x4FEE;&#x9970;&#x7684; bean &#x5E76;&#x6CE8;&#x5165;)</p>
<p>RequiredAnnotationBeanPostProcessor (&#x5904;&#x7406;&#x88AB; @Required &#x6CE8;&#x89E3;&#x4FEE;&#x9970;&#x7684;&#x65B9;&#x6CD5;)</p>
<p>CommonAnnotationBeanPostProcessor (&#x5904;&#x7406; @PreDestroy&#x3001;@PostConstruct&#x3001;@Resource &#x7B49;&#x591A;&#x4E2A;&#x6CE8;&#x89E3;&#x7684;&#x4F5C;&#x7528;)&#x7B49;&#x3002;</p>
<p><img src="../source/images/ch-05/ioc-22.png" alt="ioc-22"></p>
<h4 id="initmessagesource"><a name="initmessagesource" class="anchor-navigation-ex-anchor" href="#initmessagesource"><i class="fa fa-link" aria-hidden="true"></i></a><a name="initmessagesource" class="plugin-anchor" href="#initmessagesource"><i class="fa fa-link" aria-hidden="true"></i></a>initMessageSource()</h4>
<pre><code class="lang-java"><span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x56FD;&#x9645;&#x5316;&#x8D44;&#x6E90;&#x5904;&#x7406;&#x5668;. &#x4E0D;&#x662F;&#x4E3B;&#x7EBF;&#x4EE3;&#x7801;&#x5FFD;&#x7565;&#xFF0C;&#x6CA1;&#x4EC0;&#x4E48;&#x5B66;&#x4E60;&#x4EF7;&#x503C;&#x3002;</span>
initMessageSource();
</code></pre>
<h4 id="initapplicationeventmulticaster"><a name="initapplicationeventmulticaster" class="anchor-navigation-ex-anchor" href="#initapplicationeventmulticaster"><i class="fa fa-link" aria-hidden="true"></i></a><a name="initapplicationeventmulticaster" class="plugin-anchor" href="#initapplicationeventmulticaster"><i class="fa fa-link" aria-hidden="true"></i></a>initApplicationEventMulticaster()</h4>
<p>&#x521B;&#x5EFA;&#x4E8B;&#x4EF6;&#x591A;&#x64AD;&#x5668;</p>
<p><img src="../source/images/ch-05/ioc-23.png" alt="ioc-23"></p>
<h4 id="onrefresh"><a name="onrefresh" class="anchor-navigation-ex-anchor" href="#onrefresh"><i class="fa fa-link" aria-hidden="true"></i></a><a name="onrefresh" class="plugin-anchor" href="#onrefresh"><i class="fa fa-link" aria-hidden="true"></i></a>onRefresh();</h4>
<p>&#x6A21;&#x677F;&#x65B9;&#x6CD5;&#xFF0C;&#x5728;&#x5BB9;&#x5668;&#x5237;&#x65B0;&#x7684;&#x65F6;&#x5019;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x903B;&#x8F91;&#xFF0C;&#x4E0D;&#x540C;&#x7684; Spring &#x5BB9;&#x5668;&#x505A;&#x4E0D;&#x540C;&#x7684;&#x4E8B;&#x60C5;&#x3002;</p>
<h4 id="registerlisteners"><a name="registerlisteners" class="anchor-navigation-ex-anchor" href="#registerlisteners"><i class="fa fa-link" aria-hidden="true"></i></a><a name="registerlisteners" class="plugin-anchor" href="#registerlisteners"><i class="fa fa-link" aria-hidden="true"></i></a>registerListeners();</h4>
<p>&#x6CE8;&#x518C;&#x76D1;&#x542C;&#x5668;&#xFF0C;&#x5E7F;&#x64AD; early application events</p>
<p><img src="../source/images/ch-05/ioc-24.png" alt="ioc-24"></p>
<h4 id="finishbeanfactoryinitializationbeanfactory"><a name="finishbeanfactoryinitializationbeanfactory" class="anchor-navigation-ex-anchor" href="#finishbeanfactoryinitializationbeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a><a name="finishbeanfactoryinitializationbeanfactory" class="plugin-anchor" href="#finishbeanfactoryinitializationbeanfactory"><i class="fa fa-link" aria-hidden="true"></i></a>finishBeanFactoryInitialization(beanFactory);</h4>
<p>&#x5B9E;&#x4F8B;&#x5316;&#x6240;&#x6709;&#x5269;&#x4F59;&#x7684;&#xFF08;&#x975E;&#x61D2;&#x52A0;&#x8F7D;&#xFF09;&#x5355;&#x4F8B;</p>
<p>&#x6BD4;&#x5982; invokeBeanFactoryPostProcessors &#x65B9;&#x6CD5;&#x4E2D;&#x6839;&#x636E;&#x5404;&#x79CD;&#x6CE8;&#x89E3;&#x89E3;&#x6790;&#x51FA;&#x6765;&#x7684;&#x7C7B;&#xFF0C;&#x5728;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x90FD;&#x4F1A;&#x88AB;&#x521D;&#x59CB;&#x5316;&#x3002;&#x5B9E;&#x4F8B;&#x5316;&#x7684;&#x8FC7;&#x7A0B;&#x5404;&#x79CD; BeanPostProcessor &#x5F00;&#x59CB;&#x8D77;&#x4F5C;&#x7528;&#x3002; </p>
<p>&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x662F;&#x7528;&#x6765;&#x5B9E;&#x4F8B;&#x5316;&#x61D2;&#x52A0;&#x8F7D;&#x5355;&#x4F8B; Bean &#x7684;&#xFF0C;&#x4E5F;&#x5C31;&#x662F;&#x6211;&#x4EEC;&#x7684; Bean &#x90FD;&#x662F;&#x5728;&#x8FD9;&#x91CC;&#x88AB;&#x521B;&#x5EFA;&#x51FA;&#x6765;&#x7684;&#xFF08;&#x5F53;&#x7136;&#x6211;&#x8FD9;&#x91CC;&#x8BF4;&#x7684;&#x7684;&#x662F;&#x7EDD;&#x5927;&#x90E8;&#x5206;&#x60C5;&#x51B5;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF09;&#xFF1A;</p>
<pre><code class="lang-java">finishBeanFactoryInitialization(beanFactory);
</code></pre>
<p>&#x6211;&#x4EEC;&#x518D;&#x8FDB;&#x5165; finishBeanFactoryInitialization &#x8FD9;&#x65B9;&#x6CD5;&#xFF0C;&#x91CC;&#x9762;&#x6709;&#x4E00;&#x4E2A; <code>beanFactory.preInstantiateSingletons()</code> &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-comment">// &#x521D;&#x59CB;&#x5316;&#x6240;&#x6709;&#x7684;&#x975E;&#x61D2;&#x52A0;&#x8F7D;&#x5355;&#x4F8B;</span>
beanFactory.preInstantiateSingletons();
</code></pre>
<p>&#x6211;&#x4EEC;&#x5C1D;&#x8BD5;&#x518D;&#x70B9;&#x8FDB;&#x53BB;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;&#x4F60;&#x4F1A;&#x53D1;&#x73B0;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x63A5;&#x53E3;&#xFF0C;&#x597D;&#x5728;&#x5B83;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x6240;&#x4EE5;&#x53EF;&#x4EE5;&#x6211;&#x4EEC;&#x6765;&#x5230;&#x4E86;&#x4ED6;&#x7684;&#x552F;&#x4E00;&#x5B9E;&#x73B0;&#xFF0C;&#x5B9E;&#x73B0;&#x7C7B;&#x5C31;&#x662F; <code>org.springframework.beans.factory.support.DefaultListableBeanFactory</code>&#xFF0C;&#x8FD9;&#x91CC;&#x9762;&#x662F;&#x4E00;&#x4E2A;&#x5FAA;&#x73AF;&#xFF0C;&#x6211;&#x4EEC;&#x7684; Bean &#x5C31;&#x662F;&#x5FAA;&#x73AF;&#x88AB;&#x521B;&#x5EFA;&#x51FA;&#x6765;&#x7684;&#xFF0C;&#x6211;&#x4EEC;&#x627E;&#x5230;&#x5176;&#x4E2D;&#x7684;getBean&#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java">getBean(beanName);
</code></pre>
<p>&#x8FD9;&#x91CC;&#x6709;&#x4E00;&#x4E2A;&#x5206;&#x652F;&#xFF0C;&#x5982;&#x679C; Bean &#x662F; FactoryBean&#xFF0C;&#x5982;&#x4F55;&#x5982;&#x4F55;&#xFF0C;&#x5982;&#x679C; Bean &#x4E0D;&#x662F; FactoryBean &#x5982;&#x4F55;&#x5982;&#x4F55;&#xFF0C;&#x597D;&#x5728;&#x4E0D;&#x7BA1;&#x662F;&#x4E0D;&#x662F; FactoryBean&#xFF0C;&#x6700;&#x7EC8;&#x8FD8;&#x662F;&#x4F1A;&#x8C03;&#x7528; getBean &#x65B9;&#x6CD5;&#xFF0C;&#x6240;&#x4EE5;&#x6211;&#x4EEC;&#x53EF;&#x4EE5;&#x6BEB;&#x4E0D;&#x72B9;&#x8C6B;&#x7684;&#x70B9;&#x8FDB;&#x53BB;&#xFF0C;&#x70B9;&#x8FDB;&#x53BB;&#x4E4B;&#x540E;&#xFF0C;&#x4F60;&#x4F1A;&#x53D1;&#x73B0;&#xFF0C;&#x8FD9;&#x662F;&#x4E00;&#x4E2A;&#x95E8;&#x9762;&#x65B9;&#x6CD5;&#xFF0C;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x4E86; doGetBean &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">return</span> doGetBean(name, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">null</span>, <span class="hljs-keyword">false</span>);
</code></pre>
<p>&#x518D;&#x8FDB;&#x53BB;&#xFF0C;&#x4E0D;&#x65AD;&#x7684;&#x6DF1;&#x5165;&#xFF0C;&#x63A5;&#x8FD1;&#x6211;&#x4EEC;&#x8981;&#x5BFB;&#x627E;&#x7684;&#x4E1C;&#x897F;&#x3002;&#x6211;&#x4EEC;&#x8981;&#x8FDB;&#x5165;</p>
<pre><code class="lang-java"><span class="hljs-keyword">if</span> (mbd.isSingleton()) {

    <span class="hljs-comment">// getSingleton&#x4E2D;&#x7684;&#x7B2C;&#x4E8C;&#x4E2A;&#x53C2;&#x6570;&#x7C7B;&#x578B;&#x662F;ObjectFactory&lt;?&gt;&#xFF0C;&#x662F;&#x4E00;&#x4E2A;&#x51FD;&#x6570;&#x5F0F;&#x63A5;&#x53E3;&#xFF0C;&#x4E0D;&#x4F1A;&#x7ACB;&#x523B;&#x6267;&#x884C;&#xFF0C;&#x800C;&#x662F;&#x5728;</span>
    <span class="hljs-comment">// getSingleton&#x65B9;&#x6CD5;&#x4E2D;&#xFF0C;&#x8C03;&#x7528;ObjectFactory&#x7684;getObject&#xFF0C;&#x624D;&#x4F1A;&#x6267;&#x884C;createBean</span>
    sharedInstance = getSingleton(beanName, () -&gt; {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-keyword">return</span> createBean(beanName, mbd, args);
        }
        <span class="hljs-keyword">catch</span> (BeansException ex) {
            destroySingleton(beanName);
            <span class="hljs-keyword">throw</span> ex;
        }
    });
    bean = getObjectForBeanInstance(sharedInstance, name, beanName, mbd);
}
</code></pre>
<p>&#x8FD9;&#x91CC;&#x9762;&#x7684; createBean &#x65B9;&#x6CD5;&#xFF0C;&#x518D;&#x70B9;&#x8FDB;&#x53BB;&#x554A;&#xFF0C;&#x4F46;&#x662F;&#x53C8;&#x70B9;&#x4E0D;&#x8FDB;&#x53BB;&#x4E86;&#xFF0C;&#x8FD9;&#x662F;&#x63A5;&#x53E3;&#x554A;&#xFF0C;&#x4F46;&#x662F;&#x522B;&#x614C;&#xFF0C;&#x8FD9;&#x4E2A;&#x63A5;&#x53E3;&#x53C8;&#x53EA;&#x6709;&#x4E00;&#x4E2A;&#x5B9E;&#x73B0;&#x7C7B;&#xFF0C;&#x6240;&#x4EE5;&#x8BF4; &#x6CA1;&#x4E8B;&#xFF0C;&#x5C31;&#x662F;&#x5E72;&#xFF0C;&#x8FD9;&#x4E2A;&#x5B9E;&#x73B0;&#x7C7B;&#x4E3A; <code>org.springframework.beans.factory.support.AbstractAutowireCapableBeanFactory</code>&#x3002;</p>
<p>&#x8FD9;&#x4E2A;&#x5B9E;&#x73B0;&#x7684;&#x65B9;&#x6CD5;&#x91CC;&#x9762;&#x53C8;&#x505A;&#x4E86;&#x5F88;&#x591A;&#x4E8B;&#x60C5;&#xFF0C;&#x6211;&#x4EEC;&#x5C31;&#x4E0D;&#x53BB;&#x770B;&#x4E86;&#xFF0C;&#x6211;&#x5C31;&#x662F;&#x5E26;&#x7740;&#x5927;&#x5BB6;&#x627E;&#x5230;&#x90A3;&#x51E0;&#x4E2A;&#x751F;&#x547D;&#x5468;&#x671F;&#x7684;&#x56DE;&#x8C03;&#x5230;&#x5E95;&#x5B9A;&#x4E49;&#x5728;&#x54EA;&#x91CC;&#x5C31; OK &#x4E86;&#x3002;</p>
<pre><code class="lang-java"><span class="hljs-comment">// &#x521B;&#x5EFA;bean&#xFF0C;&#x6838;&#x5FC3;</span>
Object beanInstance = doCreateBean(beanName, mbdToUse, args);
<span class="hljs-keyword">if</span> (logger.isDebugEnabled()) {
    logger.debug(<span class="hljs-string">&quot;Finished creating instance of bean &apos;&quot;</span> + beanName + <span class="hljs-string">&quot;&apos;&quot;</span>);
}
<span class="hljs-keyword">return</span> beanInstance;
</code></pre>
<p>&#x518D;&#x7EE7;&#x7EED;&#x6DF1;&#x5165; doCreateBean &#x65B9;&#x6CD5;&#xFF0C;&#x8FD9;&#x4E2A;&#x65B9;&#x6CD5;&#x53C8;&#x505A;&#x4E86;&#x4E00;&#x5806;&#x4E00;&#x5806;&#x7684;&#x4E8B;&#x60C5;&#xFF0C;&#x4F46;&#x662F;&#x503C;&#x5F97;&#x5F00;&#x5FC3;&#x7684;&#x4E8B;&#x60C5;&#x5C31;&#x662F; &#x6211;&#x4EEC;&#x5DF2;&#x7ECF;&#x627E;&#x5230;&#x4E86;&#x6211;&#x4EEC;&#x8981;&#x5BFB;&#x627E;&#x7684;&#x4E1C;&#x897F;&#x4E86;&#x3002;</p>
<h5 id="&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;"><a name="&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;" class="anchor-navigation-ex-anchor" href="#&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;" class="plugin-anchor" href="#&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;</h5>
<p>&#x9996;&#x5148;&#x662F;&#x521B;&#x5EFA;&#x5B9E;&#x4F8B;&#xFF0C;&#x4F4D;&#x4E8E;&#xFF1A;</p>
<pre><code class="lang-java">instanceWrapper = createBeanInstance(beanName, mbd, args);    <span class="hljs-comment">// &#x521B;&#x5EFA;bean&#x7684;&#x5B9E;&#x4F8B;&#x3002;&#x6838;&#x5FC3;</span>
</code></pre>
<h5 id="&#x586B;&#x5145;&#x5C5E;&#x6027;"><a name="&#x586B;&#x5145;&#x5C5E;&#x6027;" class="anchor-navigation-ex-anchor" href="#&#x586B;&#x5145;&#x5C5E;&#x6027;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="&#x586B;&#x5145;&#x5C5E;&#x6027;" class="plugin-anchor" href="#&#x586B;&#x5145;&#x5C5E;&#x6027;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x586B;&#x5145;&#x5C5E;&#x6027;</h5>
<p>&#x5176;&#x6B21;&#x662F;&#x586B;&#x5145;&#x5C5E;&#x6027;&#xFF0C;&#x4F4D;&#x4E8E;&#xFF1A;</p>
<pre><code class="lang-java">populateBean(beanName, mbd, instanceWrapper);    <span class="hljs-comment">// &#x586B;&#x5145;&#x5C5E;&#x6027;&#xFF0C;&#x7092;&#x9E21;&#x91CD;&#x8981;</span>
</code></pre>
<p>&#x5728;&#x586B;&#x5145;&#x5C5E;&#x6027;&#x4E0B;&#x9762;&#x6709;&#x4E00;&#x884C;&#x4EE3;&#x7801;&#xFF1A;</p>
<pre><code class="lang-java">exposedObject = initializeBean(beanName, exposedObject, mbd);
</code></pre>
<p>&#x7EE7;&#x7EED;&#x6DF1;&#x5165;&#x8FDB;&#x53BB;&#x3002;</p>
<h5 id="aware&#x7CFB;&#x5217;&#x63A5;&#x53E3;&#x7684;&#x56DE;&#x8C03;"><a name="aware&#x7CFB;&#x5217;&#x63A5;&#x53E3;&#x7684;&#x56DE;&#x8C03;" class="anchor-navigation-ex-anchor" href="#aware&#x7CFB;&#x5217;&#x63A5;&#x53E3;&#x7684;&#x56DE;&#x8C03;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="aware&#x7CFB;&#x5217;&#x63A5;&#x53E3;&#x7684;&#x56DE;&#x8C03;" class="plugin-anchor" href="#aware&#x7CFB;&#x5217;&#x63A5;&#x53E3;&#x7684;&#x56DE;&#x8C03;"><i class="fa fa-link" aria-hidden="true"></i></a>aware&#x7CFB;&#x5217;&#x63A5;&#x53E3;&#x7684;&#x56DE;&#x8C03;</h5>
<p>aware &#x7CFB;&#x5217;&#x63A5;&#x53E3;&#x7684;&#x56DE;&#x8C03;&#x4F4D;&#x4E8E; initializeBean &#x4E2D;&#x7684; invokeAwareMethods &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java">invokeAwareMethods(beanName, bean);
<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeAwareMethods</span><span class="hljs-params">(<span class="hljs-keyword">final</span> String beanName, <span class="hljs-keyword">final</span> Object bean)</span> </span>{
    <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> Aware) {
        <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> BeanNameAware) {
            ((BeanNameAware) bean).setBeanName(beanName);
        }
        <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> BeanClassLoaderAware) {
            ClassLoader bcl = getBeanClassLoader();
            <span class="hljs-keyword">if</span> (bcl != <span class="hljs-keyword">null</span>) {
                ((BeanClassLoaderAware) bean).setBeanClassLoader(bcl);
            }
        }
        <span class="hljs-keyword">if</span> (bean <span class="hljs-keyword">instanceof</span> BeanFactoryAware) {
            ((BeanFactoryAware) bean).setBeanFactory(AbstractAutowireCapableBeanFactory.<span class="hljs-keyword">this</span>);
        }
    }
}
</code></pre>
<h5 id="beanpostprocessor&#x7684;postprocessbeforeinitialization&#x65B9;&#x6CD5;"><a name="beanpostprocessor&#x7684;postprocessbeforeinitialization&#x65B9;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#beanpostprocessor&#x7684;postprocessbeforeinitialization&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="beanpostprocessor&#x7684;postprocessbeforeinitialization&#x65B9;&#x6CD5;" class="plugin-anchor" href="#beanpostprocessor&#x7684;postprocessbeforeinitialization&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>BeanPostProcessor&#x7684;postProcessBeforeInitialization&#x65B9;&#x6CD5;</h5>
<p>BeanPostProcessor &#x7684; postProcessBeforeInitialization &#x65B9;&#x6CD5;&#x4F4D;&#x4E8E; initializeBean &#x7684;</p>
<pre><code class="lang-java"><span class="hljs-keyword">if</span> (mbd == <span class="hljs-keyword">null</span> || !mbd.isSynthetic()) {
    wrappedBean = applyBeanPostProcessorsBeforeInitialization(wrappedBean, beanName);
}

<span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">applyBeanPostProcessorsBeforeInitialization</span><span class="hljs-params">(Object existingBean, String beanName)</span>
        <span class="hljs-keyword">throws</span> BeansException </span>{

    Object result = existingBean;
    <span class="hljs-keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) {
        Object current = processor.postProcessBeforeInitialization(result, beanName);
        <span class="hljs-keyword">if</span> (current == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">return</span> result;
        }
        result = current;
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<h5 id="afterpropertiesset-init-method"><a name="afterpropertiesset-init-method" class="anchor-navigation-ex-anchor" href="#afterpropertiesset-init-method"><i class="fa fa-link" aria-hidden="true"></i></a><a name="afterpropertiesset-init-method" class="plugin-anchor" href="#afterpropertiesset-init-method"><i class="fa fa-link" aria-hidden="true"></i></a>afterPropertiesSet init-method</h5>
<p>afterPropertiesSet init-method &#x4F4D;&#x4E8E; initializeBean &#x4E2D;&#x7684;</p>
<pre><code class="lang-java">invokeInitMethods(beanName, wrappedBean, mbd);
</code></pre>
<p>&#x8FD9;&#x91CC;&#x9762;&#x8C03;&#x7528;&#x4E86;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#xFF0C;&#x4E00;&#x4E2A;&#x662F; afterPropertiesSet &#x65B9;&#x6CD5;&#xFF0C;&#x4E00;&#x4E2A;&#x662F; init-method &#x65B9;&#x6CD5;&#xFF1A;</p>
<pre><code class="lang-java">((InitializingBean) bean).afterPropertiesSet(); invokeCustomInitMethod(beanName, bean, mbd);
</code></pre>
<h5 id="beanpostprocessor&#x7684;postprocessafterinitialization&#x65B9;&#x6CD5;"><a name="beanpostprocessor&#x7684;postprocessafterinitialization&#x65B9;&#x6CD5;" class="anchor-navigation-ex-anchor" href="#beanpostprocessor&#x7684;postprocessafterinitialization&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="beanpostprocessor&#x7684;postprocessafterinitialization&#x65B9;&#x6CD5;" class="plugin-anchor" href="#beanpostprocessor&#x7684;postprocessafterinitialization&#x65B9;&#x6CD5;"><i class="fa fa-link" aria-hidden="true"></i></a>BeanPostProcessor&#x7684;postProcessAfterInitialization&#x65B9;&#x6CD5;</h5>
<p>BeanPostProcessor &#x7684; postProcessAfterInitialization &#x65B9;&#x6CD5;&#x4F4D;&#x4E8E; initializeBean &#x7684;</p>
<pre><code class="lang-java"><span class="hljs-keyword">if</span> (mbd == <span class="hljs-keyword">null</span> || !mbd.isSynthetic()) {
    wrappedBean = applyBeanPostProcessorsAfterInitialization(wrappedBean, beanName);
}

<span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">applyBeanPostProcessorsAfterInitialization</span><span class="hljs-params">(Object existingBean, String beanName)</span>
        <span class="hljs-keyword">throws</span> BeansException </span>{

    Object result = existingBean;
    <span class="hljs-keyword">for</span> (BeanPostProcessor processor : getBeanPostProcessors()) {
        Object current = processor.<span class="hljs-function">postProcessAfterI <span class="hljs-title">nitialization</span><span class="hljs-params">(result, beanName)</span></span>;
        <span class="hljs-keyword">if</span> (current == <span class="hljs-keyword">null</span>) {
            <span class="hljs-keyword">return</span> result;
        }
        result = current;
    }
    <span class="hljs-keyword">return</span> result;
}
</code></pre>
<p>&#x5F53;&#x7136;&#x5728;&#x5B9E;&#x9645;&#x7684;&#x5F00;&#x53D1;&#x4E2D;&#xFF0C;&#x5E94;&#x8BE5;&#x6CA1;&#x4EBA;&#x4F1A;&#x53BB;&#x9500;&#x6BC1; Spring &#x7684;&#x5E94;&#x7528;&#x4E0A;&#x4E0B;&#x6587;&#x628A;&#xFF0C;&#x6240;&#x4EE5;&#x5269;&#x4F59;&#x7684;&#x4E24;&#x4E2A;&#x9500;&#x6BC1;&#x7684;&#x56DE;&#x8C03;&#x5C31;&#x4E0D;&#x53BB;&#x627E;&#x4E86;&#x3002;</p>
<h2 id="2-spring-bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;"><a name="2-spring-bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;" class="anchor-navigation-ex-anchor" href="#2-spring-bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="2-spring-bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;" class="plugin-anchor" href="#2-spring-bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;"><i class="fa fa-link" aria-hidden="true"></i></a>2. Spring Bean&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;</h2>
<p>Spring In Action &#x4EE5;&#x53CA;&#x5E02;&#x9762;&#x4E0A;&#x6D41;&#x4F20;&#x7684;&#x5927;&#x90E8;&#x5206;&#x535A;&#x5BA2;&#x662F;&#x8FD9;&#x6837;&#x7684;&#xFF1A;</p>
<ul>
<li>&#x5B9E;&#x4F8B;&#x5316;Bean&#x5BF9;&#x8C61;&#xFF0C;&#x8FD9;&#x4E2A;&#x65F6;&#x5019;Bean&#x7684;&#x5BF9;&#x8C61;&#x662F;&#x975E;&#x5E38;&#x4F4E;&#x7EA7;&#x7684;&#xFF0C;&#x57FA;&#x672C;&#x4E0D;&#x80FD;&#x591F;&#x88AB;&#x6211;&#x4EEC;&#x4F7F;&#x7528;&#xFF0C;&#x56E0;&#x4E3A;&#x8FDE;&#x6700;&#x57FA;&#x672C;&#x7684;&#x5C5E;&#x6027;&#x90FD;&#x6CA1;&#x6709;&#x8BBE;&#x7F6E;&#xFF0C;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;&#x8FDE;Autowired&#x6CE8;&#x89E3;&#x90FD;&#x662F;&#x6CA1;&#x6709;&#x89E3;&#x6790;&#x7684;&#xFF1B;</li>
<li>&#x586B;&#x5145;&#x5C5E;&#x6027;&#xFF0C;&#x5F53;&#x505A;&#x5B8C;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;Bean&#x5BF9;&#x8C61;&#x57FA;&#x672C;&#x662F;&#x5B8C;&#x6574;&#x7684;&#x4E86;&#xFF0C;&#x53EF;&#x4EE5;&#x7406;&#x89E3;&#x4E3A;Autowired&#x6CE8;&#x89E3;&#x5DF2;&#x7ECF;&#x89E3;&#x6790;&#x5B8C;&#x6BD5;&#xFF0C;&#x4F9D;&#x8D56;&#x6CE8;&#x5165;&#x5B8C;&#x6210;&#x4E86;&#xFF1B;</li>
<li>&#x5982;&#x679C; Bean &#x5B9E;&#x73B0;&#x4E86; BeanNameAware &#x63A5;&#x53E3;&#xFF0C;&#x5219;&#x8C03;&#x7528; setBeanName &#x65B9;&#x6CD5;&#xFF1B;</li>
<li>&#x5982;&#x679C; Bean &#x5B9E;&#x73B0;&#x4E86; BeanClassLoaderAware &#x63A5;&#x53E3;&#xFF0C;&#x5219;&#x8C03;&#x7528; setBeanClassLoader &#x65B9;&#x6CD5;&#xFF1B;</li>
<li>&#x5982;&#x679C; Bean &#x5B9E;&#x73B0;&#x4E86; BeanFactoryAware &#x63A5;&#x53E3;&#xFF0C;&#x5219;&#x8C03;&#x7528; setBeanFactory &#x65B9;&#x6CD5;&#xFF1B;</li>
<li>&#x8C03;&#x7528; BeanPostProcessor &#x7684; postProcessBeforeInitialization &#x65B9;&#x6CD5;&#xFF1B;</li>
<li>&#x5982;&#x679C; Bean&#x5B9E;&#x73B0;&#x4E86; InitializingBean &#x63A5;&#x53E3;&#xFF0C;&#x8C03;&#x7528; afterPropertiesSet &#x65B9;&#x6CD5;&#xFF1B;</li>
<li>&#x5982;&#x679C; Bean &#x5B9A;&#x4E49;&#x4E86; init-method &#x65B9;&#x6CD5;&#xFF0C;&#x5219;&#x8C03;&#x7528; Bean&#x7684;init-method &#x65B9;&#x6CD5;&#xFF1B;</li>
<li>&#x8C03;&#x7528; BeanPostProcessor &#x7684; postProcessAfterInitialization &#x65B9;&#x6CD5;&#xFF1B;&#x5F53;&#x8FDB;&#x884C;&#x5230;&#x8FD9;&#x4E00;&#x6B65;&#xFF0C;Bean &#x5DF2;&#x7ECF;&#x88AB;&#x51C6;&#x5907;&#x5C31;&#x7EEA;&#x4E86;&#xFF0C;&#x4E00;&#x76F4;&#x505C;&#x7559;&#x5728;&#x5E94;&#x7528;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x4E2D;&#xFF0C;&#x76F4;&#x5230;&#x88AB;&#x9500;&#x6BC1;&#xFF1B;</li>
<li>&#x5982;&#x679C;&#x5E94;&#x7528;&#x7684;&#x4E0A;&#x4E0B;&#x6587;&#x88AB;&#x9500;&#x6BC1;&#x4E86;&#xFF0C;&#x5982;&#x679C; Bean &#x5B9E;&#x73B0;&#x4E86; DisposableBean &#x63A5;&#x53E3;&#xFF0C;&#x5219;&#x8C03;&#x7528; destroy &#x65B9;&#x6CD5;&#xFF0C;&#x5982;&#x679C; Bean &#x5B9A;&#x4E49;&#x4E86; destory-method &#x58F0;&#x660E;&#x4E86;&#x9500;&#x6BC1;&#x65B9;&#x6CD5;&#x4E5F;&#x4F1A;&#x88AB;&#x8C03;&#x7528;&#x3002;</li>
</ul>
<p>&#x4E3A;&#x4E86;&#x9A8C;&#x8BC1;&#x4E0A;&#x9762;&#x7684;&#x903B;&#x8F91;&#xFF0C;&#x53EF;&#x4EE5;&#x505A;&#x4E2A;&#x8BD5;&#x9A8C;&#xFF1A;</p>
<p>&#x9996;&#x5148;&#x5B9A;&#x4E49;&#x4E86;&#x4E00;&#x4E2A; Bean&#xFF0C;&#x91CC;&#x9762;&#x6709;&#x5404;&#x79CD;&#x56DE;&#x8C03;&#x548C;&#x94A9;&#x5B50;&#xFF0C;&#x5176;&#x4E2D;&#x9700;&#x8981;&#x6CE8;&#x610F;&#x4E0B;&#xFF0C;&#x6211;&#x5728; SpringBean &#x7684;&#x6784;&#x9020;&#x65B9;&#x6CD5;&#x4E2D;&#x6253;&#x5370;&#x4E86; studentService&#xFF0C;&#x770B; SpringBean &#x88AB; new &#x7684;&#x51FA;&#x6765;&#x7684;&#x65F6;&#x5019;&#xFF0C;studentService &#x662F;&#x5426;&#x88AB;&#x6CE8;&#x5165;&#x4E86;&#xFF1B;&#x53C8;&#x5728; setBeanName &#x4E2D;&#x6253;&#x5370;&#x4E86; studentService&#xFF0C;&#x770B;&#x6B64;&#x65F6; studentService &#x662F;&#x5426;&#x88AB;&#x6CE8;&#x5165;&#x4E86;&#xFF0C;&#x4EE5;&#x6B64;&#x6765;&#x9A8C;&#x8BC1;&#xFF0C;Bean &#x662F;&#x4F55;&#x65F6;&#x5B8C;&#x6210;&#x7684;&#x81EA;&#x52A8;&#x6CE8;&#x5165;&#x7684;&#xFF08;&#x8FD9;&#x4E2A; StudentServiceImpl &#x7C7B;&#x7684;&#x4EE3;&#x7801;&#x5C31;&#x4E0D;&#x8D34;&#x51FA;&#x6765;&#x4E86;&#xFF0C;&#x65E0;&#x975E;&#x5C31;&#x662F;&#x4E00;&#x4E2A;&#x6700;&#x666E;&#x901A;&#x7684; Bean&#xFF09;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">SpringBean</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">InitializingBean</span>, <span class="hljs-title">DisposableBean</span>, <span class="hljs-title">BeanNameAware</span>, <span class="hljs-title">BeanFactoryAware</span>, <span class="hljs-title">BeanClassLoaderAware</span> </span>{

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-title">SpringBean</span><span class="hljs-params">()</span> </span>{
        System.out.println(<span class="hljs-string">&quot;SpringBean&#x6784;&#x9020;&#x65B9;&#x6CD5;:&quot;</span> + studentService);
        System.out.println(<span class="hljs-string">&quot;SpringBean&#x6784;&#x9020;&#x65B9;&#x6CD5;&quot;</span>);
    }

    <span class="hljs-meta">@Autowired</span>
    StudentServiceImpl studentService;

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">afterPropertiesSet</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
        System.out.println(<span class="hljs-string">&quot;afterPropertiesSet&quot;</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroy</span><span class="hljs-params">()</span> <span class="hljs-keyword">throws</span> Exception </span>{
        System.out.println(<span class="hljs-string">&quot;destroy&quot;</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBeanClassLoader</span><span class="hljs-params">(ClassLoader classLoader)</span> </span>{
        System.out.println(<span class="hljs-string">&quot;setBeanClassLoader&quot;</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBeanFactory</span><span class="hljs-params">(BeanFactory beanFactory)</span> <span class="hljs-keyword">throws</span> BeansException </span>{
        System.out.println(<span class="hljs-string">&quot;setBeanFactory&quot;</span>);
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">setBeanName</span><span class="hljs-params">(String name)</span> </span>{
        System.out.println(<span class="hljs-string">&quot;setBeanName:&quot;</span> + studentService);
        System.out.println(<span class="hljs-string">&quot;setBeanName&quot;</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">initMethod</span><span class="hljs-params">()</span> </span>{
        System.out.println(<span class="hljs-string">&quot;initMethod&quot;</span>);
    }

    <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">destroyMethod</span><span class="hljs-params">()</span> </span>{
        System.out.println(<span class="hljs-string">&quot;destroyMethod&quot;</span>);
    }
}
</code></pre>
<p>&#x518D;&#x5B9A;&#x4E49;&#x4E00;&#x4E2A; BeanPostProcessor&#xFF0C;&#x5728;&#x91CD;&#x5199;&#x7684;&#x4E24;&#x4E2A;&#x65B9;&#x6CD5;&#x4E2D;&#x8FDB;&#x884C;&#x4E86;&#x5224;&#x65AD;&#xFF0C;&#x5982;&#x679C;&#x4F20;&#x8FDB;&#x6765;&#x7684; beanName &#x662F; springBean &#x624D;&#x8FDB;&#x884C;&#x6253;&#x5370;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-meta">@Component</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">MyBeanPostProcessor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title">BeanPostProcessor</span> </span>{
    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">postProcessBeforeInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException </span>{
        <span class="hljs-keyword">if</span>(beanName.equals(<span class="hljs-string">&quot;springBean&quot;</span>)) {
            System.out.println(<span class="hljs-string">&quot;postProcessBeforeInitialization&quot;</span>);
        }
        <span class="hljs-keyword">return</span> bean;
    }

    <span class="hljs-meta">@Override</span>
    <span class="hljs-function"><span class="hljs-keyword">public</span> Object <span class="hljs-title">postProcessAfterInitialization</span><span class="hljs-params">(Object bean, String beanName)</span> <span class="hljs-keyword">throws</span> BeansException </span>{
        <span class="hljs-keyword">if</span>(beanName.equals(<span class="hljs-string">&quot;springBean&quot;</span>)) {
            System.out.println(<span class="hljs-string">&quot;postProcessAfterInitialization&quot;</span>);
        }
        <span class="hljs-keyword">return</span> bean;
    }
}
</code></pre>
<p>&#x5B9A;&#x4E49;&#x4E00;&#x4E2A;&#x914D;&#x7F6E;&#x7C7B;&#xFF0C;&#x5B8C;&#x6210;&#x81EA;&#x52A8;&#x626B;&#x63CF;&#xFF0C;&#x4F46;&#x662F; SpringBean &#x662F;&#x624B;&#x52A8;&#x6CE8;&#x518C;&#x7684;&#xFF0C;&#x5E76;&#x4E14;&#x58F0;&#x660E;&#x4E86; initMethod &#x548C; destroyMethod&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-meta">@Configuration</span>
<span class="hljs-meta">@ComponentScan</span>
<span class="hljs-keyword">public</span> <span class="hljs-class"><span class="hljs-keyword">class</span> <span class="hljs-title">AppConfig</span> </span>{
    <span class="hljs-meta">@Bean</span>(initMethod = <span class="hljs-string">&quot;initMethod&quot;</span>,destroyMethod = <span class="hljs-string">&quot;destroyMethod&quot;</span>)
    <span class="hljs-function"><span class="hljs-keyword">public</span> SpringBean <span class="hljs-title">springBean</span><span class="hljs-params">()</span> </span>{
        <span class="hljs-keyword">return</span> <span class="hljs-keyword">new</span> SpringBean();
    }
}
</code></pre>
<p>&#x6700;&#x540E;&#x5C31;&#x662F;&#x542F;&#x52A8;&#x7C7B;&#x4E86;&#xFF1A;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">void</span> <span class="hljs-title">main</span><span class="hljs-params">(String[] args)</span> </span>{
    AnnotationConfigApplicationContext annotationConfigApplicationContext =
            <span class="hljs-keyword">new</span> AnnotationConfigApplicationContext(AppConfig.class);
    annotationConfigApplicationContext.destroy();
}
</code></pre>
<p>&#x8FD0;&#x884C;&#x7ED3;&#x679C;&#xFF1A;</p>
<pre><code>SpringBean&#x6784;&#x9020;&#x65B9;&#x6CD5;:null
SpringBean&#x6784;&#x9020;&#x65B9;&#x6CD5;
setBeanName:com.codebear.StudentServiceImpl@31190526
setBeanName
setBeanClassLoader
setBeanFactory
postProcessBeforeInitialization
afterPropertiesSet
initMethod
postProcessAfterInitialization
destroy
destroyMethod
</code></pre><p>&#x53EF;&#x4EE5;&#x770B;&#x5230;&#xFF0C;&#x8BD5;&#x9A8C;&#x7ED3;&#x679C;&#x548C;&#x4E0A;&#x9762;&#x5206;&#x6790;&#x7684;&#x5B8C;&#x5168;&#x4E00;&#x81F4;&#x3002;</p>
<p>&#x8FD9;&#x5C31;&#x662F;&#x5E7F;&#x4E3A;&#x6D41;&#x4F20;&#x7684; Spring &#x751F;&#x547D;&#x5468;&#x671F;&#x3002;</p>
<p>&#x4E5F;&#x8BB8;&#x4F60;&#x5728;&#x5E94;&#x4ED8;&#x9762;&#x8BD5;&#x7684;&#x65F6;&#x5019;&#xFF0C;&#x662F;&#x6B7B;&#x8BB0;&#x786C;&#x80CC;&#x8FD9;&#x4E9B;&#x7ED3;&#x8BBA;&#x7684;&#xFF0C;&#x73B0;&#x5728;&#x6211;&#x5E26;&#x7740;&#x4F60;&#x627E;&#x5230;&#x8FD9;&#x4E9B;&#x65B9;&#x6CD5;&#xFF0C;&#x8DDF;&#x6211;&#x6765;&#x3002;</p>
<h4 id="finishrefresh"><a name="finishrefresh" class="anchor-navigation-ex-anchor" href="#finishrefresh"><i class="fa fa-link" aria-hidden="true"></i></a><a name="finishrefresh" class="plugin-anchor" href="#finishrefresh"><i class="fa fa-link" aria-hidden="true"></i></a>finishRefresh();</h4>
<p>refresh &#x505A;&#x5B8C;&#x4E4B;&#x540E;&#x9700;&#x8981;&#x505A;&#x7684;&#x5176;&#x4ED6;&#x4E8B;&#x60C5;&#x3002;</p>
<p>&#x6E05;&#x9664;&#x4E0A;&#x4E0B;&#x6587;&#x8D44;&#x6E90;&#x7F13;&#x5B58;&#xFF08;&#x5982;&#x626B;&#x63CF;&#x4E2D;&#x7684; ASM &#x5143;&#x6570;&#x636E;&#xFF09;</p>
<p>&#x521D;&#x59CB;&#x5316;&#x4E0A;&#x4E0B;&#x6587;&#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x5904;&#x7406;&#x5668;&#xFF0C;&#x5E76;&#x5237;&#x65B0;&#xFF08;&#x627E;&#x51FA; Spring &#x5BB9;&#x5668;&#x4E2D;&#x5B9E;&#x73B0;&#x4E86; Lifecycle &#x63A5;&#x53E3;&#x7684; bean &#x5E76;&#x6267;&#x884C; <code>start()</code> &#x65B9;&#x6CD5;&#xFF09;&#x3002;</p>
<p>&#x53D1;&#x5E03; ContextRefreshedEvent &#x4E8B;&#x4EF6;&#x544A;&#x77E5;&#x5BF9;&#x5E94;&#x7684; ApplicationListener &#x8FDB;&#x884C;&#x54CD;&#x5E94;&#x7684;&#x64CD;&#x4F5C;</p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">finishRefresh</span><span class="hljs-params">()</span> </span>{
    <span class="hljs-comment">// Initialize lifecycle processor for this context.</span>
    <span class="hljs-comment">// 1.&#x4E3A;&#x6B64;&#x4E0A;&#x4E0B;&#x6587;&#x521D;&#x59CB;&#x5316;&#x751F;&#x547D;&#x5468;&#x671F;&#x5904;&#x7406;&#x5668;</span>
    initLifecycleProcessor();

    <span class="hljs-comment">// Propagate refresh to lifecycle processor first.</span>
    <span class="hljs-comment">// 2.&#x9996;&#x5148;&#x5C06;&#x5237;&#x65B0;&#x5B8C;&#x6BD5;&#x4E8B;&#x4EF6;&#x4F20;&#x64AD;&#x5230;&#x751F;&#x547D;&#x5468;&#x671F;&#x5904;&#x7406;&#x5668;&#xFF08;&#x89E6;&#x53D1;isAutoStartup&#x65B9;&#x6CD5;&#x8FD4;&#x56DE;true&#x7684;SmartLifecycle&#x7684;start&#x65B9;&#x6CD5;&#xFF09;</span>
    getLifecycleProcessor().onRefresh();

    <span class="hljs-comment">// Publish the final event.</span>
    <span class="hljs-comment">// 3.&#x63A8;&#x9001;&#x4E0A;&#x4E0B;&#x6587;&#x5237;&#x65B0;&#x5B8C;&#x6BD5;&#x4E8B;&#x4EF6;&#x5230;&#x76F8;&#x5E94;&#x7684;&#x76D1;&#x542C;&#x5668;</span>
    publishEvent(<span class="hljs-keyword">new</span> ContextRefreshedEvent(<span class="hljs-keyword">this</span>));

    <span class="hljs-comment">// Participate in LiveBeansView MBean, if active.</span>
    LiveBeansView.registerApplicationContext(<span class="hljs-keyword">this</span>);
}
</code></pre>
<p>&#x8FD9;&#x91CC;&#x5355;&#x72EC;&#x4ECB;&#x7ECD;&#x4E0B; publishEvent</p>
<pre><code class="lang-java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">publishEvent</span><span class="hljs-params">(ApplicationEvent event)</span> </span>{
    publishEvent(event, <span class="hljs-keyword">null</span>);
}

<span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">publishEvent</span><span class="hljs-params">(Object event, ResolvableType eventType)</span> </span>{
    Assert.notNull(event, <span class="hljs-string">&quot;Event must not be null&quot;</span>);
    <span class="hljs-keyword">if</span> (logger.isTraceEnabled()) {
        logger.trace(<span class="hljs-string">&quot;Publishing event in &quot;</span> + getDisplayName() + <span class="hljs-string">&quot;: &quot;</span> + event);
    }

    <span class="hljs-comment">// Decorate event as an ApplicationEvent if necessary</span>
    <span class="hljs-comment">// 1.&#x5982;&#x6709;&#x5FC5;&#x8981;&#xFF0C;&#x5C06;&#x4E8B;&#x4EF6;&#x88C5;&#x9970;&#x4E3A;ApplicationEvent</span>
    ApplicationEvent applicationEvent;
    <span class="hljs-keyword">if</span> (event <span class="hljs-keyword">instanceof</span> ApplicationEvent) {
        applicationEvent = (ApplicationEvent) event;
    } <span class="hljs-keyword">else</span> {
        applicationEvent = <span class="hljs-keyword">new</span> PayloadApplicationEvent&lt;Object&gt;(<span class="hljs-keyword">this</span>, event);
        <span class="hljs-keyword">if</span> (eventType == <span class="hljs-keyword">null</span>) {
            eventType = ((PayloadApplicationEvent) applicationEvent).getResolvableType();
        }
    }

    <span class="hljs-comment">// Multicast right now if possible - or lazily once the multicaster is initialized</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.earlyApplicationEvents != <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">this</span>.earlyApplicationEvents.add(applicationEvent);
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 2.&#x4F7F;&#x7528;&#x4E8B;&#x4EF6;&#x5E7F;&#x64AD;&#x5668;&#x5E7F;&#x64AD;&#x4E8B;&#x4EF6;&#x5230;&#x76F8;&#x5E94;&#x7684;&#x76D1;&#x542C;&#x5668;</span>
        getApplicationEventMulticaster().multicastEvent(applicationEvent, eventType);
    }

    <span class="hljs-comment">// Publish event via parent context as well...</span>
    <span class="hljs-comment">// 3.&#x540C;&#x6837;&#x7684;&#xFF0C;&#x901A;&#x8FC7;parent&#x53D1;&#x5E03;&#x4E8B;&#x4EF6;......</span>
    <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.parent != <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">if</span> (<span class="hljs-keyword">this</span>.parent <span class="hljs-keyword">instanceof</span> AbstractApplicationContext) {
            ((AbstractApplicationContext) <span class="hljs-keyword">this</span>.parent).publishEvent(event, eventType);
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">this</span>.parent.publishEvent(event);
        }
    }
}
</code></pre>
<p>&#x4F7F;&#x7528;&#x4E8B;&#x4EF6;&#x5E7F;&#x64AD;&#x5668;&#x5E7F;&#x64AD;&#x4E8B;&#x4EF6;&#x5230;&#x76F8;&#x5E94;&#x7684;&#x76D1;&#x542C;&#x5668; <strong>multicastEvent</strong></p>
<pre><code class="lang-java"><span class="hljs-meta">@Override</span>
<span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">multicastEvent</span><span class="hljs-params">(<span class="hljs-keyword">final</span> ApplicationEvent event, ResolvableType eventType)</span> </span>{
    ResolvableType type = (eventType != <span class="hljs-keyword">null</span> ? eventType : resolveDefaultEventType(event));
    <span class="hljs-comment">// 1.getApplicationListeners&#xFF1A;&#x8FD4;&#x56DE;&#x4E0E;&#x7ED9;&#x5B9A;&#x4E8B;&#x4EF6;&#x7C7B;&#x578B;&#x5339;&#x914D;&#x7684;&#x5E94;&#x7528;&#x76D1;&#x542C;&#x5668;&#x96C6;&#x5408;</span>
    <span class="hljs-keyword">for</span> (<span class="hljs-keyword">final</span> ApplicationListener&lt;?&gt; listener : getApplicationListeners(event, type)) {
        <span class="hljs-comment">// 2.&#x8FD4;&#x56DE;&#x6B64;&#x5E7F;&#x64AD;&#x5668;&#x7684;&#x5F53;&#x524D;&#x4EFB;&#x52A1;&#x6267;&#x884C;&#x7A0B;&#x5E8F;</span>
        Executor executor = getTaskExecutor();
        <span class="hljs-keyword">if</span> (executor != <span class="hljs-keyword">null</span>) {
            executor.execute(<span class="hljs-keyword">new</span> Runnable() {
                <span class="hljs-meta">@Override</span>
                <span class="hljs-function"><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title">run</span><span class="hljs-params">()</span> </span>{
                    <span class="hljs-comment">// 3.1 executor&#x4E0D;&#x4E3A;null&#xFF0C;&#x5219;&#x4F7F;&#x7528;executor&#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;</span>
                    invokeListener(listener, event);
                }
            });
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-comment">// 3.2 &#x5426;&#x5219;&#xFF0C;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;</span>
            invokeListener(listener, event);
        }
    }
}
</code></pre>
<p>&#x8C03;&#x7528;&#x76D1;&#x542C;&#x5668;<strong>invokeListener</strong></p>
<pre><code class="lang-java"><span class="hljs-function"><span class="hljs-keyword">protected</span> <span class="hljs-keyword">void</span> <span class="hljs-title">invokeListener</span><span class="hljs-params">(ApplicationListener&lt;?&gt; listener, ApplicationEvent event)</span> </span>{
    <span class="hljs-comment">// 1.&#x8FD4;&#x56DE;&#x6B64;&#x5E7F;&#x64AD;&#x5668;&#x7684;&#x5F53;&#x524D;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x7A0B;&#x5E8F;</span>
    ErrorHandler errorHandler = getErrorHandler();
    <span class="hljs-keyword">if</span> (errorHandler != <span class="hljs-keyword">null</span>) {
        <span class="hljs-keyword">try</span> {
            <span class="hljs-comment">// 2.1 &#x5982;&#x679C;errorHandler&#x4E0D;&#x4E3A;null&#xFF0C;&#x5219;&#x4F7F;&#x7528;&#x5E26;&#x9519;&#x8BEF;&#x5904;&#x7406;&#x7684;&#x65B9;&#x5F0F;&#x8C03;&#x7528;&#x7ED9;&#x5B9A;&#x7684;&#x76D1;&#x542C;&#x5668;</span>
            doInvokeListener(listener, event);
        } <span class="hljs-keyword">catch</span> (Throwable err) {
            errorHandler.handleError(err);
        }
    } <span class="hljs-keyword">else</span> {
        <span class="hljs-comment">// 2.2 &#x5426;&#x5219;&#xFF0C;&#x76F4;&#x63A5;&#x8C03;&#x7528;&#x8C03;&#x7528;&#x7ED9;&#x5B9A;&#x7684;&#x76D1;&#x542C;&#x5668;</span>
        doInvokeListener(listener, event);
    }
}

<span class="hljs-function"><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title">doInvokeListener</span><span class="hljs-params">(ApplicationListener listener, ApplicationEvent event)</span> </span>{
    <span class="hljs-keyword">try</span> {
        <span class="hljs-comment">// &#x89E6;&#x53D1;&#x76D1;&#x542C;&#x5668;&#x7684;onApplicationEvent&#x65B9;&#x6CD5;&#xFF0C;&#x53C2;&#x6570;&#x4E3A;&#x7ED9;&#x5B9A;&#x7684;&#x4E8B;&#x4EF6;</span>
        listener.onApplicationEvent(event);
    } <span class="hljs-keyword">catch</span> (ClassCastException ex) {
        String msg = ex.getMessage();
        <span class="hljs-keyword">if</span> (msg == <span class="hljs-keyword">null</span> || msg.startsWith(event.getClass().getName())) {
            <span class="hljs-comment">// Possibly a lambda-defined listener which we could not resolve the generic event type for</span>
            Log logger = LogFactory.getLog(getClass());
            <span class="hljs-keyword">if</span> (logger.isDebugEnabled()) {
                logger.debug(<span class="hljs-string">&quot;Non-matching event type for listener: &quot;</span> + listener, ex);
            }
        } <span class="hljs-keyword">else</span> {
            <span class="hljs-keyword">throw</span> ex;
        }
    }
}
</code></pre>
<p>&#x8FD9;&#x6837;&#xFF0C;&#x5F53; Spring &#x6267;&#x884C;&#x5230; finishRefresh &#x65B9;&#x6CD5;&#x65F6;&#xFF0C;&#x5C31;&#x4F1A;&#x5C06; ContextRefreshedEvent &#x4E8B;&#x4EF6;&#x63A8;&#x9001;&#x5230; MyRefreshedListener &#x4E2D;&#x3002;</p>
<p>&#x8DDF; ContextRefreshedEvent &#x76F8;&#x4F3C;&#x7684;&#x8FD8;&#x6709;&#xFF1A;ContextStartedEvent&#x3001;ContextClosedEvent&#x3001;ContextStoppedEvent&#xFF0C;&#x6709;&#x5174;&#x8DA3;&#x7684;&#x53EF;&#x4EE5;&#x81EA;&#x5DF1;&#x770B;&#x770B;&#x8FD9;&#x51E0;&#x4E2A;&#x4E8B;&#x4EF6;&#x7684;&#x4F7F;&#x7528;&#x573A;&#x666F;&#x3002;</p>
<p>&#x5F53;&#x7136;&#xFF0C;&#x6211;&#x4EEC;&#x4E5F;&#x53EF;&#x4EE5;&#x81EA;&#x5B9A;&#x4E49;&#x76D1;&#x542C;&#x4E8B;&#x4EF6;&#xFF0C;&#x53EA;&#x9700;&#x8981;&#x7EE7;&#x627F; ApplicationContextEvent &#x62BD;&#x8C61;&#x7C7B;&#x5373;&#x53EF;&#x3002;</p>
<h4 id="&#x95EE;&#x9898;"><a name="&#x95EE;&#x9898;" class="anchor-navigation-ex-anchor" href="#&#x95EE;&#x9898;"><i class="fa fa-link" aria-hidden="true"></i></a><a name="&#x95EE;&#x9898;" class="plugin-anchor" href="#&#x95EE;&#x9898;"><i class="fa fa-link" aria-hidden="true"></i></a>&#x95EE;&#x9898;</h4>
<p>1.BeanFactory &#x548C; FactoryBean &#x7684;&#x533A;&#x522B;&#xFF1F;</p>
<p>2.&#x8BF7;&#x4ECB;&#x7ECD; BeanFactoryPostProcessor &#x5728; Spring &#x4E2D;&#x7684;&#x7528;&#x9014;&#x3002;</p>
<p>3.SpringIoC &#x7684;&#x52A0;&#x8F7D;&#x8FC7;&#x7A0B;&#x3002;</p>
<p>4.Bean &#x7684;&#x751F;&#x547D;&#x5468;&#x671F;&#x3002;</p>
<p>5.Spring &#x4E2D;&#x6709;&#x54EA;&#x4E9B;&#x6269;&#x5C55;&#x63A5;&#x53E3;&#x53CA;&#x8C03;&#x7528;&#x65F6;&#x673A;&#x3002;</p>

                                
                                </section>
                            
    </div>
    <div class="search-results">
        <div class="has-results">
            
            <h1 class="search-results-title"><span class='search-results-count'></span> results matching "<span class='search-query'></span>"</h1>
            <ul class="search-results-list"></ul>
            
        </div>
        <div class="no-results">
            
            <h1 class="search-results-title">No results matching "<span class='search-query'></span>"</h1>
            
        </div>
    </div>
</div>

                        </div>
                    </div>
                
            </div>

            
                
                <a href="01-Spring-Code-Compile.html" class="navigation navigation-prev " aria-label="Previous page: 1 Spring源码介绍和编译">
                    <i class="fa fa-angle-left"></i>
                </a>
                
                
                <a href="03-Spring-Resolve-Circular-Dependencies.html" class="navigation navigation-next " aria-label="Next page: 3 Spring如何解决循环依赖">
                    <i class="fa fa-angle-right"></i>
                </a>
                
            
        
    </div>

    <script>
        var gitbook = gitbook || [];
        gitbook.push(function() {
            gitbook.page.hasChanged({"page":{"title":"2 Spring Ioc容器加载过程—Bean的生命周期源码深度剖析","level":"1.1.5.2","depth":3,"next":{"title":"3 Spring如何解决循环依赖","level":"1.1.5.3","depth":3,"path":"05-Source/03-Spring-Resolve-Circular-Dependencies.md","ref":"05-Source/03-Spring-Resolve-Circular-Dependencies.md","articles":[]},"previous":{"title":"1 Spring源码介绍和编译","level":"1.1.5.1","depth":3,"path":"05-Source/01-Spring-Code-Compile.md","ref":"05-Source/01-Spring-Code-Compile.md","articles":[]},"dir":"ltr"},"config":{"plugins":["-sharing","splitter","expandable-chapters-small","anchors","github","github-buttons","sharing-plus","anchor-navigation-ex"],"styles":{"website":"./styles/website.css"},"pluginsConfig":{"github":{"url":"https://github.com/tyrival"},"splitter":{},"search":{},"sharing-plus":{"qq":false,"all":["facebook","google","twitter","instapaper","linkedin","pocket","stumbleupon"],"douban":false,"facebook":true,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":true,"messenger":false,"line":false,"vk":false,"pocket":true,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"lunr":{"maxIndexSize":1000000,"ignoreSpecialCharacters":false},"fontsettings":{"theme":"white","family":"sans","size":2},"highlight":{},"anchor-navigation-ex":{"associatedWithSummary":true,"float":{"floatIcon":"fa fa-navicon","level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"mode":"float","multipleH1":true,"pageTop":{"level1Icon":"","level2Icon":"","level3Icon":"","showLevelIcon":false},"printLog":false,"showGoTop":true,"showLevel":false},"github-buttons":{"buttons":[{"user":"Tyrival","repo":"gitbook","type":"star","size":"small","count":false}]},"expandable-chapters-small":{},"sharing":{"qq":false,"all":["google","facebook","weibo","twitter","qq","qzone","linkedin","pocket"],"douban":false,"facebook":false,"weibo":false,"instapaper":false,"whatsapp":false,"hatenaBookmark":false,"twitter":false,"messenger":false,"line":false,"vk":false,"pocket":false,"google":false,"viber":false,"stumbleupon":false,"qzone":false,"linkedin":false},"theme-default":{"styles":{"website":"styles/website.css","pdf":"styles/pdf.css","epub":"styles/epub.css","mobi":"styles/mobi.css","ebook":"styles/ebook.css","print":"styles/print.css"},"showLevel":false},"anchors":{}},"theme":"default","author":"Tyrival","pdf":{"pageNumbers":true,"fontSize":12,"fontFamily":"Arial","paperSize":"a4","chapterMark":"pagebreak","pageBreaksBefore":"/","margin":{"right":62,"left":62,"top":56,"bottom":56}},"structure":{"langs":"LANGS.md","readme":"README.md","glossary":"GLOSSARY.md","summary":"SUMMARY.md"},"variables":{},"title":"架构师学习笔记","language":"zh-hans","gitbook":"3.2.3","description":"架构师学习笔记"},"file":{"path":"05-Source/02-Spring-IoC.md","mtime":"2020-09-20T13:30:33.026Z","type":"markdown"},"gitbook":{"version":"3.2.3","time":"2020-10-15T02:05:05.109Z"},"basePath":"..","book":{"language":""}});
        });
    </script>
</div>

        
    <script src="../gitbook/gitbook.js"></script>
    <script src="../gitbook/theme.js"></script>
    
        
        <script src="../gitbook/gitbook-plugin-splitter/splitter.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-expandable-chapters-small/expandable-chapters-small.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-github-buttons/plugin.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-sharing-plus/buttons.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search-engine.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-search/search.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/lunr.min.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-lunr/search-lunr.js"></script>
        
    
        
        <script src="../gitbook/gitbook-plugin-fontsettings/fontsettings.js"></script>
        
    

    </body>
</html>

